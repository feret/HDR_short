\newcommand{\steppopgraph}{}
\newcommand{\statepopgraph}{}
\newcommand{\fwdflowpop}{}
\newcommand{\bwdflowpop}{}
\newcommand{\activitygraphpop}{}
\newcommand{\fwdflowpopbis}{}
\newcommand{\rlongiso}{}
\newcommand{\flowpop}{}
\newcommand{\inclusion}{}
\newcommand{\labelindivgraph}{}
\newcommand{\slightequiv}{a}
\newcommand{\allocgraph}{}
\newcommand{\allocgraphshort}{}
\newcommand{\equivmodel}{}
%\newcommand{\conc}[1]{[#1]}
\newcommand{\pone}{\agentfont{A}}
\newcommand{\ptwo}[2]{\agentfont{A}.\sitefont{#1}-\sitefont{#2}.\agentfont{A}}
\newcommand{\pxx}{\ptwo{x}{x}}
\newcommand{\pxy}{\ptwo{x}{y}}
\newcommand{\pyy}{\ptwo{y}{y}}

\newcommand{\actionmap}{}
\newcommand{\stateindivgraph}{}
\newcommand{\activitygraphindiv}{}
\newcommand{\fwdflowindiv}{}
\newcommand{\bwdflowindiv}{}
\newcommand{\labelpopgraph}{}
\newcommand{\flowindiv}{}
\newcommand{\isoL}{}
\newcommand{\isoR}{}
\newcommand{\bothsite}{}
\newcommand{\symsymbol}{}
\newcommand{\graphsymb}{}
\newcommand{\ext}{}
\newcommand{\emptylist}{}
\newcommand{\stepindivgraph}{}
\newcommand{\dummy}{{}}
\newcommand{\st}{tel que}\newcommand{\sitename}{}
\newcommand{\statename}{}
\newcommand{\statesite}{}
\newcommand{\linksite}{}
\newcommand{\graphtuple}{}
\newcommand{\sites}{}
\newcommand{\links}{}
\newcommand{\props}{}
\newcommand{\groupequiv}{}
\newcommand{\im}{}
\newcommand{\identity}{}
\newcommand{\lonweakembedding}{}
\newcommand{\rlongweakembedding}{}
\newcommand{\actioncomposeweakemblong}{}
\newcommand{\csize}{1cm}
\newcommand{\rsize}{1cm}
\newcommand{\incbox}[3]{\begin{minipage}{#2}\includegraphics[width=#2,height=#1]{#3}\end{minipage}}
%\newcommand{\myfrac}[2]{\frac{\strut #1}{\strut #2}}
\newcommand{\smallfrac}[2]{\frac{\scriptstyle #1}{\scriptstyle #2}}
\renewcommand{\incbox}[3]{\scalebox{\scalefactor}{\includegraphics{#3}}}
\newcommand{\scaleladot}{1}
\newcommand{\probsymb}{P}
\newcommand{\funstyle}[1]{\mathrm{#1}}
\newcommand{\activity}[1]{\funstyle{a}(#1)}
\newcommand{\llongembedding}{}
\newcommand{\rlongembedding}{}
\newcommand{\lvlongembedding}{}
\newcommand{\rvlongembedding}{}
\newcommand{\lvvlongembedding}{}
\newcommand{\rvvlongembedding}{}
\newcommand{\lvvvlongembedding}{}
\newcommand{\rvvvlongembedding}{}
\newcommand{\llongweakembedding}{}
\newcommand{\lvlongweakembedding}{}
\newcommand{\actionpartialemblong}{}
\newcommand{\actionpartialembactionlong}{}
\newcommand{\rvlongweakembedding}{}
\newcommand{\lvvlongweakembedding}{}
\newcommand{\rvvlongweakembedding}{}
\newcommand{\symrules}{}
\newcommand{\pullbackcorner}{}
\newcommand{\eg}{e.g.~}
\newcommand{\ie}{i.e.~}
\newcommand{\notgroupequiv}{}
\newcommand{\suchthat}{tel que}
\newcommand{\uminus}{ - }
\newcommand{\kapparule}[1]{\xrightarrow{#1}}
\newcommand{\bikapparule}[2]{\xleftrightarrow[#2]{#1}}
\newcommand{\iso}{iso}
\newcommand{\riso}{iso}
\newcommand{\dom}{}
\newcommand{\permut}[1][]{\xymatrix@C=0.6cm{{}&\ar@2@/_/@{~>}^{#1}[rr]&&{}}}
\newcommand{\permutbis}[1][]{\xymatrix@C=0.6cm{{}&\ar@2@/^/@{~>}^{#1}[rr]&&{}}}

\newcommand{\squarespembedding}[9]{%
\begin{equation*}%
\xymatrix@C=\csize@R=\rsize{%
#3 \ar@{^{(}->}|{#1}^{#8}[r] & #5 \\%
#2  \ar@{^{(}->}|{#1}^{#6}[u]\ar@{^{(}->}|{#1}_{#7}[r] & #4\ar@{^{(}->}|{#1}_{#9}[u]}%
\end{equation*}}

\newcommand{\squareweakembedding}[8]{\squarespembedding{w}{#1}{#2}{#3}{#4}{#5}{#6}{#7}{#8}}

\newcommand{\imagesquareweakembedding}[9]{%
\squareweakembedding%
{\actiongraphlong{(\actionembactionlong{#1}{(#8#6)})}{#2}}%
{\actiongraphlong{(\actionembactionlong{#1}{#8})}{#3}}%
{\actiongraphlong{(\actionembactionlong{#1}{#9})}{#4}}%
{\actiongraphlong{#1}{#5}}%
{\actionembemblong{(\actionembactionlong{#1}{#8})}{#6}}%
{\actionembemblong{(\actionembactionlong{#1}{#9})}{#7}}%
{\actionembemblong{#1}{#8}}%
{\actionembemblong{#1}{#9}}}

\chapter{Symétrie dans les graphes à sites}
\label{chp:sym}

Les symétries apparaîssent dans les modèles décrits par des règles de réécritures sous des formes diverses.
Certaines sont indissociables de la sémantique. C'est le cas des automorphismes qui représentent des équivalences entre agents au sein de graphes à sites. D'autres peuvent être considérer pour décrire des équivalences entre sites d'interaction, des équivalences entre sortes de protéines ou encore des équivalences spatiales qui permettent de voir  la structure de certains complexes biochimiques modulo
des isométries.

Dans \cite{feret:sasb2014}, nous avons introduit un cadre de travail algébrique unifiant pour décrire, inférer, et utiliser les des groupes de transformations de graphes à sites dans le langage Kappa. L'idée principale est de considérer des groupes de transformations qui agissent sur les graphes à sites avec une opération supplémentaire permettant de restreindre une transformation sur les sous-graphes d'un graphe. Il est alors possible de définir quand un ensemble de règle est symétrique par rapport à ces groupes de transformation et d'en déduire  des propriétés au niveau du comportement global du modèle, que ce soit pour sa sémantique stochastique ou différentielle. Pour simplifier la présentation, nous nous concentrons ici aux symétries qui correspondent à  des permutations de sites, qui sont décrites dans \cite{Feret-MFPSXXVI}.


\paragraph{Travaux voisins.} Plusieurs formalismes permettent de faire apparaître chaque site plusieurs fois dans l'interface des agents.
C'est le cas du langage BNGL \cite{DBLP:journals/bioinformatics/BlinovFGH04}.
Dans le langage ReactC \cite{DBLP:conf/esop/JohnLNV11}, des sites indistinguable peuvent être encodés à l'aide d'hyperliens. Ceci procure un moyen syntaxique  de décrire des sites symétriques.
En contre-partie, le calcul des l'ensembles des occurrences des motifs de réécriture devient prohibitif (les graphes ne sont plus rigides), ce qui pose de grands problèmes de complexité pour échantilloner les trajectoires de la sémantique stochastique.

En Kappa, la rigidité des graphes est un principe fondamental, et donc, l'utilisation de plusieurs instances d'un même site dans l'interface d'un agent est interdite. Les équivalences entre sites d'interaction peuvent toutefois être décrites à un plus haut-niveau de spécification  \cite{DBLP:journals/corr/abs-0911-2508} puis traduites automatiquement dans le noyau pure de Kappa. Cependant, il faut être conscient que cette traduction peut générer un très grand nombre de règles, là où une seule règle aurait été suffisante en utilisant des sites à occurrences multiples.

Dans ce chapitre, nous proposons une approche pour détecter automatiquement des équivalences entre sites d'intéraction qui n'ont pas besoin d'être spécifiées à la main.
Puis, nous utilisons ces équivalences pour réduire l'espace d'état ou le nombre d'espèces biochimiques des modèles considérés. Ceci permet de réduire la dimension
des systèmes diferentiels sous-jacents et facilite le calcul de propriétés sur la distribution des traces de la sémantique stochastique. Ce n'est en revanche pas crucial pour l'échantillonage des traces de la sémantique stochastique, puisque la simulation  travaille directement au niveau des graphes à sites \cite{DanosEtAl-APLAS07}.

Enfin, notre cadre de travail n'est pas limité à la prise en compte des équivalences entre sites d'interaction. Il peut être utilisé pour considérer des chaînes d'agents indépendamment de leur orientation ou des sous-groupes de permutations de sites comme c'est courant en chemoinformatique.


\section*{Remerciements.}

Ce chapitre reprends donc les principaux résultats qui avaient été établis avec Ferdinanda Camporesi \cite{Feret-MFPSXXVI} à propos
de la détection et de la prise en compte d'équivalences entre sites d'interaction dans un noyau sans effets de bord du langage Kappa, pour réduire la combinatoire de ses modèles. L'extension à des groupes de symétries arbitraires et au langage complet qui est introduite dans \cite{feret:sasb2014} n'est évoquée qu'en conclusion de ce chapitre.

\section{Introduction}

\newcommand{\dt}{\textrm{d} t}
\newcommand{\stateq}[1]{q_{{}_{#1}}}
\newcommand{\qone}[1][]{#1{\stateq{6,0,0,0}}}
\newcommand{\qtwo}[1][]{#1{\stateq{4,1,0,0}}}
\newcommand{\qthree}[1][]{#1{\stateq{4,0,1,0}}}
\newcommand{\qfour}[1][]{#1{\stateq{4,0,0,1}}}
\newcommand{\qfive}[1][]{#1{\stateq{2,2,0,0}}}
\newcommand{\qsix}[1][]{#1{\stateq{2,0,2,0}}}
\newcommand{\qseven}[1][]{#1{\stateq{2,0,0,2}}}
\newcommand{\qeight}[1][]{#1{\stateq{2,1,1,0}}}
\newcommand{\qten}[1][]{#1{\stateq{2,1,0,1}}}
\newcommand{\qnine}[1][]{#1{\stateq{2,0,1,1}}}
\newcommand{\qeleven}[1][]{#1{\stateq{0,3,0,0}}}
\newcommand{\qtwelve}[1][]{#1{\stateq{0,0,3,0}}}
\newcommand{\qthirteen}[1][]{#1{\stateq{0,0,0,3}}}
\newcommand{\qfourteen}[1][]{#1{\stateq{0,2,1,0}}}
\newcommand{\qfifteen}[1][]{#1{\stateq{0,2,0,1}}}
\newcommand{\qsixteen}[1][]{#1{\stateq{0,1,2,0}}}
\newcommand{\qtwenty}[1][]{#1{\stateq{0,1,1,1}}}
\newcommand{\qnineteen}[1][]{#1{\stateq{0,1,0,2}}}
\newcommand{\qseventeen}[1][]{#1{\stateq{0,0,2,1}}}
\newcommand{\qeighteen}[1][]{#1{\stateq{0,0,1,2}}}
\newcommand{\fifteen}[1]{\myfrac{30#1}{2}}
\newcommand{\one}[1]{\myfrac{2#1}{2}}
\newcommand{\two}[1]{\myfrac{4#1}{2}}
\newcommand{\three}[1]{\myfrac{6#1}{2}}
\newcommand{\six}[1]{\myfrac{12#1}{2}}
\newcommand{\probstate}[2][\!]{\probsymb_t{#1}\left(#2\right)\!}
\newcommand{\probinitstate}[2][\!]{\probsymb_0{#1}\left(#2\right)\!}
\newcommand{\diffprobstate}[1]{\myfrac{\textrm{d} \probstate[]{#1}}{\dt}}
\newcommand{\diffconc}[1]{\myfrac{\textrm{d} \conc{#1}}{\dt}}
\newcommand{\stateQ}[1]{Q_{#1}}
\newcommand{\Qzero}[1][]{#1{\stateQ{6,0}}}
\newcommand{\Qone}[1][]{#1{\stateQ{4,1}}}
\newcommand{\Qtwo}[1][]{#1{\stateQ{2,2}}}
\newcommand{\Qthree}[1][]{#1{\stateQ{0,3}}}
\newcommand{\Qgen}[1][]{#1{\stateQ{i,j}}}

\newcommand{\mono}{A_1}
\newcommand{\dimer}{A_2}

Nous illustrons l'usage des symétries dans Kappa à travers un exemple jouet.

\subsection{Un modèle avec des sites équivalents}

\label{sec:modele}

Pour simplifier la présentation, nous considérons une forme très simple de symétrie, celle où des sites d'une protéine ont  exactement les mêmes capacités d'interaction.

Soit une sorte de protéine,  \agent{A}{}, chaque occurrence de la protéine \agent{A}{} disposant d'exactement deux sites de liaison que nous noterons  \site{x}{}{} et  \site{y}{}{}. Les sites de deux occurrences différentes de la protéine \agent{A}{} peuvent se lier arbitrairement de mani!re réversible. Il y a donc trois types de liaison, \site{x}{}{}-\site{x}{}{}, \site{x}{}{}-\site{y}{}{}, et \site{y}{}{}-\site{y}{}{}, selon les sites qui sont impliqués dans la liaison.
De plus, il est supposé que chaque occurrence de protéine ne peut être qu'une fois à la fois.

\begin{figure*}[t]
\hfill\subfigure[Une occurrence de la protéine \agentfont{A} avec ses deux sites de liaison libres.]%
{\label{fig:sgsym21}
\begin{minipage}{0.2\linewidth}\hfill\scalebox{\scalefactor}{\includegraphics{generated_pictures/sym_4_1_a.pdf}}\hfill\mbox{}\end{minipage}}%
\hfill\subfigure[Deux occurrences de la protéine \agentfont{A} liées par leurs deux sites \sitefont{x}.]%
{\label{fig:sgsym22}
\begin{minipage}{0.2\linewidth}\hfill\scalebox{\scalefactor}{\includegraphics{generated_pictures/sym_4_1_b.pdf}}\hfill\mbox{}\end{minipage}}%
\hfill\subfigure[Deux occurrences de la protéine \agentfont{A} liées par leurs deux sites \sitefont{y}.]%
{\label{fig:sgsym23}
\begin{minipage}{0.2\linewidth}\hfill\scalebox{\scalefactor}{\includegraphics{generated_pictures/sym_4_1_c.pdf}}\hfill\mbox{}\end{minipage}}%
\hfill\subfigure[Deux occurrences de la protéine \agentfont{A} liées respectivement par le site \sitefont{x} de l'une et le site \sitefont{y}{} de l'autre.]%
{\label{fig:sgsym24}
\begin{minipage}{0.2\linewidth}\hfill\scalebox{\scalefactor}{\includegraphics{generated_pictures/sym_4_1_d.pdf}}\hfill\mbox{}\end{minipage}}\caption{The four kinds of molecular species in the initial model.}
\label{fig:chemicalspecies}
\end{figure*}

\begin{figure*}[t]%
\hfill\subfigure[règles de liaison/déliaison entre les sites \sitefont{x} de deux occurrences de la protéine \agentfont{A} dont le site \sitefont{y} est libre.]%
{\begin{minipage}{0.6\linewidth}\label{fig:rulesym21}\hfill\incgraphics[\linewidth]{generated_pictures/sym_4_2_a.pdf}\hfill\mbox{}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[règles de liaison/déliaison entre les sites \sitefont{y} de deux occurrences de la protéine \agentfont{A} dont le site \sitefont{x} est libre.]%
{\begin{minipage}{0.6\linewidth}\label{fig:rulesym22}\hfill\incgraphics[\linewidth]{generated_pictures/sym_4_2_b.pdf}\hfill\mbox{}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[règles de liaison déliaison entre le site \sitefont{x} d'une occurrence de la protéine \agentfont{A} et le site \sitefont{y} d'une autre occurrence de la protéine \agentfont{A}, sous la condition que le site \sitefont{y} de la première occurrence de protéine et le site \sitefont{x} de la seconde soient tous les deux libres.]%
{\begin{minipage}{0.6\linewidth}\label{fig:rulesym23}\hfill\incgraphics[\linewidth]{generated_pictures/sym_4_2_c.pdf}\hfill\mbox{}\end{minipage}}\hfill\mbox{}
\caption{Les six règles de réécriture du modèle initial.}
\label{fig:threerules}
\end{figure*}

Sous ces hypothèses, il existe exactement quatre sortes de complexe biochimique\footnote{voir page \pageref{defn:molecular species} pour la définition d'un complexe biochimique.}. Celles-ci sont toutes les quatre dessinées en Fig.~\ref{fig:chemicalspecies}.
Une occurrence de complexe biochimique est ainsi formé soit d'une occurrence de protéine avec ses deux sites libres (voir en Fig.~\ref{fig:sgsym21}), soit deux occurrences de la protéine \agent{A}{} sont liées  par leurs deux sites \site{x}{}{} (voir en  Fig.~\ref{fig:sgsym22}), par leurs deux sites \site{y}{}{} (voir en Fig.~\ref{fig:sgsym23} ou par le site \site{x}{}{} de l'une et le site \site{y}{}{} de l'autre (voir en Fig.~\ref{fig:sgsym24}).


\begin{sidewaysfigure}\scalebox{0.90}{\begin{minipage}{\linewidth}
\begin{equation*}
\begin{cases}
\diffprobstate{\qone}= \one{\kdxx}\probstate{\qtwo}
                      + \one{\kdyy}\probstate{\qthree}
                      + \kdxy{\cdot}\probstate{\qfour}
                      - \fifteen{(\kxx+\kyy+\kxy)}\probstate{\qone} \cr
\diffprobstate{\qtwo}= \fifteen{\kxx}\probstate{\qone}
                      + \two{\kdxx}\probstate{\qfive}
                      + \one{\kdyy}\probstate{\qeight}
                      + \kdxy{\cdot}\probstate{\qten}
                      - \myfrac{12(\kxx+\kyy+\kxy)+2\kdxx}{2}\probstate{\qtwo}\cr
\diffprobstate{\qthree}= \fifteen{\kyy}\probstate{\qone}
                       + \one{\kdxx}\probstate{\qeight}
                       + \two{\kdyy}\probstate{\qsix}
                       + \kdxy{\cdot}\probstate{\qnine}
                       - \myfrac{12(\kxx+\kyy+\kxy)+2\kdyy}{2}\probstate{\qthree}\cr
\diffprobstate{\qfour}= \fifteen{\kxy}\probstate{\qone}
                       + \one{\kdxx}\probstate{\qten}
                       + \one{\kdyy}\probstate{\qnine}
                       + 2\kdxy{\cdot}\probstate{\qseven}
                       - \left(\six{(\kxx+\kyy+\kxy)}+\kdxy\right)\!\probstate{\qfour}\cr
\diffprobstate{\qfive}= \six{\kxx}\probstate{\qtwo}
                      + \three{\kdxx}\probstate{\qeleven}
                      + \one{\kdyy}\probstate{\qfourteen}
                      + \kdxy{\cdot}\probstate{\qfifteen}
                      - \myfrac{2\kxx+2\kyy+2\kxy+4\kdxx}{2}\probstate{\qfive}\cr
\diffprobstate{\qeight}= \six{\kxx}\probstate{\qthree}
                       + \six{\kyy}\probstate{\qtwo}
                       + \two{\kdxx}\probstate{\qfourteen}
                       + \two{\kdyy}\probstate{\qsixteen}
                       + \kdxy{\cdot}\probstate{\qtwenty}
                       - \myfrac{2\kxx+2\kyy+2\kxy+2\kdxx+2\kdyy}{2}\probstate{\qeight}\cr
\diffprobstate{\qten}= \six{\kxx}\probstate{\qfour}
                     + \six{\kxy}\probstate{\qtwo}
                     + \two{\kdxx}\probstate{\qfifteen}
                     + \one{\kdyy}\probstate{\qtwenty}
                     + 2\kdxy{\cdot}\probstate{\qnineteen}
                     -\left(\frac{2\kxx+2\kyy+2\kxy+2\kdxx}{2}+\kdxy\right)\!\probstate{\qten}\cr
\diffprobstate{\qsix}= \six{\kyy}\probstate{\qthree}
                      + \one{\kdxx}\probstate{\qsixteen}
                      + \three{\kdyy}\probstate{\qtwelve}
                      + \kdxy{\cdot}\probstate{\qseventeen}
                      - \myfrac{2\kxx+2\kyy+2\kxy+4\kdyy}{2}\probstate{\qsix}\cr
\diffprobstate{\qnine}= \six{\kyy}\probstate{\qfour}
                      + \six{\kxy}\probstate{\qthree}
                      + \two{\kdxx}\probstate{\qtwenty}
                      + \two{\kdyy}\probstate{\qseventeen}
                      + 2\kdxy{\cdot}\probstate{\qeighteen}
                       - \left(\frac{2\kxx+2\kyy+2\kxy+2\kdyy}{2}+\kdxy\right)\!\probstate{\qnine}\cr
\diffprobstate{\qseven}= \six{\kxy}\probstate{\qfour}
                       + \one{\kdxx}\probstate{\qnineteen}
                       + \one{\kdyy}\probstate{\qeighteen}
                       + 3{\kdxy}\cdot\probstate{\qthirteen}
                       - \left(\frac{2\kxx+2\kyy+2\kxy}{2}+2{\cdot}\kdxy\right)\!\probstate{\qseven}\cr
\diffprobstate{\qeleven}= \one{\kxx}\probstate{\qfive}
                        - \three{\kdxx}\probstate{\qeleven}\cr
\diffprobstate{\qfourteen}=\one{\kxx}\probstate{\qeight}
                          +\one{\kyy}\probstate{\qfive}
                          -\myfrac{4\kdxx+2\kdyy}{2}\probstate{\qfourteen}\cr
\diffprobstate{\qfifteen}=\one{\kxx}\probstate{\qten}
                         + \one{\kxy}\probstate{\qfive}
                         -\left(\two{\kdxx}+\kdxy\right)\!\probstate{\qfifteen}\cr
\diffprobstate{\qsixteen}=\one{\kxx}\probstate{\qsix}
                         +\one{\kyy}\probstate{\qeight}
                         -\myfrac{2\kdxx+4\kdyy}{2}\probstate{\qsixteen}\cr
\diffprobstate{\qtwenty}= \one{\kxx}\probstate{\qnine}
                        + \one{\kyy}\probstate{\qten}
                        + \one{\kxy}\probstate{\qeight}
                        - \left(\myfrac{2\kdxx+2\kdyy}{2}+\kdxy\right)\!\probstate{\qtwenty}\cr
\diffprobstate{\qnineteen}=\one{\kxx}\probstate{\qseven}
                          +\one{\kxy}\probstate{\qten}
                          -\left(\one{\kdxx}+2\kdxy\right)\!\probstate{\qnineteen}\cr
\diffprobstate{\qtwelve}= \one{\kyy}\probstate{\qsix}
                        - \three{\kdyy}\probstate{\qtwelve}\cr
\diffprobstate{\qseventeen}=\one{\kyy}\probstate{\qnine}
                           + \one{\kxy}\probstate{\qsix}
                           -\left(\two{\kdyy}+\kdxy\right)\!\probstate{\qseventeen}\cr
\diffprobstate{\qeighteen}=\one{\kyy}\probstate{\qseven}
                          +\one{\kxy}\probstate{\qnine}
                          -\left(\one{\kdyy}+2\kdxy\right)\!\probstate{\qeighteen}\cr
\diffprobstate{\qthirteen}= \one{\kxy}\probstate{\qseven}
                          - 3\kdxy{\cdot}\probstate{\qthirteen}\cr
\end{cases}
\end{equation*}\end{minipage}}
\caption{Équation maîtresse.}
\label{CME}
\end{sidewaysfigure}

Les règles de liaison et de déliaison entre les occurrences de la protéine \agent{A}{} sont décrites en Fig.~\ref{fig:threerules}.
La règle bidirectionnelle dessinée en  Fig.~\ref{fig:rulesym21} stipule que deux occurrences de la protéine \agent{A}{} dont tous les sites sont libres peuvent lier leurs sites \site{x}{} respectifs avec la constante de réaction $\kxx$ et qu'un tel lien peut se défaire avec la constante de réaction $\kdxx$.
La règle bidirectionnelle donnée en  Fig.~\ref{fig:rulesym22} précise que deux occurrences de la protéine \agent{A}{} dont tous les sites sont libres peuvent lier leurs sites \site{y}{} respectifs avec la constante de réaction $\kyy$ et qu'un tel lien peut se briser avec la constante de réaction $\kdyy$. Enfin, la règle bidirectionnelle dessinnée en Fig.~\ref{fig:rulesym23} spécifie que
deux occurences de la protéine \agent{A}{} dont tous les sites sont libres, peuvent se lier respectivement par le site \site{x}{}{} de l'une et le site \site{y}{}{} de l'autres avec la constante de réaction $\kxy$ et qu'un tel lien peut se casser avec la constante de réaction $\kdxy$.

\subsection{sémantique}

Ainsi, d'un point de vue qualitatif, les sites \site{x}{}{} et \site{y}{}{} des occurrences de la protéine \agent{A}{} ont exactement les mêmes capacités d'interaction. Nous allons étudié de manière empirique ce que cela implique au niveau de la sémantique du modèle, à la fois pour la sémantique stochastique et pour la sémantique différentielle.

\subsubsection{Équation maîtresse}

Pour regarder le comportement de la sémantique stochastique du modèle, nous proposons de nous concentrer sur la solution de son équation maîtresse \cite{1967} qui décrit pour chaque état potentiel du système sous-jacent l'évolution temporelle de la probabilité que le système soit dans cet état. Comme il y a quatre sortes de complexes biochimiques,  l'état discrêt du système peut être représenté par un vecteur de quatre entiers naturels, en notant $\state{i,j,k,l}$ l'état dans lequel il y a exactement $i$ occurrence(s) de la protéine \agent{A}{} sans sites liés (voir en Fig.~\ref{fig:sgsym21}),
$j$ paires d'occurrences de la protéine \agent{A}{} liées par leurs sites \site{x}{}{} respectifs (voir en Fig.~\ref{fig:sgsym22}), $k$ paires d'occurrences de la protéine \agent{A}{} liées par leurs sites \site{y}{}{} respectifs (voir en Fig.~\ref{fig:sgsym23}), et $l$ paires d'occurrences de la protéine \agent{A}{} liées l'une par son site \site{x}{}{} et l'autre par son site \site{y}{}{} (voir en Fig.~\ref{fig:sgsym24}). L'équation maîtresse nécessite une variable par état possible du système. Afin de faire tenir les équations sur une page, la système débutera avec la probabilité $1$ dans un état avec uniquement six occurrences de la protéine \agent{A}{} avec tous leurs sites libres. Aussi, seuls seront considérés les états $\state{i,j,k,l}$ pour lesquels $i+2\cdot(j+k+l) = 6$. Aussi, l'équation maîtresse admet vingt variables, en l'occurrence,  $\qone$, $\qtwo$, $\qthree$, $\qfour$, $\qfive$, $\qeight$, $\qten$, $\qsix$, $\qnine$, $\qseven$, $\qeleven$, $\qfourteen$, $\qfifteen$, $\qsixteen$, $\qtwenty$, $\qnineteen$, $\qtwelve$, $\qseventeen$, $\qeighteen$, et $\qthirteen$.


L'équation maîtresse de notre modèle jouet est donnée en Fig.~\ref{CME}, alors que l'évolution temporelle de la distribution de probabilité de chaque état accessible à partir de l'état initial est donné  en Fig.~\ref{distributionko} pour les paramètres cinétiques  $\kxx=\kxy=1$, $\kyy=\kdxx=\kdyy=2$, et $\kdxy=4$.

\begin{figure}[ht]
\begin{center}
\scalebox{0.55}{\input{generated_pictures/sym_KO_few}}
\end{center}
\caption{Évolution de la distribution de certains états en fonction du temps, avec les paramètres cinétiques
$\kxx=\kxy=1$, $\kyy=\kdxx=\kdyy=2$, et $\kdxy=4$, et la distribution d'états initiale $\probinitstate{\qone}=1$.}
\label{distributionko}%
\end{figure}

\subsubsection{Sémantique différentielle}

La sémantique différentielle du modèle est définie par le systèmes d'équations différentielles donné en Fig.~\ref{fig:sym:ODE}. Ces équations décrivent l'évolution de la concentration des différents complexes biochimique sous les hypothèses de la loi d'action de masse. Les trajectoires de ce système en prenant pour état initial, l'état où les monomères de la protéine \agent{A}{} ont pour concentration $6$ et les dimers ont pour concentration $0$ sont décrites en Fig.~\ref{sym:trajectoires}.

\begin{figure}[ht]
\begin{equation*}
\begin{cases}
\diffconc{\pone} =
2\kdxy\conc{\pxy}+4\myfrac{\kdyy}{2}2\conc{\pyy}+4\myfrac{\kdxx}{2}2\conc{\pxx} - (2\myfrac{\kyy}{2} + 2\myfrac{\kxx}{2} + 2\myfrac{\kxy}{2})\conc{\pone}\cr
\diffconc{\pxx} = \myfrac{\kxx}2\conc{\pone}^2 -2\myfrac{\kdxx}{2}2\conc{\pxx}\cr
\diffconc{\pyy} = \myfrac{\kxy}2\conc{\pone}^2-2\myfrac{\kdyy}{2}2\conc{\pyy}\cr
\diffconc{\pxy} = \myfrac{\kyy}2\conc{\pone}^2-\kdxy\pxy
\end{cases}
\end{equation*}
\caption{Système d'équations différentielles. La solution de ce système décrit l'évolution des concentrations des différents complexes biochimique en fonction du temps, sous les hypothèses de la loi d'Action de Masse.}
\label{fig:sym:ode}
\end{figure}
\begin{figure}[ht]
\begin{center}
\scalebox{0.55}{\input{generated_pictures/ode_KO}}
\end{center}
\caption{Évolution de la concentration des différents complexes biochimiques en fonction du temps, avec les paramètres cinétiques $\kxx=\kxy=1$, $\kyy=\kdxx=\kdyy=2$, et $\kdxy=4$, et l'état initiat $\conc{\pone}=6$ et $\conc{\pxx}=\conc{\pxy}=\conc{\pyy}=0$.
}
\label{sym:trajectoires}%
\end{figure}

\subsection{Symétries et propriétés comportementales}

Sans considérer les aspects quantitatifs, les sites \site{x}{}{} et \site{y}{}{} des occurrences de la protéine \agent{A}{} sont équivalents. Dès qu'une règle permet de lier le site \site{x}{}{} d'une occurence de la protéine \agent{A}{} à un site, une autre règle permet de lier le site \site{y}{}{} de cette occurence de protéine au même site. De même, quand une règle permet de casser un lien entre le site \site{x}{}{} d'une occurrence de protéine et un autre site, une autre règle permet de casser ce lien, si ce lien avait été porté par le site \site{y}{}{} ce cette occurence de protéines.

Il s'en suit la question suivante :
quelles conséquences les équivalences entre sites peuvent-elles impliquées en terme de comportement du système sous-jacent et pour quelles conditions supplémentaires sur les paramètres cinétiques du modèle et son état (ou sa distribution d'états) initial(e) ?


\subsubsection{Modèle simplifié}

Il semble naturel de vouloir oublier la différence entre des sites équivalents. Dans notre modèle jouet, cela revient à ignorer la différence entre les sites \site{x}{}{} et \site{y}{}{} dans les occurrences de la protéine \agent{A}{}.
\`A ce niveau d'abstraction, les occurrences de la protéine \agent{A}{} ont chacune deux sites, désormais supposés indistingables.


\paragraph{Complexes biochimiques.}

Comme dessiné en Fig.~\ref{fig:Achemicalspecies}, il ne reste alors que deux sortes de complexes biochimiques, les monomères qui sont formés d'une occurrence de la protéine \agent{A}{} avec ses deux sites de liaison libres et les dimères qui sont constitués de deux occurrences de la protéine \agent{A}{} liées exactement par une liaison entre un site de l'une et un site de l'autre.


\begin{figure}[t]
\hfill\subfigure[Une occurrence de la protéine \agentfont{A} avec ses deux sites libres.]%
{\begin{minipage}{0.47\linewidth}\label{sgsym21}\hfill\incgraphics[0.4\linewidth]{generated_pictures/sym_4_9_a.pdf}\hfill\mbox{}\end{minipage}}\hfill
\subfigure[Deux occurrences de la protéine \agentfont{A} liées entre elles. .]%
{\begin{minipage}{0.47\linewidth}\label{sgsym22}\hfill\incgraphics[0.4\linewidth]{generated_pictures/sym_4_9_b.pdf}\hfill\mbox{}\end{minipage}}\hfill\mbox{}
\caption{Les deux sortes de complexes biochimiques dans le modèle simplifié. Le nom des sites a été retiré car ils sont maintenant supposés indistinguables.}
\label{fig:Achemicalspecies}
\end{figure}


\begin{figure}[t]%
{\label{rulesym211}\hfill\incgraphics{generated_pictures/sym_4_11.pdf}\hfill\mbox{}}
\caption{La règle bidirectionnelle du modèle simplifié.
Deux occurrences de la protéine \agentfont{A} peuvent se lier à une constante de réaction $\K$ (peu importe à quels sites) quand tous leurs sites sont libres. De plus, ce lien peut se rompre avec une constante de réaction $\KD$.}
\label{Arule}
\end{figure}

\paragraph{États des systèmes stochastiques et différentiels sous-jacent}

Les états du système stochastique sous-jacent sont donc décrits par le nombre d'occurrences de monomère (qui sont formées d'une occurrence de la protéine \agent{A}{}) et le nombre d'occurrences de dimère (qui sont formées de deux occurrences de la protéine \agent{A}{} liées entre-elles). Un tel état sera noté $\Qgen$ avec $i$ le nombre d'occurrences de monomère et $j$ le nombre d'occurrences de dimère.

Quant à eux, les états du système differentiel sous-jacent sont décrits par deux concentrations. La concentration en monomère est notée $\conc{\mono}$ alors que celle en dimère est notée $\conc{\dimer}$.

\paragraph{règles simplifiées}

Par ailleurs, les règles se simplifient de la même manière.
Puisqu'il n'y a plus de distinctions entre les sites de liaison de chaque occurence de la protéine \agent{A}{}, les trois règles de liaison peuvent se résumer en une seule.
\'Etant donné deux occurrences de la protéine \agentfont{A} dont tous les sites sont libres, il y a trois règles pour créer un lien entre ces deux occurrences et chacune peut s'appliquer de deux manières différentes (selon le choix de quelle occurrence est utilisée pour la première occurrence de la protéine \agent{A}{} du membre grauche de la règle)
possibilité de créer un liaison pour une constante de réaction  corrigée totale $\smallfrac{2\kxx+2\kyy+2\kxy}{2}$. Du coup, pour simuler ces règles et rester fidèle à la cinétique, la constante de réaction corrigée de la nouvelle règle devra être égale elle aussi à $\smallfrac{2\kxx+2\kyy+2\kxy}{2}$. Par ailleurs, étant données deux occurrences de la protéine \agent{A}{}, une seule règle s'applique pour briser ce lien. Si le lien est entre deux sites \sitefont{x}{}{}, cette règle peut s'appliquer de deux manières pour une constante de réaction cumulée corrigée  de $\smallfrac{2\kdxx}{2}$.
Si le lien est entre deux sites \sitefont{y}{}{}, cette règle peut s'appliquer de deux manières pour une constante de réaction cumulée corrigée  de $\smallfrac{2\kdyy}{2}$. Enfin si le lien est entre un site \sitefont{x}{}{} et un site \sitefont{y}{}{}, la règle peut s'appliquer de deux manières pour une constante de réaction cumulée corrigée  de $\smallfrac{2\kdxy}{2}$. Du coup, la simplication n'est possible que si les trois constantes $\kdxx$, $\kdyy$ et $\kdxy$ sont égales. Dans ce cas, la constante de la règle de déliaison dans le modèle simplifié sera fixé à $\kdxx$.
Les deux règles du modèle simplifié sont données en Fig.~\ref{Arule}.

\paragraph{systèmes dynamiques sous-jacent}

L'équation maîtresse du modèle simplifié est donnée en Fig.~\ref{LCME}. La solution de ce système d'équations défini
donc l'évolution de la distribution de probabilités du nombre de dimers au cours du temps dans la sémantique stochastique.
Seuls les états accessibles à partir de six monomères ont été considérés, c'est à dire les états $\Qzero$, $\Qone$, $\Qtwo$ et $\Qthree$.

\begin{figure}[ht]
\scalebox{0.86}{\begin{minipage}{\linewidth}
\begin{equation*}
\begin{cases}
\diffprobstate{\Qzero} = \one{\KD}\probstate{\Qone}
                       - \fifteen{\K}\probstate{\Qzero}\cr
\diffprobstate{\Qone} = \fifteen{\K}\probstate{\Qzero}
                      + \two{\KD}\probstate{\Qtwo}
                      - (\six{\K}+\KD)\probstate{\Qone}\cr
\diffprobstate{\Qtwo} = \six{\K}\probstate{\Qone}
                      + \three{\KD}\probstate{\Qthree}
                      - (\one{\K} + \two{\KD})\probstate{\Qtwo}\cr
\diffprobstate{\Qthree} = \one{\K}\probstate{\Qtwo}
                      - \three{\KD}\probstate{\Qthree}\cr
\end{cases}
\end{equation*}\end{minipage}}
\caption{Chemical Master Equation of the reduced model.}
\label{LCME}
\end{figure}


La sémantique différentielle est quant à elle donnée en Fig.~\ref{LODE}. Elle donne l'évolution de la concentration en monomère, $\conc{\mono}$, et en dimère, $\conc{\dimer}$, au cours du temps, sous les hypothèses de la loi d'action de masse.

\begin{figure}[ht]
\scalebox{0.86}{\begin{minipage}{\linewidth}
\begin{equation*}
\begin{cases}
\diffconc{\mono}= 4\myfrac{\KD}{2}\conc{\dimer}-2\myfrac{\K}{2}\conc{\mono}^2\cr
\diffconc{\dimer} = \myfrac{\K}{2}\conc{\mono}^2 -
2\myfrac{\KD}{2}\conc{\dimer} \cr
\end{cases}
\end{equation*}\end{minipage}}
\caption{système différentiel pour le modèle simplifié.}
\label{LODE}
\end{figure}

\paragraph{Comparaison entre les deux modèles}

Les composants de modèle simplifié ont été définis de manière  intentionnelle sous la forme de graphe à sites.
Quelques écarts ont été pris par rapport à la syntaxe de Kappa. En effet, celle-ci ne permet pas de répéter des sites dans l'interface d'une protéine. Cette description intentionnelle permet des raisonnements intuitifs sur le comportement des composants du modèle simplifié. Toutefois, une caractérisation  extensionelle de ces composante est requise pour relier formellement les composants du modèle simplifié au composants du modèle initial et ainsi justifier rigoureusement ces raisonnements. Il suffit pour cela d'interpréter les complexes biochimiques et les états du modèle simplifié respectivement comme des classes d'équivalences de complexes biochimiques et d'états du modèle initial. Les complexes biochimiques sont regroupés en deux classes, les monomères et les dimères. Ainsi, dans le cadre différentiel, les variables du modèle simplifié correspondent à la somme des concentrations des espèce biochimiques dans chaque classe d'équivalences de complexes biochimiques, comme indiqué en Fig.~\ref{changevarode}.
De la même manière, les états du système stochastique initial peuvent être regroupés selon le nombre d'occurrences de monomère et de dimère. Du coup, à partir d'un état initial formé de $6$ occurrences de la protéine \agent{A}{} aves ses deux sites sont libres, il est possible d'attendre des états dans exactement $4$ classes d'équivalence, selon qu'il y ait $0$, $1$, $2$ ou $3$ dimères. Ceci peut être étendu aux distributions d'états qui apparaîssent dans l'équation maîtresse~: la probabilité d'avoir exactement $i$ monomères et $j$ dimères est alors vue comme la somme des probabilité des états du modèle initial ayant exactement $i$ monomères et $j$ dimères. Cette relation est exprimée en Fig.~\ref{changevarctmc} pour les états accessibles à partir de $6$ occurrences de la protéine \agent{A}{} avec les deux sites de liaison libres.

\begin{sidewaysfigure}\scalebox{0.90}{\begin{minipage}{\linewidth}
\begin{equation*}
\begin{cases}
\diffprobstate{\qone}= \one{\kdxx}\probstate{\qtwo}
                      + \one{\kdyy}\probstate{\qthree}
                      + \kdxy{\cdot}\probstate{\qfour}
                      - \fifteen{(\kxx+\kyy+\kxy)}\probstate{\qone} \cr
\diffprobstate{\qtwo}= \fifteen{\kxx}\probstate{\qone}
                      + \two{\kdxx}\probstate{\qfive}
                      + \one{\kdyy}\probstate{\qeight}
                      + \kdxy{\cdot}\probstate{\qten}
                      - \myfrac{12(\kxx+\kyy+\kxy)+2\kdxx}{2}\probstate{\qtwo}\cr
\diffprobstate{\qthree}= \fifteen{\kyy}\probstate{\qone}
                       + \one{\kdxx}\probstate{\qeight}
                       + \two{\kdyy}\probstate{\qsix}
                       + \kdxy{\cdot}\probstate{\qnine}
                       - \myfrac{12(\kxx+\kyy+\kxy)+2\kdyy}{2}\probstate{\qthree}\cr
\diffprobstate{\qfour}= \fifteen{\kxy}\probstate{\qone}
                       + \one{\kdxx}\probstate{\qten}
                       + \one{\kdyy}\probstate{\qnine}
                       + 2\kdxy{\cdot}\probstate{\qseven}
                       - \left(\six{(\kxx+\kyy+\kxy)}+\kdxy\right)\!\probstate{\qfour}\cr
\diffprobstate{\qfive}= \six{\kxx}\probstate{\qtwo}
                      + \three{\kdxx}\probstate{\qeleven}
                      + \one{\kdyy}\probstate{\qfourteen}
                      + \kdxy{\cdot}\probstate{\qfifteen}
                      - \myfrac{2\kxx+2\kyy+2\kxy+4\kdxx}{2}\probstate{\qfive}\cr
\diffprobstate{\qeight}= \six{\kxx}\probstate{\qthree}
                       + \six{\kyy}\probstate{\qtwo}
                       + \two{\kdxx}\probstate{\qfourteen}
                       + \two{\kdyy}\probstate{\qsixteen}
                       + \kdxy{\cdot}\probstate{\qtwenty}
                       - \myfrac{2\kxx+2\kyy+2\kxy+2\kdxx+2\kdyy}{2}\probstate{\qeight}\cr
\diffprobstate{\qten}= \six{\kxx}\probstate{\qfour}
                     + \six{\kxy}\probstate{\qtwo}
                     + \two{\kdxx}\probstate{\qfifteen}
                     + \one{\kdyy}\probstate{\qtwenty}
                     + 2\kdxy{\cdot}\probstate{\qnineteen}
                     -\left(\frac{2\kxx+2\kyy+2\kxy+2\kdxx}{2}+\kdxy\right)\!\probstate{\qten}\cr
\diffprobstate{\qsix}= \six{\kyy}\probstate{\qthree}
                      + \one{\kdxx}\probstate{\qsixteen}
                      + \three{\kdyy}\probstate{\qtwelve}
                      + \kdxy{\cdot}\probstate{\qseventeen}
                      - \myfrac{2\kxx+2\kyy+2\kxy+4\kdyy}{2}\probstate{\qsix}\cr
\diffprobstate{\qnine}= \six{\kyy}\probstate{\qfour}
                      + \six{\kxy}\probstate{\qthree}
                      + \two{\kdxx}\probstate{\qtwenty}
                      + \two{\kdyy}\probstate{\qseventeen}
                      + 2\kdxy{\cdot}\probstate{\qeighteen}
                       - \left(\frac{2\kxx+2\kyy+2\kxy+2\kdyy}{2}+\kdxy\right)\!\probstate{\qnine}\cr
\diffprobstate{\qseven}= \six{\kxy}\probstate{\qfour}
                       + \one{\kdxx}\probstate{\qnineteen}
                       + \one{\kdyy}\probstate{\qeighteen}
                       + 3{\kdxy}\cdot\probstate{\qthirteen}
                       - \left(\frac{2\kxx+2\kyy+2\kxy}{2}+2{\cdot}\kdxy\right)\!\probstate{\qseven}\cr
\diffprobstate{\qeleven}= \one{\kxx}\probstate{\qfive}
                        - \three{\kdxx}\probstate{\qeleven}\cr
\diffprobstate{\qfourteen}=\one{\kxx}\probstate{\qeight}
                          +\one{\kyy}\probstate{\qfive}
                          -\myfrac{4\kdxx+2\kdyy}{2}\probstate{\qfourteen}\cr
\diffprobstate{\qfifteen}=\one{\kxx}\probstate{\qten}
                         + \one{\kxy}\probstate{\qfive}
                         -\left(\two{\kdxx}+\kdxy\right)\!\probstate{\qfifteen}\cr
\diffprobstate{\qsixteen}=\one{\kxx}\probstate{\qsix}
                         +\one{\kyy}\probstate{\qeight}
                         -\myfrac{2\kdxx+4\kdyy}{2}\probstate{\qsixteen}\cr
\diffprobstate{\qtwenty}= \one{\kxx}\probstate{\qnine}
                        + \one{\kyy}\probstate{\qten}
                        + \one{\kxy}\probstate{\qeight}
                        - \left(\myfrac{2\kdxx+2\kdyy}{2}+\kdxy\right)\!\probstate{\qtwenty}\cr
\diffprobstate{\qnineteen}=\one{\kxx}\probstate{\qseven}
                          +\one{\kxy}\probstate{\qten}
                          -\left(\one{\kdxx}+2\kdxy\right)\!\probstate{\qnineteen}\cr
\diffprobstate{\qtwelve}= \one{\kyy}\probstate{\qsix}
                        - \three{\kdyy}\probstate{\qtwelve}\cr
\diffprobstate{\qseventeen}=\one{\kyy}\probstate{\qnine}
                           + \one{\kxy}\probstate{\qsix}
                           -\left(\two{\kdyy}+\kdxy\right)\!\probstate{\qseventeen}\cr
\diffprobstate{\qeighteen}=\one{\kyy}\probstate{\qseven}
                          +\one{\kxy}\probstate{\qnine}
                          -\left(\one{\kdyy}+2\kdxy\right)\!\probstate{\qeighteen}\cr
\diffprobstate{\qthirteen}= \one{\kxy}\probstate{\qseven}
                          - 3\kdxy{\cdot}\probstate{\qthirteen}\cr
\end{cases}
\end{equation*}\end{minipage}}
\caption{Équation maîtresse.}
\label{CME}
\end{sidewaysfigure}

\begin{figure}[t]
\begin{equation*}
\begin{cases}
\conc{\mono}=\conc{\pone},\cr
\conc{\dimer}=\conc{\pxx}+\conc{\pyy}+\conc{\pxy}.
\end{cases}
\end{equation*}
\caption{Définition extensionnelle des variables du modèle simplifié pour le cadre différentiel.}
\label{changevarode}
\end{figure}

\begin{figure}[t]
\begin{equation*}
\begin{cases}
\probstate{\Qzero}  =  \probstate{\qone} \cr
\probstate{\Qone}   =  \probstate{\qtwo} + \probstate{\qthree} + \probstate{\qfour} \cr
\probstate{\Qtwo}  =  \probstate{\qfive} + \probstate{\qeight} + \probstate{\qten}  + \probstate{\qsix} + \probstate{\qnine} + \probstate{\qseven}  \cr
\prob{\Qthree}  =  \probstate{\qeleven} + \probstate{\qfourteen} + \probstate{\qfifteen} + \probstate{\qsixteen} + \probstate{\qtwenty} + \probstate{\qnineteen}\cr
\hspace*{1.5cm}+ \probstate{\qtwelve} + \probstate{\qseventeen} + \probstate{\qthirteen} +\probstate{\qeighteen} + \probstate{\qnineteen}. \cr
\end{cases}
\end{equation*}
\caption{Définition extensionnelle des variables de l'équation maîtresse du modèle simplifié. }
\label{changevarctmc}
\end{figure}




Il existe donc deux manières de calculer le comportement du modèle simplifié~: soit en résolvant directement les équations
du modèle simplifié, soit en résolvant le modèle initial et en
calculant le comportement du modèle simplifié à l'aide de la caractérisation extensionnelle de ses composants. Cependant, ceci n'est possible que si les trois paramètres $\kdxx$, $\kdyy$ et $\kdxy$ sont égaux. Dans ce cas, le paramètre $\K$ doit être pris comme la somme des paramètres  $\kxx$, $\kyy$ et $\kxy$, alors que le paramètre $\KD$ doit être égal au paramètre $\kdxx$. De plus, la distribution du système initial, dans le cadre stochastique, ou l'état initial, dans le cadre différentiel, doivent être choisi pour satisfaire la caractérisation extensionnelle des composants du modèle simplifié.

En Fig.~\ref{fig:comparison} est montrée la comparaison empirique entre ces deux méthodes pour plusieurs jeux de paramètres, que ce soit dans la cadre stochastique ou différentiel.
La colonne de gauche est consacrée aux solutions des équations maîtresses, alors que la colonne de droite porte sur celles des équations aux concentrations. Quatre jeux de paramètres sont considérés.
même si les paramètres n'ont pas la même signification dans le cadre stochastique et dans celui différentiel, la comparaison est faîte avec les mêmes valeurs numériques. Dans chaque graphique,  les lignes continues sont obtenues en considérant le modèle initial et en projetant les résultats à l'aide de la caractérisation extensionnelle des composants du modèle simplifié alors que les courbes obtenues directement avec le modèle simplifié sont dessinées avec des tirets.

Le but de ces simulations numériques est de tester l'importance de trois contraintes. L'élaboration du modèle simplifié a mis en lumière qu'il était suffisant que que les constantes de dissociation $\kdxx$, $\kdxy$ et $\kdyy$ soient tous trois égaux. C'est la première contrainte qui sera considérée.
Par ailleurs, il semble légitime de se demander si des contraintes sur la distribution initiale (ou sur l'état initial dans le cadre différentiel) et sur les constantes d'association ont aussi des conséquences notables. Aussi l'importance que les sites \site{x}{}{} et \site{y}{}{} soient, ou non,
indistinguables dans la distribution initiale (ou l'état initial) sera également testé empiriquement et, par ailleurs, l'impact de la contrainte qui impose aux deux constantes $\kxx$ et $\kyy$ d'être égales et à la constante $\kxy$ d'être le double de leur valeur commune sera aussi testé (le choix des rapports sera expliquer plus tard).

\begin{enumerate}
\item Dans le premier jeu de paramètres, les trois contraintes sont satisfaites. Les constantes
$\kxx$ et $\kyy$ sont fixées à $1$, alors que les constantes
$\kxy$, $\kdxx$, $\kdyy$ et $\kdxy$ sont fixées à $2$.
Le système stochastique sous-jacent débute de l'état formé de $6$ occurrences de la protéine \agent{A}{} sans lien, et le système différentiel de l'état où les monomères sont présent en concentration $6$, et les dimères absents.
Les courbes montrent que la distribution des
états du modèle simplifié correspondent exactement (voir en Fig.~\ref{figctmcsym})~:  les mêmes valeurs sont obtenues en calculant l'évolution de la distribution des états dans le modèle initial et en regroupant les états selon le nombre d'occurrences de dimère (courbes continues) ou en calculant la distribution des états dans le modèle simplifié directement (tirets). Le même phénomène se retrouve dans les systèmes différentiels sous-jacents. Les courbes en Fig.~\ref{figodesym} montrent que les mêmes concentrations sont obtenues en regroupant  la concentration des dimères dans le modèle initial ou en calculant directement cette concentration dans le modèle simplifié.

\item Dans le second jeu de paramètres,
la contrainte sur les constantes de dissociation n'est plus satisfaite. Les constantes d'association et la distribution des états initiaux (ou l'état initial dans le cadre différentiel) sont gardées telles quelles, ainsi que les constantes de dissociation $\kdxx$ et $\kdyy$. Mais la constante de dissociation $\kdxy$ est maintenant fixée à $4$.
Dans le modèle simplifié, la constante de dissociation est prise comme étant égale à $3$ pour tenir compte de ce changement. On peut alors constater à la fois dans le cadre stochastique et dans le cadre différentiel un écart entre le comportement du modèle initial et du modèle simplifié (voir en Fig.~\ref{figctmcnonsymkd} et en Fig.~\ref{figodenonsymkd}).


\item Le troisième jeu de paramètres permet de tester l'importance éventuelle de l'état initial. Par rapport au premier jeu de paramètre, seule la distribution des états initiaux (ou l'état initial dans le cadre différentiel) est modifiée. Le système stochastique débute dans un état avec deux occurrences de la protéine \agent{A}{} sans lien, et deux occurrences du dimère chacun débute de deux occurrences de la protéine \agent{A}{} lié par leurs sites \site{x}{}{} respectifs. Quant au système différentiel, il démare d'un état où les monomères et les dimères $\sitefont{x}-\sitefont{x}$ sont en concentration $2$, alors que les deux autres formes de dimère sont en concentration $0$.  l'évolution des distributions d'états des deux systèmes stochastiques sous-jacents est dessinée en Fig.~\ref{figctmcnotsyminitial}, alors que l'évolution des concentrations en monomère et en dimère dans les deux systèmes différentiels sous-jacents est donnée en Fig.~\ref{figodenotsyminitial}. à la fois, le cadre stochastique et dans le cadre différentiel,
les courbes coÃ¯ncident entre le modèle initial et le modèle simplifié, ce qui nous conforte dans l'idée que la correction du modèle simplifié ne dépend pas de la distribution initiale (ou de l'état initial dans le cadre stochastique).

\item Enfin, le quatrième jeu de paramètres nous conforte dans l'idée que les constantes d'association n'ont pas d'importance pour prouver la correction du modèle simplifié. Les paramètres sont les mêmes que dans le premier jeu, sauf la constante $\kyy$ qui est fixée à $2$ et la constante $\kxy$ qui est fixée à $4$. De plus, la constante d'association dans le modèle simplifié, $\K$,  reste la somme des constantes d'association dans le modèle initial, c'est à dire $7$. Là encore, le comportement du modèle initial et celui du modèle simplifié coincident, que ce soit pour la sémantique stochastique ou la sémantique différentielle (voir en Fig.~\ref{figctmcnotsymasso} et en Fig.~\ref{figodenotsymasso}).
\end{enumerate}

\begin{figure*}[hp]
\hfill\subfigure[$\kxx=\kyy=1$,  $\kxy=\kdxx=\kdyy=\kdxy=2$ et $\probinitstate{\qone}=1$~; $\K=4$, $\KD=2$,
et $\probinitstate{\Qzero}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcsym}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.12.1}}}
\end{center}
\end{minipage}}
\hfill
\subfigure[$\kxx=\kyy=1$,  $\kxy=\kdxx=\kdyy=\kdxy=2$, initialement $\conc{\pone}=6$ et  $\conc{\pxx}=\conc{\pxy}=\conc{\pyy}=0$~; $\K=4$, $\KD=2$, initialement $\conc{\mono}=6$ et $\conc{\dimer}=0$.]
{\begin{minipage}{0.45\linewidth}
\label{figodesym}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.12.1}}}
\end{center}
\end{minipage}}\hfill\mbox{}


\hfill\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=2$,  $\kdxy=4$ et $\probinitstate{\qone}=1$~;
$\K=4$, $\KD=3$ et $\probinitstate{\Qzero}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnonsymkd}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.12.4}}}
\end{center}\end{minipage}}\hfill
\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=2$,  $\kdxy=4$,   initialement $\conc{\pone}=6$ sans dimère~; $\K=4$, $\KD=3$,  initialement $\conc{\mono}=6$ et $\conc{\dimer}=0$. ]%
{\begin{minipage}{0.45\linewidth}
\label{figodenonsymkd}
\begin{center}{\scalebox{0.45}{\input{generated_pictures/ode.4.12.4}}}
\end{center}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=\kdxy=2$,
$\probinitstate{\qfive}=1$~; $\K=4$, $\KD=2$, $\probinitstate{\Qtwo}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnotsyminitial}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.12.2}}}
\end{center}\end{minipage}}
\hfill
\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=\kdxy=2$,
initialement $\conc{\pone}=\conc{\pxx}=2$ et $\conc{\pyy}=\conc{\pxy}=0$~; $\K=4$, $\KD=2$, initialement
$\conc{\mono}=\conc{\dimer}=2$.]%
{\begin{minipage}{0.45\linewidth}
\label{figodenotsyminitial}\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.12.2}}}
\end{center}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[$\kxx=1$, $\kyy=2$, $\kxy=4$,  $\kdxx=\kdyy=\kdxy=2$ et $\probinitstate{\qone}=1$~;
$\K=7$, $\KD=2$ et $\probinitstate{\Qzero}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnotsymasso}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.12.3}}}
\end{center}\end{minipage}}
\hfill
\subfigure[$\kxx=1$, $\kyy=2$, $\kxy=4$,  $\kdxx=\kdyy=\kdxy=2$ initialement $\conc{\pone}=6$ sans dimère~;
$\K=7$, $\KD=2$, initialement $\conc{\mono}=6$ et $\conc{\dimer}=0$.]%
{\begin{minipage}{0.45\linewidth}
\label{figodenotsymasso}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.12.3}}}
\end{center}\end{minipage}}\hfill\mbox{}

\caption{Comparaison entre le comportement du modèle initial
(traits continus) et celui du modèle simplifié (tirets). à gauche, évolution de la distribution de probabilités du nombre de dimères pour différents paramètres cinétiques et différentes distributions d'états initiaux dans le système stochastique sous-jacent. à droite, évolution de la concentration en dimère  pour différents paramètres cinétiques et différentes concentrations initiales. }
\label{fig:comparison}
\end{figure*}

Ainsi, si l'égalité entre les constantes de dissociation
semble cruciale pour pouvoir simplifier le modèle de manière exacte, le choix de la distribution initiale (ou de l'état initial) et des constantes d'association semblent ne pas importer. Pour les constantes d'association, ceci s'explique par la simplicité du cas d'étude, puisque que les règles de liaison ne lient que des monomères et que ces monomères sont invariants par échange de leurs sites \site{x}{}{} et \site{y}{}{}. De manière général, les conditions sur les constantes cinétique portent sur des règles qui effectuent des actions similaires sur des motifs équivalents à permutation de sites près. La correction du modèle simplifiée peut alors s'expliquer par une bisimulation en-avant \cite{1347609} sur l'espace des états du système stochastique sous-jacent ou de son analogue différentiel \cite{Cardelli2015ForwardAB}.

\paragraph{Invariants quantitatifs}

Dans le paragraphe précédent, le fait que certains sites puissent partager exactement les mêmes capacités d'interaction a été exploité pour simplifier un modèle jouet de manière exacte. Les composés du modèle simplifié ont été reliés formellement à ceux du modèle initial et les mêmes résultats ont été obtenus, en exécutant le modèle initial avant d'utiliser ces relations formelles pour en déduire  l'évolution des composants du modèle simplifié ou en exécutant directement le modèle simplifié.

Une autre classe de propriétés intéressante est celle des invariants quantitatifs. Il semble naturel de supposer que lorsque deux sites sont équivalents dans toutes les occurrences d'une protéine, alors, dans le cadre stochastique, les états obtenus en permutant ces deux sites dans une ou plusieurs occurrences de cette protéine dans un état donné sont équiprobables.
De même, dans le cadre différentiel, la concentration des espèces biochimiques obtenues en permutant ces deux sites dans une ou plusieurs occurrences de cette protéine dans un complexe biochimique donné sont égales.

En fait, ces quantités ne sont pas égales en général. Des rapports de proportionnalité apparaîssent naturellement. Prenons l'exemple d'un jeu de "pile" ou "face".
Si deux tirages à "pile" ou "face" sont réalisés. Deux faces "piles" sont obtenues avec une probabilité un quart, deux faces "faces" avec une probabilité un quart, et  un face "pile" et une face "face" avec une probabilité un demi alors qu'il est possible d'intervertir dans un des tirages ou dans les deux tirages la face "pile" et la "face" sans changer la nature du jeu. Le rapport de proportionnalité entre les probabilités d'être dans une configuration et celui d'être dans une autre est en réalité égal au rapport entre le nombre de permutations de faces de pièces qui laisse ses deux configurations inchangées. Ainsi, la configuration une face "pile" et une face "face" n'est pas modifiée lorsque le rÃ´le des faces "pile" et "face" est échangé simultanément dans les deux tirages (c'est le seul changement non trivial qui laisse cette configuration inchangée), alors qu'un tirage double est changé pour tout changement non trivial, d'où un rapport de $2$ sur $1$ (en tenant compte de la permutation triviale).

Il semble légitime de se demander quelles conditions sont nécessaires pour retrouver de tels rapports de proportionnalité. Dans le cas d'étude,
ces conditions doivent assurer, dans le cadre stochastique, que les probabilités d'être dans deux états obtenus en remplaÃ§ant une occurrence d'un type de dimère par une occurrence d'un autre type restent dans le même rapport de proportionnalité  au cours du temps. Dans le cadre différentiel, ces conditions doivent assurer que les concentrations entre les différentes sortes de dimères restent dans le même rapport de proportionnalité aux cours du temps.

Pour simplifier le raisonnement, et quitte à renforcer les conditions nécessaires trouvées, supposons que la valeur
des rapports de proportionnalité éventuels soit dictée par les rapports entre les constantes d'association.
Pour que retrouver ces rapports de proportionnalités, il faut qu'ils soient également vérifier dans la distribution initiale (dans le cadre stochastique) ou dans l'état initial (dans le cadre différentiel). Comme ces rapports de proportions ne sont pas à priori connu, le plus simple est de considérer, dans le cadre stochastique, une distribution initiale avec un état avec uniquement des occurrences de monomères avec probabilité $1$, et, dans le cadre différentiel, un état initial avec uniquement des monomères. Par ailleurs, si le système est dans un état transitoire, vu la simplicité du modèle en question, le système va converger vers une distribution ou un état stationnaire dans lequel le quantité de chaque sorte de dimère sera proportionnelle au rapport entre les constantes d'association et de dissociation correspondantes. Du coup, pour que les rapports de proportions soient maintenus, il est nécessaire  que les constantes de dissociations soient égales.




En Fig.~\ref{fig:proportion} est vérifié de manière empririque si de tels rapports de proportionnalité se manifeste pour plusieurs jeux de paramètres, que ce soit dans la cadre stochastique (colonne de gauche) ou différentiel (colonne de droite), en faisant varier la valeur des constantes de dissociations, la distribution initiale (ou l'état initial),
et les constantes d'association.
Dans le cadre différentiel, l'évolution de trois rapports est considérée~: le rapport entre l'état composé quatre occurrences de monomère et d'une occurrence de dimère
formé par une liaison entre deux sites \site{x}{}{} et celui comprenant quatre occurrences de monomère et une occurrence de dimère formé par une liaison entre deux sites \site{y}{}{}~;
le rapport entre l'état composé de quatre occurrences de monomère et d'une occurrence de dimère
formé par une liaison entre deux sites \site{x}{}{} et celui comportant quatre occurrences de monomère et une occurrence de dimère formé par une liaison entre le site  \site{x}{}{} d'une occurrence de protéine et le site \site{y}{}{} de l'autre occurrence de protéine~; et le rapport entre l'état composé de deux occurrences de monomère et de deux occurrences de dimère
formé par une liaison entre le site  \site{x}{}{} d'une occurrence de protéine et le site \site{y}{}{} de l'autre occurrence de protéine, et celui formé de deux occurrences de monomère, d'une occurrence de dimère formé par une liaison entre deux sites \site{x}{}{} et d'une occurrence de dimère formé par une liaison entre deux sites \site{y}{}{}~;


\begin{enumerate}
\item Dans le premier jeu de paramètres, les constantes d'association sont choisies pour que les liaisons se forment de manière équitable entre les sites \site{x}{}{} et \site{y}{}{} des occurrences de la protéine \agent{A}{}. Les constantes de dissociation prennent toutes les trois la même valeur afin de préserver les rapports de proportionnalité quels qu'ils soient. Enfin, aucun dimère n'est présent ni dans la distribution initiale des états du système stochastique, ni dans l'état initial du système différentiel, de sortes que et la distribution initiale du système stochastique, et l'état initial du système différentiel satisfont n'importe quels  rapports de proportionnalité à propose de l'abondance des différentes sortes de dimère.  En Fig.~\ref{figctmcprop}, les courbes montrent de manière empirique que
la probabilité d'être dans l'état avec quatre occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de la protéine \agent{A}{} liées par leurs sites \site{x}{}{} est toujours la même que celle d'être dans l'état avec quatre occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de la protéine \agent{A}{} liées par leurs sites \site{y}{}{}. Par ailleurs, cette probabilité est toujours la moitié de celle d'être dans l'état avec quatre occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de la protéine \agent{A}{} liées par le site \site{x}{}{} de l'un et le site \site{y}{}{} de l'autre.
Ces rapports de proportionnalité correspondent à ceux déjà observer dans le jeu de "pile" ou "face".
Enfin, la probabilité d'être dans un état avec deux occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de dimères asymétriques est toujours deux fois plus grande que celle d'être dans un état avec deux occurrences de la protéine \agent{A}{} sous forme de monomère et d'une occurrence de chaque forme de dimère symétrique. Ce rapport s'explique que la formation d'un dimère asymétrique est deux fois plus probable que celle d'un type donnée de dimère symétrique (d'où un facteur $4$). Cependant, il faut diviser ce facteur par $2$, car deux dimères symétriques différents peuvent être obtenu en prenant le premier formé par une liaison entre deux sites \site{x}{}{} et le second entre deux sites \site{y}{}{}, ou l'inverse, soit deux fois plus de possibilités.

En ce qui concerne le comportement de la solution du système différentiel sous-jacent, les courbes en Fig.~\ref{figodeprop} montrent que les concentrations des deux sortes de dimère symétrique restent toujours égales, alors que la concentration en dimère asymétrique est toujours égale au double de cette valeur commune.

\item Dans le second jeu de paramètres,
la contrainte sur les constantes de dissociation est relachée.
Les constantes de dissociations sont ainsi fixées de manière arbitraire à $\kdxx=2$, $\kdyy=2$ et $\kdxy=4$.
Alors que les autres paramètres restent les mêmes que dans le premier jeu de paramètres.
Les courbes dessinées en Fig.~\ref{figctmcnotsymdissoprop} montrent que la probabilité d'être dans l'état avec quatre occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de la protéine \agent{A}{} liées par leurs sites \site{x}{}{} est toujours la même que celle d'être dans l'état avec quatre occurrences de la protéine \agent{A}{} sous forme de monomère et deux occurrences de la protéine \agent{A}{} liées par leurs sites \site{y}{}{}.
Par contre, les autres probabilités étudiées ne sont pas proportionnelles. Initialement, la probabilité d'être dans un état avec une occurrence de dimère asymétrique et quatre occurrences de la protéine \agent{A}{} sous la forme de monomère
est deux fois plus grande que celle d'être dans un état avec une occurrence de dimère asymétrique et quatre occurrences de la protéine \agent{A}{} sous la forme de monomère, mais ce rapport tends vers un avec le temps. D'autre part, la probabilité la probabilité d'être dans un état avec deux occurrences de dimère asymétrique et deux occurrences de la protéine \agent{A}{} sous la forme de monomère est deux fois plus grande au début que la probabilité d'être dans un état avec une occurrence de chacun des types de dimère symétrique et deux occurrences de la protéine \agent{A}{} sous la forme de monomère, mais ce rapport tends vers un demi avec le temps.
Dans le système différentiel, la concentration des deux types de dimère symétrique est toujours la même, alors que la concentration en dimère asymétrique est initialement deux fois plus grande, pour finalement converger vers cette même valeur.
Les rapports initiaux sont dictés par les constantes d'association, ce sont les mêmes que pour le premier jeu de paramètres. En revanche, les rapports à la limite sont dictés par le rapport entre les constantes respectives d'association et de dissociation (et la répétition des occurrences du dimère asymétrique pour le facteur un demi additionel).

\item Dans le troisième jeu de paramètres, c'est la  distribution d'état initiale (dans le cadre stochastique) et  l'état initial (dans le cadre différentiel) qui sont fixés arbitrairement. Aucun rapport de proportionnalité ne se dessine, que ce soit dans le cadre stochastique (voir en Fig.~\ref{figctmcnotsyminitialprop})  ou dans le cadre différentiel (voir en Fig.~\ref{figodenotsyminitialprop}).
Initialement, les rapports de probabilités et de concentrations sont imposés par les abondances au début de l'exécution des deux systèmes.  à la limite, ces rapports sont fixés
par le rapport entre les constantes respectives d'association et de dissociation, ce qui explique qu'ils sont les mêmes que pour le premier jeu de paramètres.

\item Enfin, le quatrième jeu de paramètres est obtenu
en fixant de manière arbitraire les constantes d'association.
Ceci a pour effet de déplacer les rapports de probabilités et les rapports de concentrations. Par contre, comme c'était attendu, ces rapports sont constants au cours du temps, que ce soit pour la sémantique stochastique ou la sémantique différentielle (voir en Fig.~\ref{figctmcnotsymasso} et en Fig.~\ref{figodenotsymasso}).
\end{enumerate}


\begin{figure*}[hp]
\hfill\subfigure[$\kxx=\kyy=1$,  $\kxy=\kdxx=\kdyy=\kdxy=2$ et $\probinitstate{\qone}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.13.1}}}
\end{center}
\end{minipage}}
\hfill
\subfigure[$\kxx=\kyy=1$,  $\kxy=\kdxx=\kdyy=\kdxy=2$, initialement $\conc{\pone}=6$ et  $\conc{\pxx}=\conc{\pxy}=\conc{\pyy}=0$.]
{\begin{minipage}{0.45\linewidth}
\label{figodeprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.13.1}}}
\end{center}
\end{minipage}}\hfill\mbox{}

\hfill\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=2$,  $\kdxy=4$ et $\probinitstate{\qone}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnotsymdissoprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.13.4}}}
\end{center}\end{minipage}}\hfill
\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=2$,  $\kdxy=4$,   initialement $\conc{\pone}=6$ sans dimère. ]%
{\begin{minipage}{0.45\linewidth}
\label{figodenotsymdissoprop}
\begin{center}{\scalebox{0.45}{\input{generated_pictures/ode.4.13.4}}}
\end{center}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=\kdxy=2$,
$\probinitstate{\qfive}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnotsyminitialprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.13.2}}}
\end{center}\end{minipage}}
\hfill
\subfigure[$\kxx=\kyy=1$, $\kxy=\kdxx=\kdyy=\kdxy=2$,
initialement $\conc{\pone}=\conc{\pxx}=2$ et $\conc{\pyy}=\conc{\pxy}=0$.]%
{\begin{minipage}{0.45\linewidth}
\label{figodenotsyminitialprop}\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.13.2}}}
\end{center}\end{minipage}}\hfill\mbox{}

\hfill\subfigure[$\kxx=1$, $\kyy=2$, $\kxy=4$,  $\kdxx=\kdyy=\kdxy=2$ et $\probinitstate{\qone}=1$.]%
{\begin{minipage}{0.45\linewidth}
\label{figctmcnotsymassoprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/sym.4.13.3}}}
\end{center}\end{minipage}}
\hfill
\subfigure[$\kxx=1$, $\kyy=2$, $\kxy=4$,  $\kdxx=\kdyy=\kdxy=2$ initialement $\conc{\pone}=6$ sans dimère.]%
{\begin{minipage}{0.45\linewidth}
\label{figodenotsymassoprop}
\begin{center}
{\scalebox{0.45}{\input{generated_pictures/ode.4.13.3}}}
\end{center}\end{minipage}}\hfill\mbox{}


\caption{Relations de proportionnalité dans le modèle initial.
 à gauche, évolution de rapports entre la probabilité d'être dans certains états pour différents paramètres cinétiques et différentes distributions d'états initiaux dans le système stochastique sous-jacent. à droite, évolution de rapports entre la concentration de différents complexes biochimiques  pour différents paramètres cinétiques et différentes concentrations initiales. }
\label{fig:proportion}
\end{figure*}

L'invariance de ces rapports de proportionnalité, pour certains jeux de paramètres est révélateur de la présence d'une relation de groupage faible. Celle-ci permet de quotienter l'exécution
d'une chaîne de Markov pour certaines distributions d'états initiales tout en restant Markovien \cite{buchholz94}.
De même, cela permet de réduire le système différentiel sous-jacent pour certains états initiaux.

Dans le cas du premier jeu de paramètres, le quotient opère même à plus bas-niveau, puisqu'il s'exprime au niveau réactionnel: à chaque réaction, peut être associée une réaction symétrique obtenue en échangeant les instances des sites \site{x}{}{} et \site{y}{}{} dans certaines occurrences de la protéine \agent{A}{}, ce qui permet de montrer l'existence d'une bisimulation arrière \cite{1347609} sur système de transition stochastique sous-jacent ou de réduire le système différentiel sous-jacent.

\subsection{Symetries and model reduction}



To conclude with this motivating example, we have seen that symetries can arise in molecular species, in the states of the systems, in distributions of states and in the action of the rules and that the symetries have an impact in our capability to coarse-grain the dynamic of our system. In particular, when the action of the rules are symetric, we can safely quotient the states of the systems, which makes us think of a forward bisimulation. Moreover, in the initial distribution is symetric as well, then the reduced system carries a statistic invariant (namely, the quotient between probability of two symetric states is invariant and is equal to the inverse of the quotient between their number of automorphisms, which suggest a backward bisimulation.

Let us see how these results can be generalised to all the models written in the language \kappa.

\section{Group actions over rule-based models}

\label{sym-algebraic}

Now we specialise the notions of groups and actions of group to the case of site graphs. Our goal is to define groups of transformations between  site graphs, such that the action of each transformation can be lifted to  embeddings, rules, and rule refinements. Then, we will define the models that are symetric as the ones in which the set of rules (and their kinetics rates) are invariant by these transformations and show that, in such a case, two states which are equivalent modulo the group of transformations  behave similarly by the means of bisimulations \cite{buchholz:94,1347609}.

\subsection{Group actions over site graphs}



\newcommand{\diagembseven}[7]%
{\begin{equation*}
\xymatrix@C=15mm@R=1mm{%
#1\;\ar@{^{(}->}|w^{#5}[r] & #2 \\
\ar@2{~>}_{#6}[ddd] & \ar@2{~>}^{#3}[ddd] \\\\\\
 & \\
\actiongraphlong{#4}{#1}\;
\ar@{^{(}->}|w^{#7}[r]
& \actiongraphlong{#3}{#2}}
\end{equation*}}


We want to provide a definition of transformations between site graphs which enables to lift the action of these transformations over the basic elements of the semantics, namely fully specified site graphs, weak embeddings, embeddings, rules, and refinements. To achieve this goal, we require that, for any weak embedding $h$ between  two site graphs $E$ and $F$, each transformation  which can be applied with the image $F$ of the weak  embedding $h$ can be restricted into a transformation which can be applied to the domain $E$ of the weak embedding $h$, hence providing a weak embedding between the image (by this transformation) of the domain $E$ and the image (by this transformation) of the image $F$ of the embedding $h$.

\begin{definition}[set of transformations]
\label{defn:permutation}
A \emph{set of transformations} $\groupset{}$ over site graphs is defined as a quadruple
$\groupsetlong$, made of a family of finite groups $(\groupset[E]{},\circ_E)$ indexed by site graphs, and three functions $\actiongraphlong{}{}$, $\actionembactionlong{}{}$, and $\actionembemblong{}{}$, where:
\begin{itemize}
\item the function $\ldot$ maps each pair $(\sigma_E,E)$ such that $E$ is a site graph and $\sigma_E$ is an element of $\group[E]{}$ to a site graph, that is written $\actiongraphlong{\sigma_E}{E}$;
\item the function $\ldot'$ maps each pair $(f,\sigma_F)$ such that $f$ is a weak  embedding between two site graphs $E$ and $F$, and $\sigma_F$ is an element of $\group[F]{}$ to an element in $\group[E]{}$, that is written $\actionembactionlong{\sigma_F}{f}$;
\item the function $\ldot''$ maps each pair $(\sigma_F,f)$ such that $f$ is a weak embedding between two site graphs $E$ and $F$, and $\sigma_F$ is an element of $\group[F]{}$ to a weak embedding $\actionembemblong{\sigma_F}{f}$ between the site graph $\actiongraphlong{(\actionembactionlong{\sigma_F}{f})}{E}$ and the site graph $\actiongraphlong{\sigma_F}{F}$
\begin{minipage}{\linewidth}
\begin{center}
{\begin{minipage}{\linewidth}\diagembseven{E}{F}{\sigma_F}{{(\actionembactionlong{\sigma_F}{f})}}{f}{\actionembactionlong{\sigma_F}{f}}{\actionembemblong{\sigma_F}{f}}\end{minipage}}\end{center}\end{minipage}
\end{itemize}
such that, for any site graph $E$ and any element $\sigma_E\in\group[E]{}$, the following properties are satisfied: \begin{enumerate}
\item \label{defn:permutation:indexomit}the groups $(\group[E]{},\circ_E)$ and $(\group[{\actiongraphlong{\sigma_E}{E}}]{},\circ_{\actiongraphlong{\sigma_E}{E}})$ are the same;
\item the function which maps each element $\sigma_E$ of the group $\group[E]$ and any site graph $E'$ in the set $\{\actiongraphlong{\sigma_E}{E}\;|\;\sigma_E\in\group[E]\}$ to the site graph $\actiongraphlong{\sigma_E}{E'}$ is a group action.
\end{enumerate}
\end{definition}

The result of the application of a transformation to a site graph (resp.~to a weak  embedding) is also called the image of the site graph (resp.~weak embedding) by this transformation.

\begin{figure*}[t]
\newcommand{\shorttie}[2]{\scalebox{0.65}{\begin{minipage}{0.65\linewidth}\tie{\TRUE}{\TRUE}{\TRUE}{\TRUE}{#1}{#2}\end{minipage}}}%


\subfigure[Orbit of the site graph that is denoted by the pattern ${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$ with the group of heterogeneous permutations of site $\groupsetone$ that consist, for each agent of type \agent{A}{},  in permuting, or not, the internal state of two sites \sitefont{x} and \sitefont{y} of this agent.]{%
\label{fig:heterogeneousorbit}
\begin{minipage}{0.46\linewidth}\begin{center}
\begin{minipage}{0.95\linewidth}
\xymatrix@C=12mm@R=20mm{%
\incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_uu.pdf}\ar@2@/_{1cm}/@{<~>}[d]\ar@2@/^{1cm}/@{<~>}[r] &
\incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_up.pdf}\ar@2@/^{1cm}/@{<~>}[d] \\
\incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_pu.pdf}\ar@2@/_{1cm}/@{<~>}[r] &
\incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_pp.pdf}\smallskip\\}
\end{minipage}\end{center}

\vspace*{0.6cm}
\end{minipage}}
\hfill
\subfigure[Orbit of the site graph that is denoted by the pattern ${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$ with the group of homogeneous permutations of sites $\groupsettwo$ that consist in, for each connected component,  either keeping the connected component as it is, or permuting the internal state of two sites \sitefont{x} and \sitefont{y} in all the agents of this connected component which have the type \agentfont{A}{}.]{%
\label{fig:homogeneousorbit}
\begin{minipage}{0.46\linewidth}\begin{center}
\begin{minipage}{0.95\linewidth}
\xymatrix@C=12mm@R=20mm{%
\incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_uu.pdf}
 \ar@2@{<~>}[dr] & \\
& \incbox{15.24mm}{34.544mm}{generated_pictures/sym_dimer1_pp.pdf} \smallskip\\}
\end{minipage}\end{center}

\vspace*{0.6cm}

\end{minipage}}
\caption{Examples of transformations between site graphs.}
\end{figure*}

\begin{example}[heterogeneous permutations of sites]
\label{exmp:siteswap}As an example, we consider the transformations that consist in swapping (or not) the internal state of two sites $\text{\site{x}{}{}}$ and $\text{\site{y}{}{}}$ in agents of mixtures. We consider only one type of agents $\agent{A}{}$, with three sites $x$, $y$, $z$. We assume that sites $x$ and $y$ can bear the internal state $u$, or the internal state $p$, and that sites $z$ can be bound to the site $z$ of an another agent.

Thus, the signature of our model is the following one:
\begin{itemize}
\item $\agentname = \{\text{\agent{A}{}}\}$;
\item $\sitename = \{\text{\site{x}{}{}},\text{\site{y}{}{}},\text{\site{z}{}{}}\}$;
\item $\statename = \{\state{u},\state{p}\}$;
\item $\statesite(A)=\{\text{\site{x}{}{}},\text{\site{y}{}{}}\}$;
\item $\linksite(A)=\{\text{\site{z}{}{}}\}$.
\end{itemize}

For any site graph $E$, we introduce $\groupsetone[E]$ as the set $\wp(\agents[E])$ of the subsets of the set of the agents of $E$. Intuitively, an element $X\in\groupsetone[E]$ denotes the agents in which we are going to swap the state of the site $\text{\site{x}{}{}}$ and the site $\text{\site{y}{}{}}$.

The set $\groupsetone[E]$ is a group for the symetric difference $\xor$ which is defined as follows:
\begin{equation*}
\xor\;:\;\begin{cases}
\begin{array}{rcl}
\agents[E] \times \agents[E] & \rightarrow & \agents[E] \cr
 (X,Y) & \rightarrow & (X\setminus Y) \cup (Y \setminus X).
\end{array}
\end{cases}
\end{equation*}
The empty set is the identity element and each element is its own inverse.

The image of a site graph $E$ by a transformation  $X\in\groupsetone[E]$
is obtained by swapping the internal state of sites \site{x}{}{} and \site{y}{}{} in the agents that belongs to the set $X$, that is to say that, if we write $E=\graphtuple$ and $\sigma$ the permutation over the set $\sitename$ mapping the site identifier \site{x}{}{} to the site identifier \site{y}{}{}, the site identifier \site{y}{}{} to the site identifier \site{x}{}{}, and the site identifier \site{z}{}{} to itself,
the site graph $\actiongraphlong{X}{E}$ is defined as the site graph $(\agents,\type,\sites',\links,\props')$ where the set $\sites'$ is defined as the join between the set $\{(n,i)\in\sites\;|\;n\not\in X\}$ and the set
$\{(n,\sigma(i))\;|\;n\in X, (n,i)\in\sites\}$,  and for any site $(n,i)\in\sites'$, $\props'(n,i)$ is defined as $\props'(n,i)$ is defined  as $\props(n,\sigma(i))$ whenever the agent identifier $n$ belongs to the set $X$ and, $\props'(n,i)$ is defined as $\props(n,i)$ otherwise.

The orbit of the site graph that is denoted by the expression
\agent{A$_1$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\btype{\agent{A$_2$}}{\site{z}{}{}}}}\agentsep\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\btype{\agent{A$_1$}}{\site{z}{}{}}}} is given in Fig.~\ref{fig:heterogeneousorbit}.

Given an embedding $f$ between two site graphs $E$ and $F$, and $X\in\groupsetone[F]$ a permutation of the sites of the site graph $F$, the restriction of the symetry $X$ to the domain $E$ of the embedding $f$ is defined as $\{a \in \agents[E]\;|\; \tilde{f}(a)\in X\}$. Intuitively, this means that the transformation $\actionembactionlong{X}{f}$ swaps the state of the sites $\text{\site{x}{}{}}$ and $\text{\site{y}{}{}}$ in a given agent of $E$ if, and only if, the transformation $X$ swaps the states of the sites $\text{\site{x}{}{}}$ and $\text{\site{y}{}{}}$ in the image by the embedding $f$ of this agent.

Lastly, given an embedding $f$ between two site graphs $E$ and $F$ by a permutation $X\in\groupsetone[E]$ of the sites of the site graph $E$, we notice that, on the first hand,
the site graphs $E$ and $\actiongraphlong{(\actionembactionlong{X}{f})}{E}$ have the same set of agents, and that, on the second hand, the site graphs $F$ and $\actiongraphlong{X}{F}$ have the same set of agents.
Moreover, we notice that the function $\tilde{f}$ also induces an embedding between the site graphs $\actiongraphlong{(\actionembactionlong{X}{f})}{E}$ and $\actiongraphlong{X}{F}$. We define the embedding $\actionemblong{X}{f}$ as this embedding.

In Fig.~\ref{fig:imageembedding}, we give an example of an embedding $f$ between two site graphs $E$ and $F$, and we give the image of this embedding by a permutation of sites.
\end{example}


\begin{figure}[t]
\incgraphics[0.3\linewidth]{generated_pictures/sym_exa_left.pdf}
\begin{minipage}{0.3\linewidth}
\xymatrix@C=20mm@R=20mm{%
\ar@2@{<~>}^{\{2\}}[r]
& \\
\ar@2@{<~>}^{\{2\}}[r]
& \\
\ar@2@{<~>}^{\actionembactionlong{\{2\}}{f}={\{1\}}}[r]
& \\}
\end{minipage}
\incgraphics[0.3\linewidth]{generated_pictures/sym_exa_right.pdf}
\caption{An example of two symetric embeddings. We consider the embedding $f$ between the site graph $E \stackrel{\scriptscriptstyle \Delta}{=} \agent{A$_1$}{$\sitefont{y}_p$}$
and the site graph $F \stackrel{\scriptscriptstyle \Delta}{=} \agent{A$_2$}{$\sitefont{x}_u\sitesep\sitefont{y}_p$}$.
The permutation of sites   $\{2\}\in\groupset[F]$ swaps the state of the sites $\sitefont{x}$ and $\sitefont{y}$ in the unique agent of the site graph $F$. The permutation of sites  $\{2\}$ can also be restricted to the domain $E$ of the embedding $f$, which yields the permutation of sites  $\actionembactionlong{\{2\}}{f} \in \groupset[E]$, which is indeed equal to the permutation of sites  $\{1\}$ and that consists in replacing the site $\sitefont{y}$ into a site $\sitefont{x}$ (with the same internal state). The image $\actionembemblong{\{2\}}{f}$ of the embedding $f$ by the permutation of sites  $\{2\}$ is then the embedding mapping the unique agent of the image $\actiongraphlong{(\actionembactionlong{\{2\}}{f})}{E}$ of site graph $E$ by the permutation of sites  $\actionembactionlong{\{2\}}{f}$ into the unique agent of the image $\actiongraphlong{\{2\}}{F}$ of the site graph $F$ by the permutation of sites $\{2\}$.}
\label{fig:imageembedding}
\end{figure}



In Exa.~\ref{exmp:siteswap}, the permutation of the sites \site{x}{}{} and \site{y}{}{} is done independently for each agent. We call such permutations of sites  heterogeneous. Now we would like to define a new set of transformation in which the same permutation has to be applied to both agents in each dimer. Checking the assumptions of Def.~\ref{defn:permutation} can be cumbersome. Since we introduce a more direct way to introduce sets of transformations over site graphs  as subsets of existing ones. More precisely, one can define a new set of transformations over site graphs as a subset of an existing one, providing that the former one preserves the structure of the latter one, that is to say, that this new set must be close upon product of transformations, and upon the restriction of a transformation to the domain of weak embeddings. This is formalised in the following definition.
\newcommand{\groupsetlongbis}[1][]{((\groupsetbis[E],\tilde{\circ}_{E}),\tilde{\ldot},\tilde{\ldot}',\tilde{\ldot}'')}
\newcommand{\groupsetbis}[1][]{\tilde{\groupset}_{#1}}
\begin{definition}[subset of transformations over site graphs]
Let us consider $\groupset\bydef\groupsetlong$ a set of transformations over site graphs. We call a subset of transformations of $\groupset$, a family $(\groupsetbis[E])$ of sets indexed by site graphs which satisfies the following properties:
\begin{enumerate}
\item for any site graph $G$, the set $\groupsetbis[G]$ is a non empty subset of the set $\groupset[G]$;
\item for any site graph $G$ and any transformation $\sigma\in\groupsetbis[G]$ over the site graph $G$, the set $\groupsetbis[G]$ and the set $\groupsetbis[\actiongraphlong{\sigma}{G}]$ are the equal;
\item for any site graph $G$ and any two transformations  $\sigma,\sigma'\in\groupsetbis[G]$ of the set $\groupsetbis[G]$, the transformation $\sigma\circ_G \sigma'$ belongs to the set $\groupsetbis[G]$ as well;
\item for any weak embedding $f$ between two site graphs $E$ and $F$ and any transformation  $\sigma\in\groupsetbis[F]$ over the site graph $F$, the restriction $\actionembactionlong{\sigma}{f}$ of the transformation  $\sigma$ to the domain of $f$ also belongs to the set $\groupsetbis[E]$.
\end{enumerate}
\end{definition}

\begin{prop}
Let $\groupsetlong$ be a set of transformations over site graphs and $(\groupset[E]')$ be a subset of transformations of the the set of transformations $(\groupset[E])$.
Then the tuple $\groupsetlongbis$ where~:
\begin{enumerate}
\item for any site graph $E$, the function $\tilde{\circ}_E$ maps any couple of transformations  $\sigma,\sigma'\in\groupsetbis[E]$ that can be applied to the site graph $E$, to the transformation $\sigma \circ_E \sigma'$,
\item the function $\tilde{\ldot}$ maps any site graph $E$ and any transformation $\sigma\in\groupsetbis[E]$ that can be applied to the site graph  $E$, to the site graph $\actiongraphlong{\sigma}{E}$,
\item the function $\tilde{\ldot}'$ maps any weak embedding $f$ between two site graphs $E$ and $F$ and any transformation  $\sigma\in\groupsetbis[F]$ that can be applied to the site graph  $F$, to the transformation  $\actionembactionlong{\sigma}{f}$,
\item the function $\tilde{\ldot}''$ maps any weak embedding $f$ between two site graphs $E$ and $F$ and any transformation  $\sigma\in\groupsetbis[F]$ that can be applied to the site graph $F$, to the embedding $\actionembemblong{\sigma}{f}$,
\end{enumerate}
is a set of transformations over site graphs.
\end{prop}

Now we define another set of transformations over site graphs, that we will call the set of homogeneous permutations of sites.
Unlike a heterogeneous permutation of sites, a homogeneous permutation of sites consists in applying the same permutation to all the agents of a given connected component. The set of the homogeneous permutations of sites can be introduced as a subset of the heterogeneous permutations of sites.


\begin{example}[homogeneous permutations of sites]
\label{exmp:siteswapbis}
With the same signature as in Exa.~\ref{exmp:siteswap},
we introduce the set of homogeneous permutations of sites as a subset of the set of the heterogeneous ones. More precisely,  for any site graph $G$, we consider the subset $\groupsettwo[G]\subseteq \groupsetone[G]$ of the heterogeneous permutations of sites $\groupsetone[G]$ such that for any element $\mathcal{X}\in\groupsettwo[G]$ and any pair of agents $(n,n')\in\agents[G]^2$, if the agents $n$ and $n'$ are bound together (via their respective site $z$) then $n\in\mathcal{X}$ if, and only if, $n'\in\mathcal{X}$.

The orbit of the site graph that is denoted by the expression
\agent{A$_1$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\btype{\agent{A$_2$}}{\site{z}{}{}}}}\agentsep\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\btype{\agent{A$_1$}}{\site{z}{}{}}}} is given in Fig.~\ref{fig:homogeneousorbit}.
\end{example}



Given a set of transformations over site graphs, two site graphs are said to be symetric if one is the image of the other one by a given transformation  (in that set of transformations over site graphs).
This is formalized in the following definition:
\begin{definition}[pairs of symetric site graphs]
\label{def:symetricgraph}
Let $\groupset[] = \groupsetlong$ be a set of transformations over site graphs. We say that two graphs $E$ and $F$ are $\groupset[]$-symetric to one another with respect to the set of transformations over site graphs  $\group$ if and only if there exists $\sigma_E\in\group[E]$ such that $F = \actiongraphlong{\sigma_E}{E}$.

In such a case, we write $E \groupequiv F$.
\end{definition}

\begin{prop}
Let $\group$ be a set of transformations over site graphs.
The relation $\groupequiv$ is an equivalence relation over site graphs.
\end{prop}

The same way, two weak embeddings are said to be symetric if one is the image of the other one by a given transformation.
This is formalized in the following definition:
\begin{definition}[pairs of symetric weak embeddings]
Let $\groupset[] = \groupsetlong$ be a set of transformations over site graphs. We say that two embeddings  $f\;:\;E \rembedding\!F$ and $g\;:\;G \rembedding\!H$ are $\groupset[]$-symetric to one another with respect to the set of transformations over site graphs  $\group$ if and only if there exists $\sigma_F\in\group[F]$ such that $g= \actionemblong{\sigma_F}{f}$.

In such a case, we write $f \groupequiv g$.
\end{definition}

\begin{prop}
Let $\group$ be a set of transformations over site graphs.
The relation $\groupequiv$ is an equivalence relation over weak embeddings.
\end{prop}

Given a weak embedding $f$ between the site graph $E$ and the site graph $F$, and a transformation  over site graphs $\sigma_F\in\group[F]$. The transformation $\sigma_F$ can be applied to the image $F$ of the weak embedding $f$ and the result is written as $\actiongraphlong{\sigma}{F}$; the transformation  $\sigma_F$ can also be restricted to the domain $E$ of the weak embedding $f$ and the result is written $\actionembemblong{\sigma_F}{f}$ (or $\actionembemblong{\sigma_F}{f}$). The constraint on $\ldot''$ in Def.~\ref{defn:permutation} ensures that $\actionembemblong{\sigma_F}{f}$ is a weak embedding between $\actiongraphlong{(\actionembactionlong{\sigma}{f})}{E}$ and $\actiongraphlong{\sigma_F}{F}$.
Yet, there may be several ways to restrict a transformation  to the domain of a weak embedding, because a transformation over site graphs can be described as the product of two others or because the weak embedding can be described as the composition of two others. In such a case, it is important to get the same result. Thus, we need to strengthen Def.~\ref{defn:permutation}. This is actually the purpose of the two following definitions.


\begin{definition}[distributivity of the restriction of the transformations over site graphs,  over the product between these transformations]
\label{defn:compositiondistributeoversymetries}
Let $\groupset{}$ be a set of transformations over site graphs.
We say that \emph{restriction of the transformations} in $\groupset{}$ \emph{to the domain of weak embeddings distributes over the product between these transformations}, if and only if, for any two site graphs $E$ and $F$, any weak embedding $f$ between the site graph $E$ and the site graph $F$, the following constraints are satisfied:
\begin{enumerate}
\item the function mapping each pair $(\sigma_F,f')$ such that $\sigma_F\in\group[F]{}$ and $f'$ is a weak  embedding such that $\im(f')\groupequiv F$,
to the weak embedding $\actionembemblong{\sigma_F}{f''}$, is a group action;
\item \label{defn:permutationcarryidentity}$\actionembactionlong{\varepsilon_{F}}{f}=\varepsilon_{E}$, where $\varepsilon_{F}$ (resp.~$\varepsilon_{E}$) is the identity element of the group $\groupset[F]{}$ (resp.~$\groupset[E]{}$);
\item \label{defn:permutationcarryproduct}
\newcommand{\sigmaE}{\actionembactionlong{\sigma}{f}}
\newcommand{\sigmaEbis}{\actionembactionlong{\sigma'}{(\actionembemblong{\sigma}{f})}}
$\actionembactionlong{(\sigma'\circ_{F}\sigma)}{f}=(\sigmaEbis )  \circ_{E} (\sigmaE)$.
\end{enumerate}
\end{definition}


\begin{definition}[distributivity of the restriction of transformations over site graphs,  over the composition of embeddings]
\label{defn:symetriesdistributeovercomposition}
Let $\groupset{}$ be a set of transformations over site graphs.
We say that the \emph{restriction of the transformations} in  $\groupset{}$ \emph{to the domain of weak embeddings distributes over the composition of these weak embeddings}, if and only if, for any site graphs $E$, $F$, $G$, any weak embeddings $f$ between the site graph $E$ and the site graph $F$, and $g$ between the site graph $F$ and the site graph $G$, and any transformation $\sigma_G\in\group[G]{}$ that can be applied to the site graph  $G$, the following constraints hold:
\begin{enumerate}
\item \label{compositiona} $\actionembactionlong{\sigma_G}{\identity{G}}=\sigma_G$;
\item \label{compositionb}$\actionembemblong{\sigma_G}{\identity{G}}=\identity{{\actiongraphlong{\sigma_G}{G}}}$;
\item \label{compositionc} $\actionembactionlong{\sigma_G}{(gf)}=\actionembactionlong{(\actionembactionlong{\sigma_G}{g})}{f}$;
\item \label{compositiond} and $\actionembemblong{\sigma_G}{(gf)}=(\actionembemblong{\sigma_G}{g})(\actionembemblong{{(\actionembactionlong{\sigma_G}{g})}}{f})$.
\end{enumerate}
\end{definition}

The purpose of Def.~\ref{defn:compositiondistributeoversymetries} is to ensure that the operation of restricting the transformations that can be applied to the image of weak embeddings  to their domains is compatible with the group structure of the transformations over site graphs, as illustrated in Fig.~\ref{fig:ditributivityproduct}. Let us explain this definition. We consider $\groupset{}$ a group of transformations over site graphs such that the restriction of the transformations in $\groupset{}$ to the domain of weak embeddings distributes over the product  between these transfomations. According to Def.~\ref{defn:permutation}, for any site graph $E$, the function $\ldot$ is a group action between the group  $\groupset[E]$ of the transformations which can be applied to the site graph $E$ and the site graphs that are $\groupset$-symetric with the site graph $E$. Thus, applying the identity element to a site graph does not change this site graph, and one can apply a product of two transformations to a site graph, or apply successively these two transformations in the reverse order and gets the same site graph as result. Def.~\ref{defn:compositiondistributeoversymetries} ensures the same properties over the application of symetries to weak embeddings: for any weak embedding $f$ between $E$ and $F$, the function $\ldot''$ is a group action between the group  $\groupset[F]$ of the transformations which can be applied to the embedding $f$  and the weak embeddings that are $\groupset$-symetric with $f$.
Lastly, the constraints \ref{defn:permutationcarryidentity} and \ref{defn:permutationcarryproduct} in Def.~\ref{defn:compositiondistributeoversymetries} ensure that restricting transformations over site graphs  to the domain of weak embeddings
is compatible with the group structure of transformations over site graphs.
More precisely, the constraint \ref{defn:permutationcarryidentity} of Def.~\ref{defn:compositiondistributeoversymetries} ensure that the restriction the identity element of the group $\groupset[F]$ to the domain $E$ of a weak embedding embedding $f$ between the site graphs $E$ and $F$, is the identity element of the group  $\groupset[E]$ of the transformations that can be applied to the site graph $E$ (eg.~see Fig.~\ref{Applyingidentity}).
Moreover, the constraint \ref{defn:permutationcarryproduct} in Def.~\ref{defn:compositiondistributeoversymetries} ensures, that the restriction a product $\sigma'_F\circ \sigma_F$ between two transformations that can be applied to the site graph $F$ to the domain of a weak embedding $f$ between two site graphs $E$ and $F$, can be done in two equivalent ways (eg.~see Fig.~\ref{applyproduct}): either in one step, or in two steps.
In one step, we get the transformation $\actionembactionlong{(\sigma'_F\circ \sigma_F)}{f}$ that can be applied to the site graph $E$.
In two steps, firstly, we restrict the transformation  $\sigma_F$ to the domain $E$ of the weak embedding $f$.
Doing this, we get the transformation  $\actionembactionlong{\sigma_F}{f}$ that can be applied to the site graph $E$.
Then we restrict the transformation $\sigma'_F$ to the domain of the weak embedding $\actionembemblong{\sigma_F}{f}$ (which is the image by the transformation $\sigma_F$ of the weak embedding $f$), and get the transformation  $\actionembactionlong{(\actionembemblong{\sigma_F}{f})}{\sigma'_F}$ that can be applied to any  site graph that is $\groupset$-symetric to the site graph $E$. Then we make the product between the transformation $\actionembactionlong{(\actionembemblong{\sigma_F}{f})}{\sigma'_F}$ and the transformation $\actionembactionlong{\sigma_F}{f}$ in $\groupset[E]$.


\begin{figure}[ht]
\newcommand{\sigmaE}{\actionembactionlong{\sigma_F}{f}}
\newcommand{\sigmaF}{\actionembactionlong{\sigma_G}{g}}
\newcommand{\sigmaEbis}{\actionembactionlong{\sigma'_F}{(\actionembemblong{\sigma_F}{f})}}
\subfigure[Identity element.]{\label{Applyingidentity}
\begin{minipage}{0.3\linewidth}
\scalebox{0.7}%
{%
\begin{minipage}{\linewidth}
\begin{equation*}
\xymatrix@C=15mm@R=2mm{%
\\\\E\;\ar@{^{(}->}|w^{f}[r] & F \\
\ar@/^/@2{~>}^{\actionembactionlong{\varepsilon_F}{f}}[ddd]
\ar@/_/@2{~>}_{\varepsilon_E}[ddd] & \ar@2{~>}^{\varepsilon_F}[ddd] \\\\\\
 & \\
E\;\ar@{^{(}->}|w^{f}[r]
& F \\\\}
\end{equation*}\end{minipage}}\end{minipage}}
\hfill\subfigure[Product of transformations over site graphs.]%
{\label{applyproduct}
\begin{minipage}{0.65\linewidth}
\scalebox{0.7}
{\begin{minipage}{\linewidth}\begin{equation*}
\hspace*{-5mm}\xymatrix@C=0.2mm@R=2mm{%
 E\;\ar@{^{(}->}|w^{f}[rrrrrr]
&&&& & & F  \\
  \ar@2@{~>}_{\actionembactionlong{(\sigma'_F\circ_F \sigma_F)}{f}}[ddddd]
                   \ar@2@/^/@{~>}^{\sigmaE}[ddr]
&&&& &&
\ar@2@/_/@{~>}_{\sigma_F}[ddl]
\ar@2@{~>}^{\sigma'_F\circ_F\sigma_F}[ddddd]
                           & \\
                         &&&& & & & \\
                         &&&& & & & \\
& \actiongraphlong{(\sigmaE)}{E}\;\ar@2@/^/@{~>}^{\sigmaEbis}[ddl]
\ar@{^{(}->}|w^(0.6){\actionembemblong{\sigma_F}{f}}[rrrr] &&&& \actiongraphlong{\sigma_F}{F} \ar@2@/_/@{~>}_{\sigma'_F}[ddr] \\
&&& & & & & \\
&&& & & & & \\
 \actiongraphlong{(\actionembactionlong{(\sigma'_F\circ_F\sigma_F)}{f})}{E} \ar@{^{(}->}|w^{\actionembemblong{(\sigma'_F \circ_F \sigma_F)}{f}}[rrrrrr]&&&&& & \actiongraphlong{(\sigma'_F \circ_F \sigma_F)}{F}\\}
\end{equation*}\end{minipage}}\end{minipage}}
\caption{Commutative diagrams that describe the compatibility between the restriction of transformations over site graphs to the domain of weak embeddings and the group structure of these transformations.}
\label{fig:ditributivityproduct}\end{figure}

Applying transformations over site graphs to weak embeddings should also be compatible with the composition of weak embeddings. This is ensured by Def.~\ref{defn:symetriesdistributeovercomposition}, which is illustrated in Fig.~\ref{fig:ditributivitycomposition}.
More precisely, Fig.~\ref{subfig:id} describes what happens when we apply a transformation between site graphs to an identity embedding:
restricting a transformation  $\sigma_G\in\groupset[G]$ that can be applied to a site graph $G$ to the domain of the identity embedding $\identity{G}$ over the site graph $G$ does not change the transformation $\sigma_G$  (constraint \ref{compositiona} of Def.~\ref{defn:symetriesdistributeovercomposition}) and the image of the identity embedding $\identity{G}$ over a site graph $E$ by a transformation $\sigma_G$ that can be applied to the site graph $G$, is the identity embedding $\identity{\actiongraphlong{\sigma_G}{G}}$ over the image  $\actiongraphlong{\sigma_G}{G}$ of the site graph $G$ by the transformation $\sigma_G$ (constraint \ref{compositionb} of Def.~\ref{defn:symetriesdistributeovercomposition}).
Moreover, we can also restrict a transformation  $\sigma_G\in\groupset[G]$ over site graphs to the domain of the composition of two weak embeddings $gf$, in two different ways, either in one step, or in two steps (by firstly restricting it to the domain of $f$ and then restricting the result to the domain of $g$).
The constraint \ref{compositionc} of Def.~\ref{defn:symetriesdistributeovercomposition} ensures that the two so obtained transformations $\actionembactionlong{\sigma_G}{(gf)}$ and $\actionembactionlong{(\actionembactionlong{\sigma_G}{g})}{f}$ are equal. Moreover, the constraint \ref{compositiond} of Def.~\ref{defn:symetriesdistributeovercomposition}  the image of the composition $gf$ of the weak embeddings $g$ and $f$ by the transformation $\sigma_G$ is equal to
the composition of the weak embedding $\actionembemblong{\sigma_G}{g}$ which is the image of the weak embedding $g$ by the transformation  $\sigma_G$ and the weak embedding $\actionembemblong{(\actionembactionlong{\sigma_G}{g})}{f}$ which is the image of the weak embedding $f$ by the transformation  $\actionembactionlong{\sigma_G}{g}$ that is obtained by restricting the transformation $\sigma_G$ to the domain of the weak embedding $g$.

\newcommand{\diagembsevenstrong}[7]%
{\begin{equation*}
\xymatrix@C=15mm@R=1mm{%
\\\\\\#1\; \ar@{^{(}->}^{#5}[r] & #2 \\
\ar@2{~>}_{#6}[ddd] & \ar@2{~>}^{#3}[ddd] \\\\\\
 & \\
\actiongraphlong{#4}{#1}
\ar@{^{(}->}^{#7}[r]\;
& \actiongraphlong{#3}{#2}\\\\\\\\}
\end{equation*}}

\begin{figure}
\newcommand{\sigmaE}{\actionembactionlong{(\sigmaF)}{f}}
\newcommand{\sigmaF}{\actionembactionlong{\sigma_G}{g}}
\newcommand{\sigmaEbis}{\actionembactionlong{\sigma_G}{(gf)}}
\subfigure[Identity embedding.]{%
\label{subfig:id}
\begin{minipage}{0.4\linewidth}
\scalebox{0.7}{
{\hspace*{0.5cm}\begin{minipage}{\linewidth}\diagembsevenstrong{G}{G}{\sigma_G}{\sigma_G}{\identity{G}}{\sigma_G}{\identity{{\actiongraphlong{\sigma_G}{G}}}}
\end{minipage}}}\end{minipage}}
\hfill\subfigure[Composition of weak embeddings.]{%
\label{subfig:comp}
\begin{minipage}{0.55\linewidth}
\scalebox{0.7}%
{\begin{minipage}{\linewidth}
\begin{equation*}\hspace*{-5mm}
\xymatrix@C=10mm@R=1mm{%
E
\ar@{_{(}->}|w_{f}[ddr]
\ar@{^{(}->}|w^{gf}[rr]
&  & G  \\ \\
\ar@2@/^/@{~>}^{\sigmaEbis}[ddddd]\ar@2@/_/@{~>}_{\sigmaE}[ddddd]
& F \ar@{_{(}->}|w_{g}[uur] & \\
  & \ar@2{~>}^{{\sigmaF}}[ddd] &  \ar@2{~>}^{\sigma_G}[ddd]  \\ \\
& & \\
& & \\
& \actiongraphlong{(\sigmaF)}{F}\ar@{^{(}->}|w^{\actionembemblong{\sigma_G}{g}}[ddr] & \\\\
\actiongraphlong{(\sigmaE)}{E}
\ar@{_{(}->}|w_{\actionembemblong{\sigma_G}{(gf)}}[rr]
\ar@{^{(}->}|w^(0.4){\actionembemblong{(\actionembactionlong{\sigma_G}{g})}{f}}[uur]
&  & \actiongraphlong{\sigma_G}{G} \\
}\end{equation*}\end{minipage}}\end{minipage}}
\caption{Commutative diagrams that describe the compatibility between the application of transformations between site graphs and the composition of weak embeddings.}
\label{fig:ditributivitycomposition}
\end{figure}

In particular, whenever the restriction of transformations over site graphs to the domain of weak embeddings distributes over the composition of weak embeddings, one can safely apply a transformation over a commutating square of weak embeddings as showed in the following Lemma.
\begin{lemma}
\label{image:square:we}
Let $\groupset$ be a set of transformations over site graphs such that the restriction of the transformations in $\groupset$ to the domain of weak embeddings, distributes over the composition of these weak embeddings.
Let $E$, $F$, $F'$ and $G$ be four site graphs, and
$f\;:\;E\rlongweakembedding F$, $f'\;:\;E\rlongweakembedding F'$, $g\;:\;F\rlongweakembedding G$, and $g'\;:\;F'\rlongweakembedding G$ be four weak embeddings such that:
$gf=g'f'$, as depicted in the following commutative diagram:
\squareweakembedding{E}{F}{F'}{G}{f}{f'}{g}{g'}

Let $\sigma_G\in\groupset[G]$ be a transformation that can be applied to the site graph $G$.

Under these assumptions, we have:
\begin{equation*}
\actioncomposeweakemblong{\sigma_G}{g}{f}=\actioncomposeweakemblong{\sigma_G}{g'}{f'},
\end{equation*}
as depicted in the following commutative diagram:
\imagesquareweakembedding{\sigma_G}{E}{F}{F'}{G}{f}{f'}{g}{g'}
\end{lemma}

Now we introduce some additional constraints so as to ensure that the transformations between site graphs preserve the basic objects of our semantics.

Since fully specified site graphs are key elements in the definition of the states of the semantics. We have to assume that the image of a fully specified site graph by a transformation over site graphs is a fully specified site graph which is the goal of the following definition.
\begin{definition}[preservation of fully specified site graphs]
\label{def:permutation:mixtures}
Let $\groupset{}$ be a set of transformations over site graphs.
We say that \emph{the transformations} in $\groupset{}$ \emph{preserve fully specified site graphs}, if and only if, for any fully specified site graph $E$ and any transformation $E\in\group[E]{}$ that can be applied to the site graph $E$,  the site graph  $\actiongraphlong{\sigma_E}{E}$ is fully specified as well.
\end{definition}


Embeddings are crucial as well in the definition of computation steps, and we have to assume that the image of an embedding by a transformation over site graphs is an embedding as well, which is the purpose of the following definition.
\begin{definition}[preservation of embeddings]
\label{def:permutation:embeddings}
Let $\groupset{}$ be a set of transformations over site graphs.
We say that \emph{the transformations} in  $\groupset{}$ \emph{preserve embeddings}, if and only if, for any embedding $f$ and any transformation $\sigma_{\im(f)}\in\group[{\im(f)}]{}$ that can be applied to the embedding $f$, the weak embedding $\actionembemblong{\sigma_{\im(f)}}{f}$ is an embedding as well.
\end{definition}



We can simultaneously apply a pair of transformations to the left hand side and  to the right of side of a partial embedding $\phi$, providing that these transformations  have the same restriction over the domain of the partial embedding. Yet, it is important that the set of pairs of transformations that can be applied to a partial embedding, forms a group. That is why we assume in the following definition, that the set of pairs of transformations that can be applied to a given partial embedding is stable upon pairwise product.
\begin{definition}[composition of the pairs of transformations over site graphs, that can be applied to a partial embedding]
\label{def:permutation:paircompose}\newcommand{\equconstraint}[2]{\actionembactionlong{#1}{h_L}=\actionembactionlong{#2}{h_R}}
Let $\groupset{}$ be a set of transformations over site graphs.
We say that \emph{the pairs of the transformations} in $\groupset{}$ \emph{that can be applied to partial embeddings compose pairwise}, if and only if, for any partial embedding \begin{equation*}L \llongembedding[h_L] D \rlongembedding[h_R] R,\end{equation*} any four transformations  $\sigma_L\in\group[L]{}$, $\sigma'_L\in\group[L]{}$, $\sigma_R\in\group[R]{}$, and $\sigma'_R\in\group[R]{}$ over site graphs, such that $\equconstraint{\sigma_L}{\sigma_R}$ and $\equconstraint{\sigma'_L}{\sigma'_R}$, we have
$\equconstraint{(\sigma'_L\circ_L\sigma_L)}{(\sigma'_R\circ_R\sigma_R)}$.
\end{definition}

Whenever in a set of transformations, the restriction of transformations to the domain of weak embeddings distributes over both the product between these transformations and the composition between embeddings (\eg~see Def.~\ref{defn:compositiondistributeoversymetries}) and Def.~\ref{defn:symetriesdistributeovercomposition}), the fact that the pairs of the transformations that can be applied to partial embeddings compose pairwise, is equivalent to two
 simpler alternative properties, which are given in the next proposition.

\begin{prop}\label{thm:morphism}
Let $\groupset{}$ be a set of transformations over site graphs.
We assume that the restriction of the transformations in $\groupset$ to the domain of weak embeddings distributes both over the product between these transformations ({\eg}see \ref{defn:compositiondistributeoversymetries}) and over the composition of weak embeddings ({\eg}see Def.~\ref{defn:symetriesdistributeovercomposition}).

Under this assumption, the following three assertions are equivalent:
 \begin{enumerate}
\item The pairs of transformations in $\groupset{}$ that can be applied to partial embeddings compose pairwise (eg.~see Def.~\ref{def:permutation:paircompose}).
\item For any two site graphs $E$ and $F$, and any embedding $f$ between the site graph $E$ and $F$, any two transformations $\sigma_F,\sigma'_F\in\groupset[F]$ that can be applied to the site graph $F$, we have: $\actionembactionlong{(\sigma'_F\circ_F\sigma_F)}{f}=(\actionembactionlong{\sigma'_F}{f})\circ_E (\actionembactionlong{\sigma_F}{f})$.
\item For any two site graphs $E$ and $F$, and any embedding $f$ between the site graph $E$ and $F$, any two transformations $\sigma_F,\sigma'_F\in\groupset[F]$ that can be applied to the site graph $F$, we have: $\actionembactionlong{\sigma_F}{(\actionembemblong{\sigma'_F}{f})}=\actionembactionlong{\sigma_F}{f}$.
\end{enumerate}
\end{prop}

In Prop.\ref{thm:morphism}, the second assertion can be interpreted as the fact that each embedding $f\;:\;E\rlongembedding\!F$ between two site graphs $E$ and $F$, the function that maps eash transformation $\sigma_F\in\groupset[F]$ that can be applied to the site graph $F$, into the transformation $\actionembactionlong{\sigma_F}{f}\in\groupset[E]$ is a morphism between the group $\groupset[F]$ of the transformations that can be applied to the site graph $F$ and the group $\groupset[E]$ of the transformations that can be applied to the site graph $E$; the third assertion can be interpreted as the fact that for any embedding $f\;:\;E\rlongembedding\!F$ between two site graphs $E$ and $F$ and any transformation $\sigma_F$ that can be applied to the site graph $F$, then the embedding $f$ and its image $\actionembemblong{\sigma_F}{f}$ by the transformation $\sigma_F$ operates the same way with the group $\groupset[F]$ of the transformations that can be applied to the site graph $F$.

We introduce explicitly these two new notions is the following definitions.

\begin{definition}[morphism induced by an embedding]
\label{def:morphism}
Let $\groupset$ be a set of transformations over site graphs and $f\;:\;E\rembedding[]\!F$ be an embedding between two site graphs $E$ and $F$.
We say that \emph{the embedding} $f$ \emph{induces a morphism} between the group of the transformations $\groupset[F]$ that can be applied to the site graph $F$ and the group of
the transformations $\groupset[E]$ that can be applied to the site graph $E$, if and only if, the function $h_f$ between the group $\groupset[F]$ and the group  $\groupset[E]$, mapping each transformation  $\sigma_F\in\groupset[F]$ into the transformation $\actionembactionlong{\sigma_F}{f}$,  is a morphism.
\end{definition}

\begin{definition}[invariance of the action on an embedding over transformations]
\label{def:sameaction}
Let $\groupset$ be a set of transformations over site graphs.
An \emph{embedding} $f\;:\;E\rembedding\!F$ between two site graphs $E$ and $F$
\emph{operates the same way over the transformations} which can be applied to the site graph $F$, \emph{as any of its image} by such a transformation
if and only if for any pair of transformations $(\sigma,\sigma')\in \groupset[F]^2$ that can be applied to the site graph $F$, we have: $\actionembactionlong{\sigma}{(\actionembemblong{\sigma'}{f})}=\actionembactionlong{\sigma}{f}$.
\end{definition}


Lastly, we have to assume that the image of a rule by a transformation over site graphs,  is a rule and that transformations over site graphs, preserve the existence of refinements. This is the purpose of the next two definitions.
\begin{definition}[preservation of rules]
\label{def:permutation:rule}Let $\groupset{}$ be a set of transformations over site graphs.
We say that \emph{the transformations} in $\groupset{}$ \emph{preserve rules}, if and only if, for any rule \begin{equation*}L \lvlongembedding[h_L] D \rlongembedding[h_R] R\end{equation*} and any pair of transformations $(\sigma_L,\sigma_R)\in\group[L]{}\times\group[R]{}$ that can be applied respectively to the left hand side $L$ of the rule and to the right hand $R$ side of this rule and such that $\actionembactionlong{\sigma_L}{h_L}=\actionembactionlong{\sigma_R}{h_R}$,
the partial embedding \begin{equation*}\actiongraphlong{\sigma_L}{L} \lvlongembedding[\actionembemblong{\sigma_L}{h_L}]
\actiongraphlong{(\actionembactionlong{\sigma_L}{h_L})}{D}
\rvlongembedding[\actionembemblong{\sigma_R}{R}] \actiongraphlong{\sigma_R}{R}\end{equation*} is a rule as well.
\end{definition}


\begin{definition}[preservation of the existence of refinements]
\label{def:permutation:pushout}Let $\groupset{}$ be a set of transformations over site graphs  that preserve rules, we say that \emph{the transformations} in $\groupset{}$ \emph{preserve the existence of refinements} as well, if and only if,  for any rule
\begin{equation*}r\;:\;L \llongembedding[h_L] D \rlongembedding[h_R] R,\end{equation*}  for any embedding $h_{L'}$ between the site graphs $L$ and a site graph $L'$, and any pair of transformations over site graphs $(\sigma_{L'},\sigma_R)\in\groupset[L']\times\groupset[R]$ that can be applied respectively to the site graph $L'$ and to the site graph $R$,  such that:
\begin{enumerate}
\item $\actionembactionlong{\sigma_{L'}}{(h_{L'} h_L)} =
\actionembactionlong{\sigma_R}{h_R}$, \item there exist a rule $r'$ and an embedding  $h_{R'}$ such that the tuple $(r,r',h_{L'},h_{R'})$ is a refinement,  \end{enumerate}
there exist a rule $r'_{\sigma}$ and an embedding $h_{R'_{\sigma}}$ such that the tuple $(r_{\sigma},r'_{\sigma},\actionembemblong{\sigma_{L'}}{h_{L'}},h_{R'_{\sigma}})$ is a refinement as well, where the $r_{\sigma}$ is defined as the rule:
$\actiongraphlong{(\actionembemblong{\sigma_{L'}}{h_{L'}})}{L}
\lvvvlongembedding[\actionembemblong{(\actionembactionlong{\sigma_{L'}}{h_{L'}})}{h_L}]
\actiongraphlong{(\actionembactionlong{\sigma_R}{h_R})}{D}\rvvvlongembedding[\actionembemblong{\sigma_R}{h_R}]
\actiongraphlong{\sigma_R}{R}$.
\end{definition}


We are now ready to define the valid sets of transformations over site graphs as those which satisfy the additional assumptions that we have given in Definitions \ref{defn:compositiondistributeoversymetries}--\ref{def:permutation:pushout}.
\begin{definition}[valid set of transformations over site graphs]
\label{def:validpermutation}
We say that a set of transformations $\groupset{}$ over site graphs is \emph{valid}, if and only if, \begin{enumerate}
\item \label{itema} the transformations in $\groupset{}$ distribute over the composition of weak embeddings;
\item \label{itemb} the restriction of the transformations in $\groupset{}$ to the domain of weak embeddings distributes over the product between these transformations;
\item the transformations over site graphs, in $\groupset{}$, preserve fully specified site graphs;
\item the transformations over site graphs, in $\groupset{}$, preserve embeddings;
\item \label{iteme}the pairs of transformations over site graphs, in $\groupset{}^2$ that can be applied to partial embeddings compose pairwise;
\item \label{itemf} each embedding between two site graphs induces a morphism between the group of the transformations that can be applied to the image of this embedding, and the group of the transformations that can be applied to the domain of this embedding;
\item \label{itemg} each embedding operates the same way over the transformations that can be applied to its image, as any of its image by such a transformation;
\item the transformation over site graphs, in $\groupset{}$, preserve rules;
\item the transformation over site graphs, in $\groupset{}$, preserve the existence of refinements.    \end{enumerate}
\end{definition}

As noticed in Prop.~\ref{thm:morphism}, whenever the conditions  \ref{itema} and \ref{itemb} in Thm.\ref{def:validpermutation} are satisfied, the conditions \ref{iteme}, \ref{itemf}, and \ref{itemg} are equivalent. Thus in order to prove that a set of transformations is valid, it is not necessary to prove all of the three properties \ref{iteme}, \ref{itemf}, and \ref{itemg} (only one among them is enough).

Looking at our favorites examples of set of transformations over site graphs,
we can check that the sets of transformations  $\groupsetone$ and $\groupsettwo$  that we have introduced in Exa.~\ref{exmp:siteswap} and in Exa.~\ref{exmp:siteswapbis} are both valid. Moreover, there is no need to check the assumptions of Def.~\ref{def:validpermutation}  for proving that the set $\groupsettwo$ of homogeneous permutations of sites is valid, since in a subset of transformations over site graphs, these assumptions follow from the overlying structure.

\begin{example}
The set  $\groupsetone$ of the heterogeneous permutations of sites (see Exa.~\ref{exmp:siteswap}) is a valid set of symetries.
\end{example}

\begin{prop}
\label{validinherit}
A subset of a valid set transformations over site graphs is a valid set of transformations over site graphs,  as well.
\end{prop}

\begin{example}
As a direct consequence of Prop.~\ref{validinherit}, the set $\groupsettwo$ of the homogeneous permutations of sites (see Exa.~\ref{exmp:siteswapbis}) is a valid set of transformations over site graphs.
\end{example}

\subsection{Induced group actions}

A valid set of transformations over site graphs induces group actions over the basic elements of the semantics of Kappa. We are going to itemise them in  this subsection.

\subsubsection{Induced group action over fully specified site graphs}

Def.~\ref{def:permutation:mixtures} ensures that the image of a fully specified site graph by a transformation within a valid set of transformations over site graphs  is a fully specified site graph. Thus, by Def.~\ref{def:inducedgroupaction}, the group action of a valid set of transformations over site graphs induces another group action over fully specified site graphs, as written in the following proposition.

\begin{prop}[action of transformations over fully specified site graphs]
Let $\groupset{}$ be a valid set of transformations over site graphs.
For a given fully specified site graph $E$, the function mapping each pair $(\sigma'_E,E')\in \group[E]{} \times \{\actiongraphlong{\sigma}{E}\;|\;\sigma\in\group[E]{}\}$ to the fully specified site graph $\actiongraphlong{\sigma'_E}{E'}$, is a group action.
\end{prop}

\subsubsection{Induced group action  over embeddings}

\paragraph{Applying transformations to embeddings.}

Def.~\ref{def:permutation:embeddings} ensures that the image of an embedding, by a transformation  in a valid set of transformations over site graphs, is always an embedding.  Thus,  by Def.~\ref{def:inducedgroupaction}, in a valid set of transformations over site graphs, the group action of transformations over weak embeddings induces another group action over embeddings, as written in the following proposition.

\begin{prop}[action of transformations over  embeddings]
Let $\groupset{}$ be a valid set of transformations over site graphs.
For a given embedding $f$ between two site graphs $E$ and $F$, the function mapping each pair $(\sigma'_{F},f')\in \group[F]{} \times \{\actionembemblong{\sigma}{f}\;|\;\sigma\in\group[F]{}\}$ to the embedding
$\actionembemblong{\sigma'_F}{f'}$, is a group action.
\end{prop}

\paragraph{Extending a transformation over the domain of an embedding.}

In Def.~\ref{defn:permutation}, we have assumed  that we can always restrict a transformation that can be applied to the image of a weak embedding into a transformation that can be applied to the domain of this weak embedding.
Yet, for the sake of generality, we have not assumed that the converse operation is possible:  it is not always possible to extend a transformation that can be applied to the domain of a weak embedding to a transformation that can be applied to the image of this weak embedding (\eg see Fig.~\ref{fig:for-counter} for a counter example).
Now we focus on the case of embeddings: given a set $\groupset$ of transformations over site graphs, we say that a given embedding $f$ is $\groupset[]$-compatible if and only if any transformation that can be applied to the domain of the embedding $f$ can be extended into a transformation that can be apply to the image of the embedding $f$.
Notice that we could have defined the notion of compatible weak embedding the same way, but we will not use this notion in the following.

\begin{definition}[compatible embedding]
\label{def:compatible}
Let $\groupset[]$ be a set of transformations  over site graphs and $f\,:\,E\rembedding[]\!F$ be an embedding between two site graphs $E$ and $F$. We say that the embedding $f$ is $\groupset[]$-compatible if and only if for any transformation $\sigma_E\in\groupset[E]$, there exists a transformation  $\sigma_F\in\groupset[F]$ such that $\actionembactionlong{\sigma_F}{f}=\sigma_E$.
\end{definition}


\begin{figure*}[p]
\subfigure[With heterogenous permutations of sites $\groupsetone$, a transformation over the domain of an embedding can always be extended into a transformation over the image of this embedding.]{%
\begin{minipage}{0.45\linewidth}
\label{fig:for-example}
\incgraphics[\linewidth]{generated_pictures/sym_4_17a.pdf}

\vspace*{-5.2cm}

\hspace*{2.5cm}\textcolor{red}{$\permutbis$}

\vspace*{3.4cm}

\hspace*{2.5cm}$\permut$

\vspace*{0.5cm}\mbox{}
\end{minipage}}\hfill
\subfigure[With homogeneous permutations of sites $\groupsettwo$, it is not always possible to extend a transformation over the domain of an embedding into a transformation over the image of this embedding.]{%
\begin{minipage}{0.45\linewidth}
\label{fig:for-counter}
\incgraphics[\linewidth]{generated_pictures/sym_4_17b.pdf}

\vspace*{-5.2cm}

\hspace*{2.5cm}\textcolor{red}{$\permutbis$}

\vspace*{3.4cm}

\hspace*{2.5cm}$\permut$

\vspace*{0.5cm}\mbox{}
\end{minipage}}
\caption{An example of an embedding which is $\groupsetone$-compatible ({\ie}each heterogeneous permutation of sites, as defined  in Exa.~\ref{exmp:siteswap},  that can be applied to its domain can be extended into an heterogeneous permutation of sites that can be applied to its image), but not $\groupsettwo$-compatible ({\ie}there exists some homogeneous permutations of sites, as defined in Exa.~\ref{exmp:siteswapbis}). We take the site graph that is made of  two agents of type \agentfont{A} with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated, the embedding that adds a site \sitefont{z} to both of these agents and binds these two sites \sitefont{z} together,  hence merging the two connected components of the site graph, and the transformation that swaps the state of the sites \sitefont{x} and \sitefont{y} of the agent on the right.
With heterogeneous permutations of sites, permutations can be chosen independently for each agent, no matter they belong, or not, to the same connected component.
Thus, the transformation that is applied to the domain of the embedding can be extended into a transformation that can be applied to the image of the embedding, as shown in Fig.~\ref{fig:for-example}. With homogeneous permutations, for each connected components, the same permutation must be applied to all the agents with a same type in a that connected component. Since the two connected components of the initial site graphs have been merged,  it is no longer possible to swap the state of the sites \sitefont{x} and \sitefont{y} in the agent on the right, without  swapping those of the agent on the left. Thus it is impossible to extend the transformation that is applied to the domain of the embedding into a transformation that is applied to the image of the embedding, as shown in Fig.~\ref{fig:for-counter}.
}
\label{fig:for-example-counter-example}\end{figure*}
\begin{figure*}[p]
\subfigure[]{%
\begin{minipage}{0.45\linewidth}
\label{fig:for-exampleone}
\incgraphics[\linewidth]{generated_pictures/sym_4_17c.pdf}

\vspace*{-5.2cm}

\hspace*{2.5cm}\textcolor{red}{$\permutbis$}

\vspace*{3.4cm}

\hspace*{2.5cm}$\permut$

\vspace*{0.5cm}\mbox{}
\end{minipage}}\hfill
\subfigure[]{%
\begin{minipage}{0.45\linewidth}
\label{fig:for-exampletwo}
\incgraphics[\linewidth]{generated_pictures/sym_4_17d.pdf}

\vspace*{-5.2cm}

\hspace*{2.5cm}\textcolor{red}{$\permutbis$}

\vspace*{3.4cm}

\hspace*{2.5cm}$\permut$

\vspace*{0.5cm}\mbox{}
\end{minipage}}
\caption{An example of transformation that can be applied to the domain of an embedding and which can be extended into a transformation that can be applied to the image
of this embedding in various ways.  We consider a single agent of type \agentfont{A} with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated. We consider the transformation in $\groupsetone$ which consists in swapping the state of the sites \sitefont{x} and \sitefont{y} of the unique agent of this site graph.
Then we introduce  the embedding that adds a site \sitefont{z} to this agent and binds it to the site \sitefont{z} of a new agent of type \agentfont{A} also with the site \sitefont{x} unphosphorylated and the site \sitefont{y}Â phosphorylated.
When we extend the transformation to the image of the embedding, we have to swap the state of the sites \sitefont{x} and \sitefont{y} of the agent on the right, since it is the image of the unique agent of the domain of the embedding. But for the agent on the left, we are free to swap, or not, the state of these sites, which gives two potential extensions of the embedding: in Fig.~\ref{fig:for-exampleone}, we have swapped the states of the sites \sitefont{x} and \sitefont{y},Â whereas in Fig.~\ref{fig:for-exampletwo}, we leave them unchanged.}
\label{fig:twoways}
\end{figure*}


\begin{example}\label{exmp:for-example}
We consider the set $\groupsetone[]$ of heterogeneous permutations of site (as defined in Exa.~\ref{exmp:siteswap}). It turns out that every embedding is $\groupsetone[]$-compatible. Indeed, let us consider $f$ an embedding $E{\rembedding}\!F$ between two site graphs $E$ and $F$, and $\sigma_E$ be a symetry in $\groupsetone[E]$. With our notations, the symetry $\sigma_E$ is encoded as a subset of $\agents[E]$. Then, the symetry $\sigma_F\in\groupsetone[F]$ that is defined as the set $\{f(a)\;|\; a\in\sigma_E\}$ satisfying the property: $\actionembactionlong{\sigma_F}{f}=\sigma_E$.

We illustrate this on a particular example in Fig.~\ref{fig:for-example}.
We take the same signature as in Exa.~\ref{exmp:siteswap} and we consider two site graphs.
The first one:
\begin{equation*}
E \bydef \text{\agent{A$_1$}{\site{x}{u}{}\sitesep\site{y}{p}{}}\agentsep\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}}}
 \end{equation*}
is made of two agents of type \agent{A}{} with labels $1$ and $2$ and  with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated. Their sites \sitefont{z} are not documented. The second one:
\begin{equation*}
F \bydef \text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}\end{equation*}
is made of two agents of type \agent{A}{} with label $3$ and $4$, with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated, and bound together via their respective site \sitefont{z}.

The site graph $E$ can be embedded in the site graph $F$ by the following embedding:
\begin{equation*}
f\bydef [(\text{\agent{A}{}},1)\mapsto 3, (\text{\agent{A}{}},2)\mapsto 4].
\end{equation*}

Now we apply the permutation $\{2\}\in\groupsetone[E]$ to the site graph $E$. This permutation consists in swapping the state of the site \site{x}{}{} and \site{y}{}{} in the agent of $E$ with the label $2$. Thus we get the following site graph:
\begin{equation*}
\actiongraphlong{\{2\}}{E}=\text{\agent{A$_1$}{\site{x}{u}{}\sitesep\site{y}{p}{}}\agentsep\agent{A$_2$}{\site{x}{p}{}\sitesep\site{y}{u}{}}}.
\end{equation*}

We would like to extend the permutation $\{2\}$ to the image $F$ of the embedding $f$. Since each agent of $F$ is the image of an agent of $E$, we have no choice:
we have to permute the states of the sites \site{x}{}{} and \site{y}{}{} of the agent with the label $4$, since it is the image of the agent with the label $2$ and because the label $2$ belongs to the set $\{2\}$; and we have to keep the
states of the sites \site{x}{}{} and \site{y}{}{} of the agent with the label $3$, since it is the image of the agent with the label $1$ and because the label $1$ does not belong to the set $\{2\}$.  Thus, we get the permutation $\{4\}\in\groupsetone[F]$ which transform the site graph $F$ into the following site graph:
\begin{equation*}
\actiongraphlong{\{4\}}{F}=\text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{p}{}\sitesep\site{y}{u}{}\sitesep{z}{}{\boundto{A}{3}{z}}}}.
\end{equation*}
The image of the embedding $f$ by the permutation $\{4\}$ is defined by the same mapping as the embedding $f$:
\begin{equation*}
\actionembemblong{\{4\}}{f} = [(\text{\agent{A}{}},1)\mapsto 3, (\text{\agent{A}{}},2)\mapsto 4].
\end{equation*}
We can check that $\actionembemblong{\{4\}}{f}$ is indeed an embedding between the site graph $\actiongraphlong{\{2\}}{E}$ and the site graph $\actiongraphlong{\{4\}}{F}$.
\end{example}


\begin{example}
\label{exa:subset}
Now we consider the set of homogeneous (as defined in Exa.~\ref{exmp:siteswapbis}), we notice that there exists embeddings which are not $\groupsettwo[]$-compatible.

A counter example is given in Fig.~\ref{fig:for-counter}.
We consider the same graphs $E$ and $F$ and the same embedding $f$ as in Exa.~\ref{exmp:for-example}.
But now we see the transformation $\{2\}$ as an element of set $\groupsetbis[E]$ of the homogeneous permutations of sites, that can be applied to the site graph $E$.

We want to extend the transformation $\{2\}$ to a permutation of sites that can be apply to the image $F$ of the embedding $f$.
As it was the case for the heterogeneous permutations of site (see Exa.~\ref{exmp:for-example}), if such a permutation of site were existing, it would necessarily swap the states of the site \sitefont{x} and \sitefont{y} of the agent with the label $4$ and necessarily leave the states of these sites unchanged in the agent with the label $3$.
Yet, the agents with the labels $3$ and $4$ belongs to the same connected component in the site graph $H$, thus an homogeneous permutation that can be applied to the site graph $F$ either swap the states of the sites \sitefont{x} and \sitefont{y} both in the agents with labels $3$ and $4$, or leave the states of these four sites unchanged.
As a consequence, there is no homogenous permutation of sites which extend the permutation $\{2\}$ that can be applied to domain $E$ of the embedding $f$, into an homogeneous permutation of sites which can be applied to image $H$ of the embedding $f$.
\end{example}

We have seen in Exa.~\ref{exa:subset} that the fact that an embedding is compatible with a set of symetries, does not entail that  this embedding is compatible with a subset of this set of symetries.

In general, the extension of a transformation that can be applied to the domain of an embedding into a transformation that can be applied to the image of an embedding, if it exists, is not unique. We give in Exa.~\ref{exmp:twoways}, an example in which there exists two distinct ways to extend such a transformation.

\begin{example}\label{exmp:twoways}
We show in Fig.~\ref{fig:twoways} such an example of a transformation that can be applied to the domain of an embedding which can be extended into two distinct transformations that can both be applied to the image of this embedding.

We take the same signature as in Exa.~\ref{exmp:siteswap} and we consider two site graphs.
The first one:
\begin{equation*}
G \bydef \text{\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}}}
 \end{equation*}
is made of one agent of type \agent{A}{} with label $2$ and  with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated. Its site \sitefont{z} is not documented. The second one:
\begin{equation*}
H \bydef \text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}\end{equation*}
is made of two agents of type \agent{A}{} with label $3$ and $4$, with a site \sitefont{x} unphosphorylated and a site \sitefont{y} phosphorylated, and bound together via their respective site \sitefont{z}.

We consider the following embedding $g$ between the site graphs $G$ and $H$,
\begin{equation*}
g\bydef [(\text{\agent{A}{}},2)\mapsto 4],
\end{equation*}
which maps the unique agent of the site graph $G$ to the agent with the label $4$ in the site graph $H$.

Now we apply the permutation $\{2\}\in\groupsetone[G]$ to the site graph $G$. This permutation consists in swapping the state of the site \site{x}{}{} and \site{y}{}{} in the unique agent of the site graph $G$. Thus we get the following site graph:
\begin{equation*}
\actiongraphlong{\{2\}}{G}=\text{\agent{A$_2$}{\site{x}{p}{}\sitesep\site{y}{u}{}}}.
\end{equation*}

We would like to extend the permutation $\{2\}$ to the image $H$ of the embedding $g$.
The agent with the label $4$ in the site graph $H$, is the image of the unique agent of the site graph $G$.
Thus, if it exists, our new transformation has to swap the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $4$ in the site graph $H$.
But for the agent with the label $3$, we are not constrained, because it is the image of no agent of the site graph $G$.  Thus, either we swap also the states of the sites \sitefont{x} and \sitefont{y} of the agent of the site graph $H$ with the label $3$ (\eg see Fig.~\ref{fig:for-exampleone}):
\begin{equation*}
\actiongraphlong{\{3,4\}}{H}=\text{\agent{A$_3$}{\site{x}{p}{}\sitesep\site{y}{u}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{p}{}\sitesep\site{y}{u}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}
\end{equation*}
or we keep the states of these sites unchanged (\eg see Fig.~\ref{fig:for-exampletwo}):
\begin{equation*}
\actiongraphlong{\{4\}}{H} = \text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{p}{}\sitesep\site{y}{u}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}.
\end{equation*}
\end{example}


\paragraph{Decomposing a set of transformations  along an embedding.}


In a valid set of transformations, an embedding $f$ between two site graphs $E$ and $F$ induces a morphism between the group of the transformations $\groupset[F]$ that can be applied to the image $F$ of the embedding $f$, and the group of the transformations $\groupset[E]$ that can be applied to the domain $E$ of the embedding $f$ ({\eg}see Def.~\ref{def:morphism}). Thanks to this property, we can properly decompose the group of transformations that can be applied to the image of an embedding into two subgroups, by applying the first isomorphism theorem ({\eg}see Thm.\ref{firstiso}).
\begin{theorem}
\label{symdecomp}Let $\groupset$ be a set of transformations over site graphs and $f$ be an embedding between two site graphs $E$ and $F$.

Then three assertions are satisfied:
\begin{enumerate}
\item The set \begin{equation*}\{\actionembactionlong{\sigma_F}{f}\;|\;\sigma_F\in\groupset[F]\}\end{equation*} and the set \begin{equation*}\groupset[F]\setminus \{\sigma_F\in\groupset[F]\;|\; \actionembactionlong{\sigma_F}{f} = \varepsilon_E\}\end{equation*} are two isomorphic groups.
\item The number of transformations in the group $\groupset[F]$ is equal to the product between the cardinal of the group \begin{equation*}\{\actionembactionlong{\sigma_F}{f}\;|\;\sigma_F\in\groupset[F]\}\end{equation*} and the cardinal of the group \begin{equation*}\{\sigma\in\groupset[F]\;|\;\actionembactionlong{\sigma}{f}=\varepsilon_E\};\end{equation*}
\item For any transformation  $\sigma_E\in\groupset[E]$, the set \begin{equation*}\{\sigma_F\in\groupset[F]\;|\;\actionembactionlong{\sigma_G}{f}=\sigma_E\}\end{equation*}
 is either empty, or of the form: \begin{equation*}\{\sigma_F\circ_F\sigma'_F\;|\;\sigma'_F\in\groupset[F] \suchthat \actionembactionlong{\sigma'_F}{f}=\varepsilon_{\groupset[E]}\},\end{equation*} for a given transformation $\sigma_G\in\groupset[G]$.
\end{enumerate}
\end{theorem}

In Thm.~\ref{symdecomp}, the group $\{\actionembactionlong{\sigma_F}{f}\;|\; \sigma_F\in\groupset[F]\}$ denotes the set of the transformations  that can be applied to the domain $E$ of the embedding $f$ and that can be extended to transformations over the image $F$ of the embedding $f$, whereas the group $\{\sigma_F\in\groupset[F]\;|\; \actionembactionlong{\sigma_F}{f}=\varepsilon_E\}$ is the kernel of morphism $h_f$ that is induced by the embedding $f$ and denotes the set of transformations  over the image $F$ of the embedding $f$ that do not modify the domain $E$ of the embedding $f$ (when we restrict this transformation to the domain $E$ of the embedding $f$).

Now we illustrate the usefulness of Thm.\ref{symdecomp}, by applying it to the embedding $f$ between the site graphs $E$ and $F$ that we had introduced in Exa.~\ref{exmp:for-example} (\eg see Fig.~\ref{fig:for-example-counter-example})
and to the embedding $g$ between the site graphs $G$ and $H$ that we had introduced in Exa.~\ref{exmp:twoways} (\eg see Fig.~\ref{fig:twoways}). For each of these two embeddings, we use Thm.~\ref{symdecomp} to decompose the set of the heterogeneous (resp.~homogeneous) permutations of sites $\groupsetone$ (resp.~$\groupsettwo$) that can be applied to the image of this embedding.

\newcommand{\gonef}{$\groupsetone[F]$}
\newcommand{\goneh}{$\groupsetone[H]$}
\newcommand{\gtwof}{$\groupsettwo[F]$}
\newcommand{\gtwoh}{$\groupsettwo[H]$}

\newcommand{\graphE}{\text{\agent{A$_1$}{\site{x}{u}{}\sitesep\site{y}{p}{}}\agentsep\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}}}}
\newcommand{\graphF}{\text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}}
\newcommand{\graphG}{\text{\agent{A$_2$}{\site{x}{u}{}\sitesep\site{y}{p}{}}}}
\newcommand{\graphH}{\text{\agent{A$_3$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}\agentsep\agent{A$_4$}{\site{x}{u}{}\sitesep\site{y}{p}{}\sitesep\site{z}{}{\boundto{A}{3}{z}}}}}

\begin{example}[Decomposition of the group \gonef]
We consider the site graphs:
\begin{equation*}
E\bydef\graphE
\end{equation*} and
\begin{equation*}F\bydef\graphF,\end{equation*} and the embedding: \begin{equation*}f\bydef[(A,1)\mapsto 3,(A,2)\mapsto 4],\end{equation*} as in Exa.~\ref{exmp:for-example} (also see Fig.~\ref{fig:for-example-counter-example}).
A heterogeneous permutations of sites which can be applied to the site graph $F$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $3$, and in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $4$.
Thus we have:
\begin{equation*}
\groupsetone[F]=\wp(\{3,4\}).
\end{equation*}
The same way, a heterogeneous permutations of sites which can be applied to the site graph $E$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $1$, and in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $2$.
Thus we have:
\begin{equation*}
\groupsetone[E]=\wp(\{1,2\}).
\end{equation*}
We have seen in Exa.~\ref{exmp:for-example}, that any embedding is $\groupsetone$-compatible, so the embedding $f$ is $\groupsetone$-compatible and any transformation in $\groupsetone[E]$ can be extended into a transformation that can be applied to the site graph $F$.

By applying Thm.~\ref{symdecomp}, since both the sets $\groupsetone[F]$ and $\{\actionembactionlong{\sigma_F}{f}\;|\;\sigma_F\in\groupsetone[F]\}$ have four elements, we can deduce that the set $\{\sigma_F\in\groupsetone[F] \;|\;\actionembactionlong{\sigma_F}{f}=\emptyset\}$ contains only the identity element $\emptyset$ (which is actually the case).
\end{example}



\begin{example}[Decomposition of the group \goneh]
We consider the site graphs:
\begin{equation*}
G\bydef\graphG
\end{equation*} and
\begin{equation*}H\bydef\graphH,\end{equation*} and the embedding: \begin{equation*}g\bydef[(A,2)\mapsto 4],\end{equation*} as in Exa.~\ref{exmp:twoways} (also see Fig.~\ref{fig:twoways}).
A heterogeneous permutations of sites which can be applied to the site graph $H$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $3$, and in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $4$.
Thus we have:
\begin{equation*}
\groupsetone[H]=\wp(\{3,4\}).
\end{equation*}
Beside, a heterogeneous permutation of sites which can be applied to the site graph $G$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $2$.
Thus we have:
\begin{equation*}
\groupsetone[G]=\{\emptyset,\{2\}\}.
\end{equation*}
We have seen in Exa.~\ref{exmp:for-example}, that any embedding is $\groupsetone$-compatible, so the embedding $g$ is $\groupsetone$-compatible and any transformation in $\groupsetone[G]$ can be extended into a transformation that can be applied to the site graph $H$. Thus the set $\{\actionembactionlong{\sigma_H}{g}\;|\;\sigma_H\in\groupsetone[H]\}$ has two elements. Since  the set $\groupsetone[H]$ has four elements and the set $\{\actionembactionlong{\sigma_H}{g}\;|\;\sigma_H\in\groupsetone[H]\}$ has two elements,
we can deduce from  Thm.~\ref{symdecomp} that the set $\{\sigma_H\in\groupsetone[H] \;|\;\actionembactionlong{\sigma_H}{g}=\emptyset\}$ has two elements. Indeed, the set $\{\sigma_H\in\groupsetone[H] \;|\; \actionembactionlong{\sigma_H}{g}=\emptyset\}$ contains exactly the permutations of sites that leave unchanged all the agents in the image of the domain of the embedding $g$, that is to say the permutation $\emptyset$ and the permutation $\{3\}$.

Said differently, we can use the embedding $g$ to decompose the set $\groupsetone[H]$ into the subgoup $\{\emptyset,\{3\}\}$ that contains all the heterogeneous permutations of sites  which do not change the agent that are in the image of $G$ by the embedding $g$, and a subgroup that is isomorphic to the subgroup $\{\emptyset,\{2\}\}$ that contains all the heterogeneous permutations of sites which can be applied to the domain $G$ of the embedding.
\end{example}

\begin{example}[Decomposition of the group \gtwof]
We consider the site graphs:
\begin{equation*}
E\bydef\graphE
\end{equation*} and
\begin{equation*}F\bydef\graphF,\end{equation*} and the embedding: \begin{equation*}f\bydef[(A,1)\mapsto 3,(A,2)\mapsto 4],\end{equation*} as in Exa.~\ref{exmp:for-example} (also see Fig.~\ref{fig:for-example-counter-example}).
A homogeneous  permutation of sites which can be applied to the site graph $F$ consists either in swapping the states of the sites \sitefont{x} and \sitefont{y} in both agents of the site graph $F$, or in leaving the site graph $F$ unchanged, because these agents belongs to a same connected component.
Thus we have:
\begin{equation*}
\groupsetone[F]=\{\emptyset,\{3,4\}\}.
\end{equation*}
The two agents of the site graph $E$ belongs to two different connected components, thus a homogeneous  permutation of sites which can be applied to the site graph $E$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $1$, and in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $2$.
That is to say:
\begin{equation*}
\groupsetone[E]=\wp(\{1,2\}).
\end{equation*}
Not all the homogeneous permutation of sites that can be applied to the site graph $E$ can be extended into a homogeneous permutation of sites that can be applied to the site graph $F$, only the permutation $\emptyset$ and the permutation $\{1,2\}$ (which are mapped respectively into the permutations $\emptyset$ and $\{3,4\}$).


By applying Thm.~\ref{symdecomp}, since both the sets $\groupsetone[F]$ and $\{\actionembactionlong{\sigma_F}{f}\;|\;\sigma_F\in\groupsetone[F]\}$ have two elements, we can deduce that the set $\{\sigma_F\in\groupsetone[F] \;|\;\actionembactionlong{\sigma_F}{f}=\varepsilon_E\}$ only the identity element $\emptyset$ (which is actually the case).
\end{example}


\begin{example}[Decomposition of the group \gtwoh]
We consider the site graphs:
\begin{equation*}
G\bydef\graphG
\end{equation*} and
\begin{equation*}H\bydef\graphH,\end{equation*} and the embedding: \begin{equation*}g\bydef[(A,2)\mapsto 4],\end{equation*} as in Exa.~\ref{exmp:twoways} (also see Fig.~\ref{fig:twoways}).
A homogeneous permutations of sites which can be applied to the site graph $H$ consists either in swapping the states of the sites \sitefont{x} and \sitefont{y} in both agents of the site graph $H$, or in leaving the site graph $H$ unchanged, because these agents belongs to a same connected component.
Thus we have:
\begin{equation*}
\groupsetone[H]=\{\emptyset,\{3,4\}\}.
\end{equation*}
Beside, a homogeneous permutations of sites which can be applied to the site graph $G$ consists in swapping or not the states of the sites \sitefont{x} and \sitefont{y} of the agent with the label $2$.
Thus we have:
\begin{equation*}
\groupsetone[G]=\{\emptyset,\{2\}\}.
\end{equation*}
We notice that the homogeneous permutation $\emptyset$ (resp.~$\{2\}$) that can be applied to the site graph $G$, can be extended into the homogeneous permutation $\emptyset$  (resp.~$\{3,4\}$) that can be applied to the site graph $H$.

By applying Thm.~\ref{symdecomp}, since both the set $\groupsetone[H]$ and $\{\actionembactionlong{\sigma_F}{f}\;|\;\sigma_F\in\groupsetone[F]\}$ have two elements, we can deduce that the set $\{\sigma_F\in\groupsetone[F] \;|\;\actionembactionlong{\sigma_F}{f}=\varepsilon_E\}$ contains only the identity element $\emptyset$ (which can be checked easily).
\end{example}

\subsubsection{Induced group action  over isomorphisms}

\paragraph{Applying transformations to isomorphisms}

The image of an isomorphism by a transformation within a valid set of transformations over site graphs, is an isomorphism as well.
Moreover, the image of an embedding by a transformation within a valid set of transformations over site graphs, is an isomorphism if and only if the former is an isomorphism as well.
This is expressed in the following property.
\begin{prop}
\label{propagation:iso}
Let $\groupset[]$ be a set of transformations over site graphs.
We assume that the restriction of the transformations in $\groupset[]$ to the domain of weak embeddings distributes over the composition of weak embeddings ({\eg}see \ref{defn:symetriesdistributeovercomposition}) and that  the image of an embedding by a transformation in $\groupset[]$ is an embedding ({\eg}see \ref{def:permutation:embeddings}).
Let $f$ be an embedding between two site graphs $E$ and $F$, and $\sigma_F\in\groupset[F]$ be a transformation that can applied to the site graph $F$.

\newcommand{\inverse}[1]{{#1}^{\uminus 1}}
Then the following assertions are equivalent:
\begin{enumerate}
\item the embedding $f$ is an isomorphism.
\item the embedding  $\actionembemblong{\sigma_F}{f}$ is an isomorphism.
\end{enumerate}
In such a case, the inverse of the isomorphism
$\actionembemblong{\sigma_F}{f}$ is the isomorphism $\actionembemblong{{(\actionembactionlong{\sigma_F}{f})}}{\inverse{f}}$.
\end{prop}

We notice that we have proved \ref{propagation:iso} for a large class of sets of transformations over site graphs, not only for the valid sets of transformations.
Indeed, we only need the restriction of the transformations in $\groupset[]$ to the domain of weak embeddings to distribute over the composition of weak embeddings ({\eg}see \ref{defn:symetriesdistributeovercomposition}) and  the image of any embedding by a transformation in $\groupset[]$ to be an embedding ({\eg}see \ref{def:permutation:embeddings}).

A consequence of Prop.~\ref{propagation:iso} is that the structure of group action can be lifted to isomorphisms. This is expressed in the following property.
\begin{prop}[action of transformations over isomorphisms]\label{prop:isoaction}
Let $\group$ be a valid set of transformations over site graphs.
For any site graph $F$, the function which maps each pair $(\sigma_F,\phi)$ such that $\sigma_F$ is a transformation in  $\groupset[F]$ and $\phi$ is an isomorphism between two site graphs $E$ and $F'$ such that $F\groupequiv F'$, to the isomorphism $\actionembemblong{\sigma_F}{\phi}$, is a group action.
\end{prop}

\paragraph{Applying transformations to automorphisms}
The image of an automorphism by a transformation within a valid set of transformations over site graphs, is an isomorphism but not necessarily an automorphism. Yet, the number of automorphisms of a site graph $E$ and the number of the site graphs that are both symetric and isomorphic to the site graph $E$ are closely related. Given two symetric site graphs $E$ and $\actiongraphlong{\sigma}{E}$, the product between the number of automorphisms of $E$ and the number of the site graphs that are both symetric and isomorphic to $E$, and the product between the number of automorphisms of $F$ and the number of the site graphs that are both symetric and isomorphic to $F$, are equal, as stated in the following proposition:
\begin{prop}
\label{countiso}Let $\groupset$ be a valid set of transformations over site graphs.
For any site graph $E$ and for any permutation $\sigma_E\in\groupset[E]$,
\begin{equation*}
\myfrac{\aut{E}}{\aut{\actiongraphlong{\sigma_E}{E}}} =
\myfrac{\card( [\actiongraphlong{\sigma_E}{E}]_\iso \cap [\actiongraphlong{\sigma}{E}]_{\groupequiv})}{\card([{E}]_\iso \cap [{E}]_{\groupequiv})}.
\end{equation*}
\end{prop}

\paragraph{Transformations over isomorphic site graphs}

We investigate the relationships between the sets of transformations that can be applied to two isomorphic site graphs.

The following property establishes that in a valid set of transformations, the sets to the transformations that can be applied to two isomorphic site graphs are in bijection.
\begin{prop}\label{prop:iso}
Let $\groupset$ be a valid set of transformations over site graphs.
Let $\phi$ be an isomorphism between two site graphs $E$ and $F$.
Then, the two following functions:
\begin{equation*}
\begin{cases}
\begin{array}{ccc}
\groupset[F] & \rightarrow & \groupset[E] \cr
\sigma_F & \mapsto & \actionembactionlong{\sigma_F}{\phi}
\end{array}
\end{cases}
\end{equation*}
and
\begin{equation*}
\begin{cases}
\begin{array}{ccc}
\groupset[E] & \rightarrow & \groupset[F] \cr
\sigma_E & \mapsto & \actionembactionlong{\sigma_E}{\phi^{-1}}
\end{array}\end{cases}\end{equation*}
form a pair of inverse functions.
\end{prop}

A first consequence of Prop.~\ref{prop:iso} is that we can compare the number of the transformations that can be applied to two isomorphic site graphs.
\begin{corollary}
Let $\groupset$ be a valid set of transformations over site graphs and, $E$ and $F$ be two isomorphic graphs.

Then:
\begin{equation*}
\card(\groupset[E])=\card(\groupset[F])
\end{equation*}
\end{corollary}


Moreover, thanks to the proof of Prop.~\ref{prop:iso}, we can establish that, in a valid set fo transformations $\groupset$,  restricting a transformation $\sigma\in\groupset[E]$ that can be applied to the image $E$ of the inverse of an isomorphism $\phi$, into a transformation that can be applied to the domain $E$ of the inverse of $\phi$, comes down to extend the transformation  $\sigma$ that can be applied to the domain $E$ of the isomorphism $\phi$, into a transformation that can be applied to the image $F$ of the isomorphism $\phi$.  As a consequence, every isomorphism is $\groupset$-compatible.
\begin{corollary}
Let $\groupset$ be a valid set of transformations over site graphs.
Every isomorphism is $\groupset[]$-compatible.
\end{corollary}


Within a valid set of transformations over site graphs, the set of the pairs of transformations that can be applied to a weak partial embedding forms a group, as established in the following property.
\begin{prop}\label{def:group-partialemb}
Let $\group[]$ be a set of valid transformations over site graphs  and: \begin{equation*}h\;:\;L \llongweakembedding[f] D \rlongweakembedding[g] R\end{equation*} be a weak partial embedding.

The set of the pairs $(\sigma_L,\sigma_R) \in \groupset[L]\times\groupset[R]$ such that $\actionembactionlong{\sigma_L}{f}=\actionembactionlong{\sigma_R}{g}$ forms a group for the pairwise composition of transformations.

We denote this group by $\group[h]$. The identity element of $\group[h]$ is the pair of permutation $(\varepsilon_{\groupset[L]},\varepsilon_{\groupset[R]})$, where $\varepsilon_{\groupset[L]}$ is the identity element of the group $\groupset[L]$ and
$\varepsilon_{\groupset[R]}$ is the identity element of the group $\groupset[R]$.
\end{prop}


\begin{figure*}[p]
\subfigure[The partial embedding  $h\;:\;\text{\agent{A$_3$}{$\sitefont{x}$}\agentsep\agent{A$_4$}{$\sitefont{y}\sitesep\sitefont{z}^{\agent{A$_5$}{}@\sitefont{z}}$}\agentsep\agent{A$_5$}{$\sitefont{x}\sitesep\sitefont{z}^{\agent{A$_4$}{}@\sitefont{z}}$}}{\llongembedding[]}\text{\agent{A$_1$}{$\sitefont{x}$}\agentsep\agent{A$_2$}{$\sitefont{z}^{\bound{}}$}}{\rlongembedding[]}\text{\agent{A$_6$}{$\sitefont{x}\sitesep\sitefont{z}^{\agent{A$_7$}{}@\sitefont{z}}$}\agentsep\agent{A$_7$}{$\sitefont{y}\sitesep\sitefont{z}^{\agent{A$_6$}{}@\sitefont{z}}$}\agentsep\agent{A$_8$}{$\sitefont{y}$}}$ with the pair of embeddings {$([(\text{\agent{A}{}},1)\mapsto 3,(\text{\agent{A}{}},2)\mapsto 4],[(\text{\agent{A}{}},1)\mapsto 6,(\text{\agent{A}{}},2)\mapsto 7])$}.]
{\label{fig:symetric_pe_main}\begin{minipage}{\linewidth}\begin{center}\incgraphics{generated_pictures/sym_4_20_xyxy.pdf}\end{center}\end{minipage}}

\subfigure[The image of $h$ by the pair of permutations of sites $(\{3\},\{6\})$.]{\label{fig:symetric_pe_one}\incgraphics{generated_pictures/sym_4_20_yyxy.pdf}}
\subfigure[The image of $h$ by the pair of permutations of sites $(\{3\},\{6,8\})$.]{\label{fig:symetric_pe_one_four}\incgraphics{generated_pictures/sym_4_20_yyxx.pdf}}

\subfigure[The image of $h$ by the pair of permutations of sites $(\{4\},\{7\})$.]{\label{fig:symetric_pe_two}\incgraphics{generated_pictures/sym_4_20_xxxy.pdf}}
\subfigure[The image of $h$ by the pair of permutations of sites $(\{4,5\},\{7\})$.]{\label{fig:symetric_pe_twothree}\incgraphics{generated_pictures/sym_4_20_xxyy.pdf}}

\subfigure[The image of $h$ by the pair of permutations of sites $(\{5\},\emptyset)$.]{\label{fig:symetric_pe_three}\incgraphics{generated_pictures/sym_4_20_xyyy.pdf}}
\subfigure[The image of $h$ by the pair of permutations of sites $(\{5\},\{8\})$.]{\incgraphics{generated_pictures/sym_4_20_xyyx.pdf}}

\subfigure[The image of $h$ by the pair of permutations of sites $(\emptyset,\{8\})$.]{\label{fig:symetric_pe_four}\incgraphics{generated_pictures/sym_4_20_xyxx.pdf}}
\subfigure[The image of $h$ by the pair of permutations of sites $(\{3,4,5\},\{6,7\})$.]{\label{fig:symetric_pe_onetwothree}\incgraphics{generated_pictures/sym_4_20_yxxy.pdf}}

\caption{Examples of symetric partial embeddings. }
\label{fig:symetric_pe}
\end{figure*}

As an example, we investigate what are the groups of the pair of heterogeneous and homogeneous permutations of site that can be applied to the partial embedding that is given in Fig.~\ref{fig:symetric_pe_main}.
\begin{example}\label{exmp:pe-image}
We take the same signature as in Exa.~\ref{exmp:siteswap}.

We consider the following three site graphs:
\begin{equation*}
\begin{array}{l}
D \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\end{array}
\end{equation*}
and the following two embeddings:
\begin{equation*}
\begin{array}{l}
f\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7] \cr
\end{array}
\end{equation*}

We consider the partial embedding (eg.~see Fig.~\ref{fig:symetric_pe_main})	:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R.
\end{equation*}

The group of the pairs of heterogeneous permutations $\groupsetone[h]$ of sites that can be applied to the partial embedding $h$, is the set of the pairs $(X,Y)\in\wp(\{3,4,5\})\times \wp(\{6,7,8\})$ such that $3\in X$ if and only if $6\in Y$, and $4\in X$ if and only if $7\in Y$.
Thus, there exist exactly $2^4$ distinct  heterogeneous permutations.

\newcommand{\case}[8]{%
\item the image of the partial embedding $h$ by the pairs of heterogenous permutations of sites $#1$ is given in Fig.~\ref{#3} and is defined as the partial embedding:
\begin{equation*}
\actionembemblong{#1}{h}\;:\;L_{#2}\llongembedding[f_{#2}]D_{#2}\rlongembedding[g_{#2}]R_{#2}.
\end{equation*}
where:
\begin{equation*}
\begin{array}{l}
D_{#2} \bydef \text{\agent{A$_1$}{\site{#4}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L_{#2} \bydef \text{\agent{A$_3$}{\site{#4}{}{}}\agentsep\agent{A$_4$}{\site{#5}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{#6}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R_{#2} \bydef \text{\agent{A$_6$}{\site{#4}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{#5}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{#7}{}{}}}}\cr
f_{#2}\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g_{#2}\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7]#8\end{array}
\end{equation*}
}

For instance, \begin{enumerate}
\case{(\{3\},\{6\})}{\{3,6\}}{fig:symetric_pe_one}{y}{y}{x}{y}{;}
\case{(\{4\},\{7\})}{\{4,7\}}{fig:symetric_pe_two}{x}{x}{x}{y}{;}
\case{(\{5\},\emptyset)}{\{5\}}{fig:symetric_pe_three}{x}{y}{y}{y}{;}
\case{(\emptyset,\{8\})}{\{8\}}{fig:symetric_pe_four}{x}{y}{x}{x}{;}
\end{enumerate}
We say that the four following pairs of heterogeneous permutations $(\{3\},\{6\})$, $(\{4\},\{7\})$, $(\{5\},\emptyset)$, and $(\emptyset,\{8\})$ elementary, because they are minimal for the pairwise extension of the inclusion order $\subseteq$ among the pair of heterogeneous permutations $\groupsetone[h]\setminus\{(\emptyset,\emptyset)\}$ which are not the identity element.
We notice that any pair of heterogeneous permutations in $\groupset[h]$ can be obtained as a composition of these elementary pairs of heterogeneous permutations.
\end{example}

\begin{example}
With the same signature and the same partial embedding $h$ as in Exa.~\ref{exmp:pe-image}.

The group of the pairs of homogeneous permutations $\groupsettwo[h]$ of sites that can be applied to the partial embedding $h$, is the set of the pairs $(X,Y)\in\wp(\{3,4,5\})\times \wp(\{6,7,8\})$ such that $3\in X$ if and only if  $4\in X$ if and only if $5\in X$ if and only if $6 \in Y$ if and only if $7\in Y$, Thus, there exist exactly $2^2$ distinct  homogenous permutations: the permutation $(\emptyset,\emptyset)$ (the image of $h$ is given in Fig.~\ref{fig:symetric_pe_main}), the permutation $(\emptyset,\{8\})$ (the image of $h$ is given in Fig.~\ref{fig:symetric_pe_four}), the permutation $(\{3,4,5\},\{6,7\})$ (the image of $h$ is given in Fig.~\ref{fig:symetric_pe_onetwothree}), and the permutation $(\{3,4,5\},\{6,7,8\})$.

We say that the two following pairs of homogeneous permutations $(\emptyset,\{8\})$ and $(\{3,4,5\},\{6,7\})$ are elementary (because they are minimal for the pairwise extension of the inclusion order $\subseteq$ among the pair of homogeneous permutations $\groupsettwo[h]\setminus\{(\emptyset,\emptyset)\}$ which are not the identity element). We also notice  that any of the two others pairs of homogeneous permutations in $\groupsettwo[h]$ can be obtained as a composition of these elementary pairs of homogeneous permutations.
 \end{example}


Then, the structure of group action can be lifted to weak partial embeddings, as expressed as follows.
\begin{definition}[pairs of symetric weak partial embeddings]
Let $\groupset$ be a valid set of permutations.
We say that two weak partial embeddings $h$ and $h'$ are $\groupset$-symetric to one another  with respect to the set of transformations  $\groupset$ if and only if there exists $(\sigma_L,\sigma_R)\in\groupset[h]$ such that $h' = \actionpartialemblong{\sigma_L}{\sigma_R}{h}$.

In such a case, we write $h \groupequiv h'$.
\end{definition}

\begin{prop}
Let $\group$ be a valid set of transformations over site graphs.
then the relation $\groupequiv$ is an equivalence relation over weak partial embeddings.
\end{prop}

\begin{prop}\label{prop:pe_equal_groupset}
Let $\groupset[]$ be a valid set of transformations over site graphs, and $h$ and $h'$ be two weak partial embeddings that are $\groupset[]$-symetric to one another.

Then $\groupset[h]$ and $\groupset[h']$ are equal.
\end{prop}

\begin{prop}[action of pairs of transformations over weak partial embeddings]
Let $\groupset[]$ be a valid set of transformations over site graphs and $h$ be a weak partial embeddings.

Then the function which maps any pair $((\sigma_L,\sigma_R),h')$ such that
$(\sigma_L,\sigma_R)\in\groupset[h]$ is a pair of transformations  that can be applied to the weak partial embedding  $h$, and $h'$ is a weak partial embedding which is
$\groupset$-symetric to the weak partial embedding $h$, into the weak partial embedding $\actionpartialemblong{\sigma_L}{\sigma_R}{h}$, is a group action.
\end{prop}


We keep on our examples, by providing some samples  of pairs of symetric partial embeddings and some examples of pairs of non symetric partial embeddings.

\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap}.

We consider the two following partial embeddings:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R\end{equation*}
and
 \begin{equation*}
 h'\;:\;L'\llongembedding[f']D'\rlongembedding[g']R'.
\end{equation*}
with:
\begin{equation*}
\begin{array}{l}
D \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7]
\end{array}
\end{equation*}
and:
\begin{equation*}
\begin{array}{l}
D' \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L' \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R' \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f'\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g'\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7] \cr
\end{array}
\end{equation*}

A graphical representation of the partial embedding $h$ is given in Fig.~\ref{fig:symetric_pe_main} and
a graphical representation of the partial embedding $h'$ is given in Fig.~\ref{fig:symetric_pe_twothree}.

We can check that: $h \groupequiv[\groupsetone] h'$, but $h \notgroupequiv[\groupsettwo]h'$.
Indeed  the sites \site{x}{}{}Â and \site{y}{}{}Â has been swapped in the agent with the label $7$ of the right hand side of the partial embedding,
but not in the agent with the label $8$, although these two agents belong to a same connected component.
\end{example}

\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap}.

We consider the two following partial embeddings:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R\end{equation*}
and
 \begin{equation*}
 h''\;:\;L''\llongembedding[f'']D''\rlongembedding[g'']R''.
\end{equation*}
with:
\begin{equation*}
\begin{array}{l}
D \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7]
\end{array}
\end{equation*}
and:
\begin{equation*}
\begin{array}{l}
D'' \bydef \text{\agent{A$_1$}{\site{y}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L'' \bydef \text{\agent{A$_3$}{\site{y}{}{}}\agentsep\agent{A$_4$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R'' \bydef \text{\agent{A$_6$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f''\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g''\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7].
\end{array}
\end{equation*}
A graphical representation of the partial embedding $h$ is given in Fig.~\ref{fig:symetric_pe_main} and
a graphical representation of the partial embedding $h''$ is given in Fig.~\ref{fig:symetric_pe_onetwothree}.

We can check that: $h \groupequiv[\groupsetone] h'$.
As a consequence, we also have: $h \groupequiv[\groupsettwo] h'$.
\end{example}



\paragraph{Pushing a transformation forwards or backwards along a partial embedding.}

It is not always possible to push a transformation over site graphs forwards or backwards along a partial embedding.

Let us explain what happen when one wants to push
a transformation that can be applied to the left hand side of a partial embedding  forwards along this partial embedding.
Let
\begin{equation*}
h\;:\; L  \llongembedding[f] D \rlongembedding[g]\!R
\end{equation*}
be a partial embedding and let $\sigma_L$ be a transformation that
can be applied with the left hand side $L$ of a partial embedding $h$. The transformation  $\sigma_L$ can be restricted to the domain of the left embedding $f$ of the partial embedding $h$. This way, we get the transformation  $\actionembactionlong{\sigma_L}{f}$ which can be applied with the domain $D$ of the partial embedding $h$. Then, either there exists a transformation  $\sigma_R$ such that $\actionembactionlong{\sigma_R}{g}=\actionembactionlong{\sigma_L}{f}$, or not.
Moreover, when such a transformation  $\sigma_R$ exists (which is always the case if the embedding $g$ is compatible), it is usually not unique,  because the choice of the transformations that can be applied to  the agents of $R$ which are not documented in the domain $D$ of the partial embedding $h$ is free.


\begin{example}\label{exmp:pe_forward}
We take the same signature as in Exa.~\ref{exmp:siteswap}.

We consider the following partial embedding ({\eg}see Fig.~\ref{fig:symetric_pe_main}):
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R\end{equation*}
with:
\begin{equation*}
\begin{array}{l}
D \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7],
\end{array}
\end{equation*}
and the heterogeneous permutation of sites $\{3\}\in\groupsetone[L]$ that can be applied to the site graph $L$.
The restriction $\actionembactionlong{\{3\}}{f}$ of this permutation to the domain of the partial embedding is the heterogeneous permutation of sites $\{1\}\in\groupsetone[D]$.
The heterogeneous permutation of sites can be extended to the image of $g$ in two ways depending whether the sites \site{x}{}{}Â and \site{y}{}{}Â of the agent with label $8$ are swapped, or not, in the site graph $R$.
Thus we get either the heterogeneous permutation of sites $\{6\}\in\groupsetone[R]$ ({\eg}see Fig.~\ref{fig:symetric_pe_one}), or the heterogeneous permutation of sites $\{6,8\}\in\groupsetone[R]$ ({\eg}see Fig.~\ref{fig:symetric_pe_one_four}).
\end{example}
\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap} and the same partial embedding as in Exa.~\ref{exmp:pe_forward}.

We notice that the permutation of sites $\{3\}\in\groupsetone[L]$ is also homogeneous ({\ie}$\{3\}\in\groupsettwo[L]$).
Yet there is no way to extend the permutation $\{1\}\in\groupsettwo[D]$ along the embedding $g$ into a homogeneous permutation of sites that can be applied to the site graph $R$, since the agents with the labels $3$ and $4$ have been bound by the partial embedding, and they now belong to a same connected component.
Thus the homogeneous permutation of sites $\{3\}\in\groupsettwo[L]$ cannot be pushed forward the partial embedding $h$.
\end{example}


The same phenomena may be encountered when wanting to push a transformation over site graphs backwards along a partial embedding
\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap} and the same partial embedding as in Exa.~\ref{exmp:pe_forward}.

We consider the heterogeneous permutation of sites $\{7\}\in\groupsetone[R]$ that can be applied to the site graph $R$.
The restriction $\actionembactionlong{\{7\}}{g}$ of this permutation to the domain of the partial embedding is the heterogeneous permutation of sites $\{2\}\in\groupsetone[D]$.
The heterogeneous permutation of sites can be extended to the image of $f$ in two ways depending whether the sites \site{x}{}{}Â and \site{y}{}{}Â of the agent with label $5$ are swapped, or not, in the site graph $L$.
Thus we get either the heterogeneous permutation of sites $\{4\}\in\groupsetone[R]$ ({\eg}see Fig.~\ref{fig:symetric_pe_two}), or the heterogeneous permutation of sites $\{4,7\}\in\groupsetone[R]$ ({\eg}see Fig.~\ref{fig:symetric_pe_twothree}).
\end{example}

\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap} and the same partial embedding as in Exa.~\ref{exmp:pe_forward}.

Any homogeneous permutation of sites in $\groupsettwo[R]$ can be pushed backward the partial embedding $h$.
Indeed, even if the agents with the labels $4$ and $5$ are bound together in the left hand side  $L$ of the partial embedding $h$, it is not constraining since the agent with the label $5$ is not associated with an agent in the right hand side $R$ of the partial embedding $h$.
\end{example}

\begin{example}
Examples of transformations over site graphs that cannot be pushed backwards along a partial embedding can be obtained by taking
examples of transformations over site graphs  that cannot be pushed forwards along a partial embedding, and by reverting the partial embedding (by swapping the left and the right hand sides and by swapping the left and the right embeddings).
\end{example}


We say that a partial embedding is forward (resp.~backward) compatible with a set of transformations if any of the transformations that can be applied to its left hand side (resp.~right hand side) can be pushed forwards (resp.~backwards) this partial embedding, as stated in the following definitions.
\begin{definition}
Let $\groupset[]$ be a valid set of transformations over site graphs and $h$ be a partial embedding between two site graphs $L$ and $R$.
We say that $h$ is $\groupset[]$-forward compatible if and only if for any permutation $\sigma_L\in\groupset[L]$, there exists a transformation $\sigma_R\in\groupset[R]$ such that $(\sigma_L,\sigma_R)\in\groupset[h]$.
\end{definition}
\begin{definition}
Let $\groupset[]$ be a set of transformations over site graphs and $h$ be a partial embedding between two site graphs $L$ and $R$.
We say that $h$ is $\groupset[]$-backward compatible if and only if for any permutation $\sigma_R\in\groupset[R]$, there exists a transformation $\sigma_L\in\groupset[L]$ such that $(\sigma_L,\sigma_R)\in\groupset[h]$.
\end{definition}


\begin{prop}
Let $\groupset[]$ be a valid set of transformations over site graphs and \begin{equation*}h\;:\;L\llongembedding[f] D \rlongembedding[g]\!R\end{equation*} be a partial embedding between two site graphs $L$ and $R$. We consider the partial embedding $h'$ that is defined as follows:
\begin{equation*}
h'\;:\;R\llongembedding[g]D\rlongembedding[f]\!L.
\end{equation*}
Then, the two following equivalences are satisfied:
\begin{enumerate}
\item the partial embedding $h$ is $\groupset[]$-forward compatible, if and only if, the partial embedding $h'$ is $\groupset[]$-backward compatible.
\item the partial embedding $h$ is $\groupset[]$-backward compatible, if and only if, the partial embedding $h'$ is $\groupset[]$-forward compatible.
\end{enumerate}
\end{prop}

\begin{prop}\label{prop:compatible}
Let $\groupset[]$ be a valid set of transformations over site graphs and \begin{equation*}h\;:\;L\llongembedding[f] D \rlongembedding[g]\!R\end{equation*} be a partial embedding between two site graphs $L$ and $R$.

The following implications  hold:
\begin{enumerate}
\item If the right embedding $g$ is $\groupset[]$-compatible, then the partial embedding $h$ is $\groupset[]$-forward compatible.
\item If the left embedding $f$ is $\groupset[]$-compatible, then the partial embedding $h$ is $\groupset[]$-backward compatible.
\end{enumerate}
\end{prop}

\begin{example}
Any partial embedding is $\groupsetone$-forwards and $\groupsetone$-backwards compatible.
\end{example}
\begin{example}
We take the same signature as in Exa.~\ref{exmp:siteswap} and the same partial embedding as in Exa.~\ref{exmp:pe_forward}.

The partial embedding $h$ is $\groupsettwo$-backwards compatible, but not $\groupsettwo$-forwards compatible.
\end{example}

The set of the transformations that can be applied with the right hand side of a partial embedding and which are compatible with a given transformation of the left hand side of this partial embedding, enjoys a nice algebraic structure, as described in the following proposition.
\begin{prop}\label{parfordecom}
Let $\groupset[]$ be a valid set of transformations over site graphs,
\begin{equation*}
h\;:\; L \llongembedding[f] D \rlongembedding[g]\!R\end{equation*}
be a partial embedding between two site graphs $L$ and $R$, and $\sigma_L\in\groupset[L]$ be a transformation that can be applied to the left hand side $L$ of the partial embedding $h$.

The set:\begin{equation*}
\{\sigma_R\in\groupset[R]\;|\;(\sigma_L,\sigma_R)\in\groupset[h]\}\end{equation*}
is either empty, or of the form:
\begin{equation*}
\{\sigma_R\circ_R\sigma'_R\;|\;\sigma'_R\in\groupset[R] \suchthat \actionembactionlong{\sigma'_R}{g}=\varepsilon_{\groupset[D]}\},
\end{equation*}
for a given transformation $\sigma_R\in\groupset[R]$.
\end{prop}


The reasoning is the same when trying to pull a transformation that can be applied to the right hand side of a partial embedding backwards, so as to get a transformation that can be applied to the right hand side of this partial embedding.
\begin{prop}
Let $\groupset[]$ be a valid set of transformations over site graphs,
\begin{equation*}
h\;:\; L \llongembedding[f] D \rlongembedding[g]\!R\end{equation*}
be a partial embedding between two site graphs $L$ and $R$, and $\sigma_L\in\groupset[L]$ be a transformation that can be applied to the left hand side $L$ of the partial embedding $h$.

The set:\begin{equation*}
\{\sigma_L\in\groupset[L]\;|\;(\sigma_L,\sigma_R)\in\groupset[h]\}\end{equation*}
is either empty, or of the form:
\begin{equation*}
\{\sigma_L\circ_L\sigma'_L\;|\;\sigma'_L\in\groupset[L] \suchthat \actionembactionlong{\sigma'_R}{g}=\varepsilon_{\groupset[D]}\},
\end{equation*}
for a given transformation $\sigma_L\in\groupset[L]$.
\end{prop}
\begin{myproof}
We get Prop.~\ref{parfordecom} by applying Thm.~\ref{symdecomp}.(3) with the embedding $f$ between the two site graphs $D$ and $L$, and with the transformation $\actionembactionlong{\sigma_R}{g}\in\groupset[D]$.
\end{myproof}


\paragraph{Decomposing the group of the transformations that can be applied to a partial embedding}

In a valid set of transformations, a partial embedding $h$ between two site graphs $L$ and $R$, and with domain $D$, induces a morphism between the group of the pairs of transformations $\groupset[h]$ that can be applied to the partial embedding $h$, and the group of the transformations $\groupset[D]$ that can be applied to the domain of the partial embedding $h$.  Thanks to this property, we can properly decompose the group of the transformations that can be applied to a partial embedding $h$ into three subgroups: the groups of the transformations  that can be applied to the domain of the partial embedding $h$, the group of the transformations  that can be applied to the left hand side $L$ of the partial embedding $h$ that becomes the identity transformation when restricted to the domain $D$ of the partial embedding $h$, and the group of the transformations  that can be applied to the right hand side $R$ of the partial embedding $h$ that becomes the identity transformation when restricted to the domain $D$ of the partial embedding $h$,

\begin{prop}\label{pemorph}
Let $\groupset[]$ be a valid set of transformations over site graphs and \begin{equation*}h\;:\;L\llongembedding[f] D \rlongembedding[g]\!R\end{equation*} be a partial embedding between two site graphs $L$ and $R$.

The following function:
\begin{equation*}
\begin{cases}
\groupset[h] \rightarrow \groupset[D] \cr
(\sigma_L,\sigma_R) \mapsto \actionpartialembactionlong{\sigma_L}{\sigma_R}{h}
\end{cases}
\end{equation*}
is a morphism between the groups $\groupset[h]$ and $\groupset[D]$.
\end{prop}

\begin{proof}
Let $\groupset[]$ be a valid set of transformations over site graphs and: \begin{equation*}h\;:\;L\llongembedding[f] D \rlongembedding[g]\!R\end{equation*} be a partial embedding between two site graphs $L$ and $R$.

Let $(\sigma_L,\sigma_R)$ and $(\sigma'_L,\sigma'_R)$ be two elements of $\groupset[h]$.

Thanks to Defs.~\ref{def:morphism} and \ref{def:image-pe}, we have:
\begin{equation*}
\begin{array}{ll}
\actionembactionlong{((\sigma_L,\sigma_R)\circ_h(\sigma'_L,\sigma'_R))}{h} = \actionpartialembactionlong{\sigma_L\circ_L\sigma'_L}{\sigma_R\circ_R\sigma'_R}{h} \cr
\actionembactionlong{((\sigma_L,\sigma_R)\circ_h(\sigma'_L,\sigma'_R))}{h} = \actionembactionlong{(\sigma_L\circ_L\sigma'_L)}{f}\cr
\actionembactionlong{((\sigma_L,\sigma_R)\circ_h(\sigma'_L,\sigma'_R))}{h} = ((\actionembactionlong{\sigma_L}f)\circ_D(\actionembactionlong{\sigma'_L}{f}))\cr
\actionembactionlong{((\sigma_L,\sigma_R)\circ_h(\sigma'_L,\sigma'_R))}{h} = (\actionpartialembactionlong{\sigma_L}{\sigma_R}h)\circ_D(\actionpartialembactionlong{\sigma'_L}{\sigma'_R}{h}).\end{array}
\end{equation*}
\end{proof}

\begin{theorem}\label{symdecomppe}
Let $\groupset$ be a valid set of transformations over site graphs and let:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R
\end{equation*}
be a partial embedding.

Both following assertions are satisfied:
\begin{enumerate}
\item The set:
\begin{equation*}
\{\actionpartialemblong{\sigma_L}{\sigma_R}{h}\;|\;(\sigma_L,\sigma_R)\in\groupset[h]\}
\end{equation*}
and the set:
\begin{equation*}
\groupset[h]\setminus\{(\sigma_L,\sigma_R)\in\groupset[h]\;|\;\actionpartialembactionlong{\sigma_L}{\sigma_R}{h}=\varepsilon_D\}
\end{equation*}
are two isomorphic groups.
\item The cardinal of the  group $\groupset[h]$ is equal to the product between:
\begin{enumerate}
\item the cardinal of the group:\begin{equation*} \{\actionpartialemblong{\sigma_L}{\sigma_R}{h}\;|\;(\sigma_L,\sigma_R)\in\groupset[h]\},\end{equation*}
\item the cardinal of the group:\begin{equation*} \{\sigma_L\in\groupset[L]\;|\;\actionembactionlong{\sigma_L}{f} = \varepsilon_D \},\end{equation*}
\item the cardinal of the group:\begin{equation*} \{\sigma_R\in\groupset[R]\;|\;\actionembactionlong{\sigma_R}{g} = \varepsilon_D\}.\end{equation*}
\end{enumerate}
\end{enumerate}
\end{theorem}
\begin{proof}
Let $\groupset$ be a valid set of transformations over site graphs and let:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R
\end{equation*}
be a partial embedding.

According to Prop.~\ref{pemorph}, the function between the group $\groupset[h]$ and the group $\groupset[D]$ mapping each pair of transformations $\sigma_h\in\groupset[h]$ into the transformation $\actionembactionlong{\sigma_h}{h}\in\groupset[D]$, is a morphism.
The first assertion follows from the first isomorphism theorem (Thm.~\ref{firstiso}).

The second assertion is proved in two steps.
From  Cor.~\ref{firstisocor}, we get that the cardinal of the group $\groupset[h]$ is equal to the product between:
\begin{enumerate}
\item the cardinal of the group:\begin{equation*} \{\actionpartialemblong{\sigma_L}{\sigma_R}{h}\;|\;(\sigma_L,\sigma_R)\in\groupset[h]\},\end{equation*}
\item the cardinal of the group:\begin{equation*} \{\sigma_h\in\groupset[h]\;|\;\actionembactionlong{\sigma_h}{h} = \varepsilon_D \}.\end{equation*}
\end{enumerate}
Then, we have:
\begin{equation*}
\begin{array}{ll}
&\{\sigma_h\in\groupset[h]\;|\;\actionembactionlong{\sigma_h}{h} = \varepsilon_D \} \cr
 = &\left\{(\sigma_L,\sigma_R)\in\groupset[L]\times\groupset[R]\;\left|\begin{array}{l}
\actionembactionlong{\sigma_L}{f} = \actionembactionlong{\sigma_R}{g} \cr
\actionpartialembactionlong{\sigma_L}{\sigma_R}{f}=\varepsilon_D
\end{array}\right.\right\}\cr
 = &\left\{(\sigma_L,\sigma_R)\in\groupset[L]\times\groupset[R]\;\left|\begin{array}{l}
\actionembactionlong{\sigma_L}{f} = \actionembactionlong{\sigma_R}{g} \cr
\actionembactionlong{\sigma_L}{f}=\varepsilon_D
\end{array}\right.\right\}\cr
 = &\left\{(\sigma_L,\sigma_R)\in\groupset[L]\times\groupset[R]\;\left|\begin{array}{l}
\actionembactionlong{\sigma_L}{f} = \varepsilon_D \cr
\actionembactionlong{\sigma_R}{g}=\varepsilon_D
\end{array}\right.\right\}\cr
= &\{\sigma_L\in\groupset[L]\;|\;\actionembactionlong{\sigma_L}{f} = \varepsilon_D\}\times \{\sigma_R\in\groupset[R]\;|\;\actionembactionlong{\sigma_R}{g} = \varepsilon_D\}.
\end{array}\end{equation*}
\end{proof}

In Thm.~\ref{symdecomppe}, the group $\{\actionpartialembactionlong{\sigma_L}{\sigma_R}{f}\;|\; (\sigma_L,\sigma_R)\in\groupset[h]\}$ denotes the set of the transformations  that can be applied to the domain $D$ of the partial embedding $h$ and that can be extended into a pair of transformations that can be applied respectively to the left hand side $L$ and the right hand side $R$ of the partial embedding $h$. Then, the group $\{\sigma_L\in\groupset[L]\;|\; \actionembactionlong{\sigma_L}{f}=\varepsilon_D\}$ is the kernel of morphism $h_f$ that is induced by the embedding $f$ and denotes the set of transformations  over the left hand side $L$ of the partial embedding $h$ that do not modify the domain $D$ of the partial embedding $h$ (when we restrict this transformation to the domain $D$ of the embedding $f$). The same way, the group $\{\sigma_R\in\groupset[R]\;|\; \actionembactionlong{\sigma_R}{g}=\varepsilon_D\}$ is the kernel of morphism $h_g$ that is induced by the embedding $g$ and denotes the set of transformations  over the right hand side $R$ of the partial embedding $h$ that do not modify the domain $D$ of the partial embedding $h$ (when we restrict this transformation to the domain $D$ of the embedding $g$).

We illustrate the use of Thm.~\ref{symdecomppe} by decomposing the group of the pairs of heterogeneous permutations of sites and the group of the pairs of homogeneous permutations of sites that can be applied to the partial embedding that is given in Fig.~\ref{fig:symetric_pe_main}, in the following two examples.
\begin{example}\label{exmp:decomppehetero}
We take the same signature as in Exa.~\ref{exmp:siteswap} and we consider the following partial embedding ({\eg}see Fig.~\ref{fig:symetric_pe_main}):
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]R\end{equation*}
with:
\begin{equation*}
\begin{array}{l}
D \bydef \text{\agent{A$_1$}{\site{x}{}{}}\agentsep\agent{A$_2$}{\site{z}{}{\bound{}}}}\cr
L \bydef \text{\agent{A$_3$}{\site{x}{}{}}\agentsep\agent{A$_4$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{5}{z}}}\agentsep{\agent{A$_5$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{4}{z}}}}}\cr
R \bydef \text{\agent{A$_6$}{\site{x}{}{}\sitesep\site{z}{}{\boundto{A}{7}{z}}}\agentsep\agent{A$_7$}{\site{y}{}{}\sitesep\site{z}{}{\boundto{A}{6}{z}}}\agentsep{\agent{A$_8$}{\site{y}{}{}}}}\cr
f\bydef[(\agent{A}{},1) \mapsto 3,(\agent{A}{},2) \mapsto 4] \cr
g\bydef [(\agent{A}{},1) \mapsto 6,(\agent{A}{},2) \mapsto 7].
\end{array}
\end{equation*}
The group of the pairs of heterogeneous permutations $\groupsetone[h]$ of sites that can be applied to the partial embedding $h$ can be decomposed into three groups.
\begin{enumerate}
\item  The group of the heterogeneous permutations of sites that can be applied to the domain $D$ of the partial embedding $h$, and extended both into an heterogeneous permutation of sites that can be applied to the left hand side $L$ of the partial embedding $h$ and into an heterogeneous permutation of sites that can be applied to the right hand side $R$ of the partial embedding $h$, that is to say
the group $\wp(\{1,2\})$ that contains exactly four elements.
\item The group of the heterogeneous permutations of sites that can be applied to the left hand side $L$ of the partial embedding $h$, and that are restricted to the identity permutation when restricted to the domain $D$ of the partial embedding $h$, that is to say the set $\{\emptyset,\{5\}\}$ that contains exactly two elements.
\item The group of the heterogeneous permutations of sites that can be applied to the right hand side $R$ of the partial embedding $h$, and that are restricted to the identity permutation when restricted to the domain $D$ of the partial embedding $h$, that is to say the set $\{\emptyset,\{8\}\}$ that contains exactly two elements.
\end{enumerate}
We get back the $2^4$ elements of the group $\groupsetone[h]$.
\end{example}

\begin{example}\label{exmp:decomppehomo}
We take the same signature as in Exa.~\ref{exmp:siteswap} and the same partial embedding as in Exa.~\ref{exmp:decomppehetero}.

The group of the pairs of homogeneous permutations $\groupsettwo[h]$ of sites that can be applied to the partial embedding $h$ can be decomposed into three groups.
\begin{enumerate}
\item  The group of the homogeneous permutations of sites that can be applied to the domain $D$ of the partial embedding $h$, and extended both into an heterogeneous permutation of sites that can be applied to the left hand side $L$ of the partial embedding $h$ and into an heterogeneous permutation of sites that can be applied to the right hand side $R$ of the partial embedding $h$. Since the agents with label $6$ and $7$ are bound together in $R$,
such a permutation should swap the sites \sitefont{x} and \sitefont{y}Â in the agent with the label $1$ if and only if it swaps also the sites \sitefont{x} and \sitefont{y} of the agent with the label $2$ in the site graph $D$. Thus this group is the group $\{\emptyset,\{1,2\}\}$ and it contains exactly two elements.
\item The group of the homogeneous permutations of sites that can be applied to the left hand side $L$ of the partial embedding $h$, and that gives  the identity permutation when restricted to the domain $D$ of the partial embedding $h$.
There is only one such permutation of sites (the idendity transformation $\emptyset$).
Indeed, if it were containing another permutation, this permutation would have to swap the two sites \sitefont{x} and \sitefont{y} in the agent with the label $5$ in the site graph $L$, then since the agents with the labels $4$ and $5$ are bound together in the site graph $L$, such a permutation would have to swap also the sites \sitefont{x} and \sitefont{y} of the agent $4$ as well, which is not possible, since its restriction to the domain $D$ of the partial embedding would then not be the identity permutation of sites. Thus, this group is the group $\{\emptyset\}$ and it has only one element.
\item The group of the homogeneous permutations of sites that can be applied to the right hand side $R$ of the partial embedding $h$, and that gives the identity permutation when restricted to the domain $D$ of the partial embedding $h$, that is to say the set $\{\emptyset,\{8\}\}$ that contains exactly two elements.
\end{enumerate}
We get back the $4$ elements of the group $\groupsettwo[h]$.
\end{example}

\paragraph{Compatibility between the application of pairs of transformations and the composition of weak partial embeddings}
\newcommand{\drule}{%
\begin{equation*}\xymatrix@C=25mm@R=4mm{%
\newL \ar@{-|>}^{\newr}[rr] & & \newR \\
                         & \newDprim\ar@{_{(}->}_{\newf}[lu]\ar@{^{(}->}^{\newg}[ru] & \\\\
 & \newD\ar@{->}|\iso_(0.6){\newpsi}[uu]\ar@{^{(}->}^{\newfprim}[luuu]\ar@{_{(}->}_{\newgprim}[ruuu]
}\end{equation*}}
\newcommand{\dpe}{%
\begin{equation*}\xymatrix@C=20mm@R=4mm{%
\newL  & & \newR \\
                         & \newDprim\ar@{_{(}->}|w_{\newf}[lu]\ar@{^{(}->}|w^{\newg}[ru] & \\\\
 & \newD\ar@{->}|\iso_(0.6){\newpsi}[uu]\ar@{^{(}->}|w^{\newfprim}[luuu]\ar@{_{(}->}|w_{\newgprim}[ruuu]
}\end{equation*}}

So as to check the coherence of our algebraic construction, we check some sanity properties about the application of pairs of transformations to weak partial embeddings.

The domain of a composition of weak partial embeddings on the first hand, and the domain of rules in the second hand are defined only modulo isomorphism.
Thus, it is important to check to the image of a weak partial embedding by a pair of transformations over site graphs, is independent from the choice, modulo isomorphism, of the domain of this weak partial embedding.  This sanity property is formalised in the following proposition.


\begin{prop}\label{sym:prop:rule:iso}
Let $\groupset$ be a valid set of transformations over site graphs.
Let $L$, $R$, and $D$ be three site graphs, $f$ be a weak embedding between the site graphs $D$ and $L$, and $g$ be a weak embedding between the site graph $D$ and $R$. We denote by $h$ the following  weak partial embedding:
\begin{equation*}h\;:\;L \llongembedding[f] D \rlongembedding[g]\!R.\end{equation*}


Let $\phi$ an isomorphism between a site graph $D'$ and the site graph $D$.
We denote by $h'$ the following weak partial embedding:
\begin{equation*}
h'\;:\;L \llongembedding[f\phi] D' \rlongembedding[g\phi] R.
\end{equation*}
Under these assumptions,
both  following properties are satisfied:
\begin{enumerate}
\item $\groupset[h] = \groupset[h']$;
\item For any $(\sigma_L,\sigma_R)\in\groupset[h]$, there exists an isomorphism $\psi$ between a site graph $D''$ and the site graph
$\actiongraphlong{(\actionembactionlong{\sigma_L}{f})}{D}$
such thats
the image $\actionpartialemblong{\sigma_L}{\sigma_R}{h'}$ of the weak embedding $h'$ by the pair of transformations $(\sigma_L,\sigma_R)$ is equal to the following weak partial embedding:
\begin{equation*}
\actionpartialemblong{\sigma_L}{\sigma_R}{h'}\;:\;\actiongraphlong{\sigma_L}L\lvlongweakembedding[(\actionembemblong{\sigma_L}{f})\psi] D'' \rvlongweakembedding[(\actionembemblong{\sigma_R}{g})\psi]	 \actiongraphlong{\sigma_R}{R}.
\end{equation*}
\end{enumerate}
\end{prop}
\begin{proof}
Let us take the notations of Prop.~\ref{sym:prop:rule:iso}.
{
\newcommand{\newr}{}
\newcommand{\sigmaD}{\actionembactionlong{\sigma_L}{f}}
\newcommand{\newL}{{L}}
\newcommand{\newR}{{R}}
\newcommand{\newD}{{{}^{\;}D'^{\;\mbox{}}}}
\newcommand{\newf}{{f}}
\newcommand{\newg}{{g}}
\newcommand{\newpsi}{\phi}
\newcommand{\newDprim}{D}
\newcommand{\newfprim}{{f\phi}}
\newcommand{\newgprim}{{g\phi}}
\dpe}
\begin{enumerate}
\item
\begin{enumerate}
\item Let $(\sigma_L,\sigma_R)\in\groupset[h]$.

We have:
\begin{equation*}
\begin{array}{ll}
\actionembactionlong{\sigma_L}{(f\phi)}= \actionembactionlong{(\actionembactionlong{\sigma_L}{f})}{\phi}  & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))}
\cr
\actionembactionlong{\sigma_L}{(f\phi)}= \actionembactionlong{(\actionembactionlong{\sigma_R}{g})}{\phi}  & \text{(by Def.~\ref{def:image-pe})} \cr
\actionembactionlong{\sigma_L}{(f\phi)}= \actionembactionlong{\sigma_R}{(g\phi)} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))}
\end{array}
\end{equation*}
By  Def.~\ref{def:image-pe}, we get that: $(\sigma_L,\sigma_R)\in\groupset[h']$.

Thus, $\groupset[r]\subseteq\groupset[h']$.
\item We get that $\groupset[h]\supseteq\groupset[h']$ by replacing $h$ with $h'$, $f$ with $f\phi$, $g$ with $g\phi$, and $\phi$ with $\phi^{-1}$ in the proof of the direct inclusion.
\end{enumerate}
\item Let us apply the pair of transformations $(\sigma_L,\sigma_R)\in\groupset[h]$ to the weak partial embedding $h$.

By Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiond}),
we have:
\begin{equation*}
\actionembemblong{\sigma_L}{(f\phi)}=(\actionembemblong{\sigma_L}{f})(\actionembemblong{(\actionembactionlong{\sigma_L}{f})}{\phi})
\end{equation*}
and:
\begin{equation*}
\actionembemblong{\sigma_R}{(g\phi)}=(\actionembemblong{\sigma_R}{g})(\actionembemblong{(\actionembactionlong{\sigma_R}{g})}{\phi})
\end{equation*}

Then, by Def.~\ref{def:group-partialemb},  we get that:
\begin{equation*}
\actionembemblong{\sigma_R}{(g\phi)}=(\actionembemblong{\sigma_L}{f})(\actionembemblong{(\actionembactionlong{\sigma_L}{f})}{\phi})
\end{equation*}

By Def.~\ref{defn:permutation}, the image $\actionembemblong{(\actionembactionlong{\sigma_L}{f})}{\phi}$ of the isomorphism $\phi$ by the transformation $\actionembactionlong{\sigma_L}{f}$ is a partial embedding between
the site graph $\actiongraphlong{(\actionembactionlong{(\actionembactionlong{\sigma_L}{f})}{\phi})}{D'}$ and the site graph $\actiongraphlong{(\actionembactionlong{\sigma_L}{f})}{D}$. Moreover, by Prop.~\ref{propagation:iso}, this partial embedding is an isomorphism.

Let us denote by $D''$ the image $\actiongraphlong{(\actionembactionlong{(\actionembactionlong{\sigma_L}{f})}{\phi})}{D'}$ of the site graph $D'$ by the transformation
$\actionembactionlong{(\actionembactionlong{\sigma_L}f)}{\phi}$, and $\psi$ the image $\actionembemblong{(\actionembactionlong{\sigma_L}{f})}{\phi}$ of the isomorphism $\phi$ by the transformation $\actionembactionlong{\sigma_L}{f}$.  We get the following commutating diagram:
{
\newcommand{\newr}{}
\newcommand{\sigmaD}{\actionembactionlong{\sigma_L}{f}}
\newcommand{\newL}{\actiongraphlong{\sigma_L}{L}}
\newcommand{\newR}{\actiongraphlong{\sigma_R}{R}}
\newcommand{\newDprim}{\actiongraphlong{(\sigmaD)}{D}}
\newcommand{\newf}{\actionembemblong{\sigma_L}{f}}
\newcommand{\newg}{\actionembemblong{\sigma_R}{g}}
\newcommand{\newpsi}{\psi}
\newcommand{\newD}{D''}\newcommand{\newfprim}{\actionembemblong{\sigma_L}{(f\phi)}}
\newcommand{\newgprim}{\actionembemblong{\sigma_R}{(g\phi)}}
\dpe} which concludes the proof.
\end{enumerate}\end{proof}


In order to define the composition between  weak partial embeddings and partial embeddings, we had to consider each partial embedding as a weak partial embedding in which the left partial embedding is an identity embedding. So as to check the coherence of this convention, we check that whenever a weak partial embedding is indeed a weak embedding (because its left weak embedding is an identity embedding), applying a pair of transformations to the weak partial embedding comes down to apply a transformation to the corresponding weak embedding.
\begin{prop}\label{prop:sym-equ-pe-e}
Let $\groupset$ be a valid set of transformations over site graphs,  $E$ and $F$ be two site graphs, $f$ be a weak embedding between the site graph $E$ and the site graph $F$ and $\sigma_F$ be a transformation that can be applied to the site graph $F$.

Both following assertions hold:
\begin{enumerate}
\item $(\actionembactionlong{\sigma_F}{f},\sigma_F)\in\groupset[\left(\identity{E},f\right)]$;
\item $\actionpartialemblong{(\actionembactionlong{\sigma_F}{f})}{\sigma_F}{(\identity{E},f)}=
          \left(\identity{\actiongraphlong{(\actionembactionlong{\sigma_F}{f})}{E}}  ,\actionembemblong{\sigma_F}{f}\right)$.
\end{enumerate}
\end{prop}
\begin{proof}
Let $\groupset$ be a valid set of transformations over site graphs,  $E$ and $F$ be two site graphs, $f$ be a weak embedding between the site graph $E$ and the site graph $F$ and $\sigma_F$ be a transformation that can be applied to the site graph $F$.

\begin{enumerate}
\item We have:
\begin{equation*}
\begin{array}{ll}
\identity{E}(\actionembactionlong{\sigma_F}{f})=\actionembactionlong{\sigma_F}{f} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiona}))} \cr
\end{array}
\end{equation*}
Thus, by Prop.~\ref{def:group-partialemb}, we have: $(\actionembactionlong{\sigma_F}{f},\sigma_F)\in\groupset[\left(\identity{E},f\right)]$.

\item We have:
\begin{equation*}
\begin{array}{lll}
& \actionpartialemblong{(\actionembactionlong{\sigma_F}{f})}{\sigma_F}{(\identity{E},f)} \cr
= &\left(\actionembemblong{(\actionembactionlong{\sigma_F}{f})}{\identity{E}} ,\actionembemblong{\sigma_F}{f}\right) & \text{(by Def.~\ref{def:image-pe})}\cr
= & \left(\identity{(\actionembactionlong{\sigma_F}{f})} ,\actionembemblong{\sigma_F}{f}\right) &  \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositionb}))} \cr
\end{array}
\end{equation*}
\end{enumerate}
\end{proof}

\begin{prop}\label{prop:dist-sym-pe}
Let $\groupset$ be a valid set of transformations over site graphs, $G$, $H$, $K$ be three site graphs, and $h$ and $h'$ be two partial weak embedding respectively between the site graphs $G$ and $H$, and between the site graphs $H$ and $K$. Let $\sigma_G\in\groupset[G]$, $\sigma_H\in\groupset[H]$, $\sigma_K\in\groupset[K]$ be three transformations that can be applied respectively to the site graphs $G$, $H$, and $K$. We assume that  $(\sigma_G,\sigma_H)\in\groupset[h]$ and $(\sigma_H,\sigma_K)\in\groupset[h']$.

Under this assumption, both following assertions hold:
\begin{enumerate}
\item $(\sigma_G,\sigma_K)\in\groupset[(h'h)]$;
\item $\actionpartialemblong{\sigma_G}{\sigma_K}{(h'h)}=( \actionpartialemblong{\sigma_H}{\sigma_K}{h'})(\actionpartialemblong{\sigma_G}{\sigma_H}{h})$.
\end{enumerate}
\end{prop}

\begin{proof}
Let $\groupset$ be a valid set of transformations over site graphs, $G$, $H$, $K$ be three site graphs, and $h$ and $h'$ be two partial weak embedding respectively between the site graphs $G$ and $H$, and between the site graphs $H$ and $K$. Let $\sigma_G\in\groupset[G]$, $\sigma_H\in\groupset[H]$, $\sigma_K\in\groupset[K]$ be three transformations that can be applied respectively to the site graphs $G$, $H$, and $K$. We assume that  $(\sigma_G,\sigma_H)\in\groupset[h]$ and $(\sigma_H,\sigma_K)\in\groupset[h']$.

We denote as:
\begin{equation*}
h\;:\;G \llongweakembedding[h_l] D \rlongweakembedding[h_r] H,
\end{equation*}
the weak partial embedding $h$ and as:
\begin{equation*}
h'\;:\;H \llongweakembedding[h'_l] D' \rlongweakembedding[h'_r] K,
\end{equation*}
the weak partial embedding $h'$.

As seen in Sect.~\ref{sec:pe}, each span of weak embeddings has pullback (that is uniquely defined modulo isomorphism) which is a partial embedding.
Let us introduce $D''$ a site graph and $h''_l$ and $h''_r$ be two embeddings between the site graphs $D''$ and $D$, and the site graphs $D''$ and $D'$, such that the
partial embedding:
\begin{equation*}
D \llongembedding[h''_l] D''\rlongembedding[h''_r] D'
\end{equation*}
is a pullback of the span:
\begin{equation*}
D \rlongweakembedding[h_r] H \llongweakembedding[h'_\ell] D'.
\end{equation*}

Let us summarise our  assumptions in the following commutative diagram:
\begin{equation*}
\xymatrix@C=10mm@R=4mm{%
G &       & H & & K \\
   &\;D\;\ar@{_{(}->}|w_{h_l}[lu]\ar@{^{(}->}|w^{h_r}[ru] &  & \;D'\;\ar@{_{(}->}|w_{h'_l}[lu]\ar@{^{(}->}|w^{h'_r}[ru]\\
   & &  D''\ar@{^{(}->}_{h''_l}[lu]\ar@{_{(}->}^{h''_r}[ru] {\pullbackcorner[d]}& &  }
\end{equation*}

\newcommand{\newG}{\actiongraphlong{\sigma_G}{G}}
\newcommand{\sigmaDprim}{\actionembactionlong{\sigma_H}{h'_l}}
\newcommand{\sigmaDprimprim}{\actionembactionlong{\sigma_H}{(h_rh''_l)}}
\newcommand{\newDprimprim}{\actiongraphlong{(\sigmaDprimprim)}{D''}}
\newcommand{\newDprimprimbis}{\actiongraphlong{(\actionembactionlong{\sigma_G}{(h_lh''_l)})}{D''}}
\newcommand{\newK}{\actiongraphlong{\sigma_K}K}
\newcommand{\newH}{\actiongraphlong{\sigma_H}H}
\newcommand{\sigmaD}{\actionembactionlong{\sigma_H}{h_r}}
\newcommand{\newD}{\actiongraphlong{(\sigmaD)}{D}}
\newcommand{\newDprim}{\actiongraphlong{(\sigmaDprim)}{D'}}
\newcommand{\newhpriml}{\actionembemblong{\sigma_H}{h'_l}}
\newcommand{\newhprimr}{\actionembemblong{\sigma_K}{h'_r}}
\newcommand{\newhprimprimr}{\actionembemblong{(\sigmaDprim)}{h''_r}}
\newcommand{\newhprimpriml}{\actionembemblong{(\sigmaD)}{h''_l}}
\newcommand{\newhprimprimrbis}{\actionembemblong{\sigma_K}{(h'_rh''_r)}}
\newcommand{\newhprimprimlbis}{\actionembemblong{\sigma_G}{(h_lh"_l)}}
\newcommand{\newhl}{\actionembemblong{\sigma_G}{h_l}}
\newcommand{\newhr}{\actionembemblong{\sigma_H}{h_r}}
By Def.~\ref{def:image-pe}, the image $\actionpartialemblong{\sigma_G}{\sigma_K}{(h'h)}$ of the weak partial embedding $h'h$ by the pair of transformation $(\sigma_G,\sigma_K)$ is defined as the following weak partial embedding:
\begin{equation*}
\newG \lvvlongweakembedding[\actionembemblong{\sigma_G}{(h_lh"_l)}] \newDprimprimbis
  \rvvlongweakembedding[\actionembemblong{\sigma_K}{(h'_rh''_r)}] \newK.
\end{equation*}
Furthermore:
\begin{enumerate}
\item by Lem.~\ref{image:square:we}, we have:
\begin{equation*}
\actioncomposeweakemblong{\sigma_H}{h_r}{h''_l}=\actioncomposeweakemblong{\sigma_H}{h'_l}{h''_r};
\end{equation*}
\item
\begin{equation*}
\begin{array}{ll}
\actionembactionlong{\sigma_G}{(h_lh''_l)} = \actionembactionlong{\actionembactionlong{\sigma_G}{h_l}}{h''_l} &  \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositionc}))}\cr
\actionembactionlong{\sigma_G}{(h_lh''_l)} = \actionembactionlong{\actionembactionlong{\sigma_H}{h_r}}{h''_l} & \text{(by Def.~\ref{def:image-pe})}\cr
\end{array}
\end{equation*}
\item  we also have:
\begin{equation*}
\hspace*{-5mm}\begin{array}{ll}
\actionembemblong{\sigma_G}{({h_l}{h''_l})}=\actioncomposeweakemblong{\sigma_G}{h_l}{h''_l} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiond}))}\cr
\actionembemblong{\sigma_G}{({h_l}{h''_l})}=(\actionembemblong{\sigma_G}{h_l})(\actionembemblong{(\actionembactionlong{\sigma_H}{h_r})}{h''_l}) & \text{(by Def.~\ref{def:image-pe})}\cr
\end{array}
\end{equation*}
\item  and:
\begin{equation*}
\hspace*{-5mm}\begin{array}{ll}
\actionembemblong{\sigma_K}{({h'_r}{h''_r})}=\actioncomposeweakemblong{\sigma_K}{h'_r}{h''_r} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiond}))}\cr
\actionembemblong{\sigma_K}{({h'_r}{h''_r})}=(\actionembemblong{\sigma_K}{h'_r})(\actionembemblong{(\actionembactionlong{\sigma_H}{h_r})}{h'_l}) & \text{(by Def.~\ref{def:image-pe})}\cr
\end{array}
\end{equation*}
\item by Def.~\ref{def:permutation:embeddings}, the weak embeddings $\newhprimpriml$ and $\newhprimprimr$ are both embeddings.
\end{enumerate}

Thus,  we get the following commutative diagram:
\begin{equation*}
\xymatrix@C=1mm@R=8mm{%
\newG &                        & \newH &  & \newK \\
           &  \newD\;\ar@{_{(}->}|w_{\newhl}[lu]\ar@{^{(}->}|w^{\newhr}[ru] &  & \;\newDprim\;\ar@{_{(}->}|w_{\newhpriml}[lu]\ar@{^{(}->}|w^{\newhprimr}[ru]\\
    & &
   \newDprimprim
   \ar@{_{(}->}^{\newhprimpriml}[lu]
   \ar@/^{1.5cm}/@{_{(}->}|w^{\newhprimprimlbis}[lluu]
   \ar@{^{(}->}_{\newhprimprimr}[ru]
  \ar@/_{1.5cm}/@{^{(}->}|w_{\newhprimprimrbis}[rruu] & & }
\end{equation*}



We want to prove that the weak partial embedding:
\begin{equation*}
\newG \lvvlongweakembedding[\actionembemblong{\sigma_G}{(h_lh"_l)}] \newDprimprimbis
  \rvvlongweakembedding[\actionembemblong{\sigma_K}{(h'_rh''_r)}] \newK,
\end{equation*}
is the composition of the weak partial embedding:
\begin{equation*}
\newG \lvlongweakembedding[\newhl] \newD \rvlongweakembedding[\newhr] \newH
\end{equation*}
and the weak partial embedding:
\begin{equation*}
\newH \lvlongweakembedding[\newhpriml] \newDprim \rvlongweakembedding[\newhprimr] \newK.
\end{equation*}
By Sec.~\ref{sec:pe} and the previous commuting diagram, it is enough to prove that the following weak partial embedding:
\begin{equation*}
\newD \lvlongweakembedding[\newhprimpriml] \newDprimprim \rvlongweakembedding[\newhprimprimr]\!\newDprim
\end{equation*}
is a pullback of the following cospan:
\begin{equation*}
\newD \rvlongweakembedding[\newhr] \newH\lvlongweakembedding[\newhpriml]Â \newDprim.
\end{equation*}


Let us consider:
\begin{equation*}
\newD \lvlongweakembedding[h'''_l] D''' \rvlongweakembedding[h'''_r]Â \newDprim
\end{equation*}
a pullback of the cospan:
\begin{equation*}
\newD \rvlongweakembedding[\newhr] \newH\lvlongweakembedding[\newhpriml]Â \newDprim.
\end{equation*}

By definition of a pullback, there exists a (unique) embedding $\phi$ between $\newDprimprim$ and $D'''$ such that
$\newhprimpriml=h'''_l\phi$ and $\newhprimprimr=h'''_r\phi$. Thus we get the following
 commutative diagram commutes:
\begin{equation*}
\xymatrix@C=0mm@R=8mm{%
&       & \newH & &  \\
   &\;\newD\; \ar@{^{(}->}|w^{\newhr}[ru] &  & \;\newDprim\;\ar@{_{(}->}|w_{\newhpriml}[lu]   \\
   & &
   D''' \ar@{_{(}->}_{h'''_l}[lu]
   \ar@{^{(}->}^{h'''_r}[ru]\pullbackcorner[d]
\\
   &&\begin{minipage}{2cm}
   \vspace*{3mm}  \hspace*{-2mm}$\newDprimprim$
   \end{minipage}
   \ar@{^{(}->}^{\newhprimpriml}[luu]
   \ar@{_{(}->}_{\newhprimprimr}[ruu]
   \ar@{^{(}.>}_{\phi}[u]
}
\end{equation*}

Now we apply the transformation $\sigma_H^{-1}$ on the top of this commutative diagram, and we propagate it downwards the commutative square and both commutative triangles by applying successively Lem.~\ref{image:square:we}, and Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiond}) (twice), and Def.~\ref{def:permutation:embeddings} (six times).


\newcommand{\nnewsigmaH}{\sigma_H^{-1}}
\newcommand{\nnewH}{\actiongraphlong{\nnewsigmaH}{(\newH})}
\newcommand{\nnewD}{(\actiongraphlong{(\actionembactionlong{\nnewsigmaH}{(\newhr)})}{(\newD)}}
\newcommand{\nnewDprim}{(\actiongraphlong{(\actionembactionlong{\newH}{\newhpriml})}{(\newDprim)}}
\newcommand{\nnewDprimprimprim}{}
\newcommand{\nnewDprimprim}{}
\newcommand{\nnewhr}{\actionembemblong{\nnewsigmaH}{(\newhr)}}
\newcommand{\nnewhl}{}
\newcommand{\nnewhpriml}{\actionembemblong{\nnewsigmaH}{(\newhpriml)}}
\newcommand{\nnewhprimr}{}
\newcommand{\nnewhprimprimpriml}{\actionembemblong{(\actionembactionlong{\sigma_H^{-1}}{(\actionembemblong{\sigma_H}{h_r})})}{h'''_l}}
\newcommand{\nnewhprimprimprimr}{\actionembemblong{(\actionembactionlong{\sigma_H^{-1}}{(\actionembemblong{\sigma_H}{h'_l})})}{h'''_r}}
\newcommand{\nnewhprimpriml}{}
\newcommand{\nnewhprimprimr}{}
\newcommand{\nnewphi}{}

Since, the seven following equalities:
\newcommand{\equshort}[3]{\begin{equation*}
\begin{array}{ll}
{#1{\sigma^{-1}_H}{({#1{\sigma_H}{#2}})}}={#1{(\sigma^{-1}_H \circ_H \sigma_H)}{#2}} & \text{(by Def.~#3)}\cr
{#1{\sigma^{-1}_H}{({#1{\sigma_H}{#2}})}}={#1{\varepsilon_H}{#2}} &\text{(by Def.~\ref{def:group})}\cr
{#1{\sigma^{-1}_H}{({#1{\sigma_H}{#2}})}}=#2 & \text{(by Def.~#3)}
\end{array}
\end{equation*}}
\newcommand{\equbisshort}[5]{\begin{equation*}
\hspace*{-5mm}\begin{array}{ll}
\hspace*{3.5mm}{#1{(\actionembactionlong{\sigma^{-1}_H}{(\actionembemblong{\sigma_H}{#3})})}{({#1{(\actionembactionlong{\sigma_H}{#3})}{#2}})}} & \cr
=#1{((\actionembactionlong{\sigma^{-1}_H}{(\actionembemblong{\sigma_H}{#3})})\circ_{#5}(\actionembactionlong{\sigma_H}{#3}))}{#2}  & \text{(by Def.~#4)}\cr
=#1{(\actionembactionlong{(\sigma_H^{-1}\circ_H\sigma_H)}{#3})}{#2} & \text{(by Def.~\ref{defn:compositiondistributeoversymetries}.(\ref{defn:permutationcarryproduct})}\cr
=#1{(\actionembactionlong{\varepsilon_H}{#3})}{#2} & \text{(by Def.~\ref{def:group})}\cr
=#1{\varepsilon_{#5}}{#2} & (\text{by Def.~\ref{defn:compositiondistributeoversymetries}.(\ref{defn:permutationcarryidentity})})\cr
=#2   & \text{(by Def.~#4)}
\end{array}
\end{equation*}}
\begin{enumerate}
\item {\equshort{\actiongraphlong}{H}{\ref{defn:permutation}.(2)}}
\item {\equshort{\actionembemblong}{h_r}{\ref{defn:compositiondistributeoversymetries}.(1)}}
\item {\equshort{\actionembemblong}{h'_l}{\ref{defn:compositiondistributeoversymetries}.(1)}}
\item {\equbisshort{\actiongraphlong}{D}{h_r}{\ref{defn:permutation}.(2)}{D}}
\item {\equbisshort{\actiongraphlong}{D'}{h'_l}{\ref{defn:permutation}.(2)}{D'}}
\item {\equbisshort{\actionembemblong}{h''_l}{h_r}{\ref{defn:compositiondistributeoversymetries}.(1)}{D}}
\item {\equbisshort{\actionembemblong}{h''_r}{h'_l}{\ref{defn:compositiondistributeoversymetries}.(1)}{D'}}
\end{enumerate}
hold, we obtain the following commutative diagram:
\newcommand{\nnewsigmaDprimprimprimshort}{\sigma_{D'''}}
\newcommand{\nnewsigmaDprimprimprim}{\actionembactionlong{\sigma_H^{-1}}{((\newhr)h'''_l)}}
\begin{equation*}
\xymatrix@C=18mm@R=10mm{%
      & H &   \\
   D   \ar@{^{(}->}|w^{h_r}[ru] &  & \;D'\;\ar@{_{(}->}|w_{h'_l}[lu]\\
    & D'' \ar@{_{(}->}_{h''_l}[lu]
               \ar@{^{(}->}^{h''_r}[ru]
               \ar@{_{(}->}^(0.2){\actionembemblong{\nnewsigmaDprimprimprimshort}{\phi}}[d]
               \pullbackcorner[d]\\
    & \actiongraphlong{\nnewsigmaDprimprimprimshort}{D'''} \ar@{_{(}->}^{\nnewhprimprimpriml}[luu]\ar@{^{(}->}_{\nnewhprimprimprimr}[ruu]%\\
  }
\end{equation*}
where $\nnewsigmaDprimprimprimshort=\nnewsigmaDprimprimprim$.

Since  the partial embedding:
\begin{equation*}
D \llongembedding[h''_l] D''\rlongembedding[h''_r] D'
\end{equation*}
is a pullback of the span:
\begin{equation*}
D \rlongweakembedding[h_r] H \llongweakembedding[h'_\ell] D',
\end{equation*}
there exists a (unique) embedding between the site graph $\actiongraphlong{\nnewsigmaDprimprimprimshort}{D'''}$ and the site graph $D''$.
It follows that the embedding $\actionembemblong{\nnewsigmaDprimprimprimshort}{\phi}$ is an isomorphism.

Thus, by Prop.~\ref{propagation:iso}, the embedding $\phi$ is an isomorphism as well, which ensures that $D''$ and the span
\begin{equation*}
\newD \lvlongweakembedding[\newhprimpriml] \newDprimprim \rvlongweakembedding[\newhprimprimr]\!\newDprim
\end{equation*}
is a pullback of the cospan:
\begin{equation*}
\newD \rvlongweakembedding[\newhr] \newH\lvlongweakembedding[\newhpriml]Â \newDprim.
\end{equation*}
\end{proof}




{{\newcommand{\newhprim}{\actionpartialemblong{\sigma_{L'}}{\sigma_{R'}}{h'}}%
\newcommand{\newf}{\actionembemblong{\sigma_{L'}}{f}}%
\newcommand{\newg}{\actionembemblong{\sigma_{R'}}{g}}%
\newcommand{\newsigmal}{\actionembactionlong{\sigma_{L'}}{f}}%
\newcommand{\newsigmar}{\actionembactionlong{\sigma_{R'}}{g}}%
\newcommand{\newh}{\actionpartialemblong{\newsigmal}{\newsigmar}{h}}%
\begin{prop}\label{prop-sym-square}
Let $\groupset$ be a valid set of transformations over site graphs.
Let $L$, $R$, $D$, $L'$, $R'$, and $D'$ be six site graphs.
Let $h$ be a partial embedding between the site graphs $L$ and $R$ with the domain $D$,
$h'$ be a partial embedding between the site graphs $L'$ and $R'$ with the domain $D'$,
$f$ be an embedding between the site graph $L$ and the site graph $L'$, and
$g$ be an embedding between the site graph $R$ and the site graph $R'$, such that: $h'f=gh$.

Let $(\sigma_{L'},\sigma_{R'})\in\groupset[h']$ be a pair of transformations that can be applied to the partial embedding $h'$, such that the pair of transformation  $(\actionembactionlong{\sigma_{L'}}{f},\actionembactionlong{\sigma_{R'}}{g})$ can be applied to the partial embedding $h$ ({\ie}such that $(\actionembactionlong{\sigma_{L'}}{f},\actionembactionlong{\sigma_{R'}}{g})\in\groupset[h]$).

Then the following assertion holds:
\begin{equation*}
(\newhprim)(\newf)=(\newg)(\newh).
\end{equation*}
\end{prop}
\begin{proof}
Let $\groupset$ be a valid set of transformations over site graphs.
Let $L$, $R$, $D$, $L'$, $R'$, and $D'$ be six site graphs.
Let $h$ be a partial embedding between the site graphs $L$ and $R$ with the domain $D$,
$h'$ be a partial embedding between the site graphs $L'$ and $R'$ with the domain $D'$,
$f$ be an embedding between the site graph $L$ and the site graph $L'$, and
$g$ be an embedding between the site graph $R$ and the site graph $R'$, such that: $h'f=gh$.

Let   $(\sigma_{L'},\sigma_{R'})\in\groupset[h']$ be a pair of transformations that can be applied to the partial embedding $h'$,
such that $(\actionembactionlong{\sigma_{L'}}{f},\actionembactionlong{\sigma_{R'}}{g})\in\groupset[h]$.

We have:
\begin{enumerate}
\item $(\sigma_{L'},\sigma_{R'})\in\groupset[h']$;
\item $(\actionembactionlong{\sigma_{L'}}{f},
        \actionembactionlong{\sigma_{R'}}{g})\in\groupset[h']$;
\item $(\actionembactionlong{\sigma_{L'}}{f},\sigma_{L'})\in\groupset[(\identity[L],f)]$ (by Prop.~\ref{prop:sym-equ-pe-e});
\item  $(\actionembactionlong{\sigma_{R'}}{g},\sigma_{L'})\in\groupset[(\identity[L],f)]$ (by Prop.~\ref{prop:sym-equ-pe-e}).
\end{enumerate}
It follows that:
\begin{equation*}
\hspace*{-2mm}\begin{array}{ll}
\hspace*{3.5mm}(\newhprim)(\newf) \cr
= (\newhprim)(\actionpartialemblong{(\actionembactionlong{\sigma_{L'}}{f})}{\sigma_{L'}}{(\identity{L},f)}) &\text{(by Prop.~\ref{prop:sym-equ-pe-e})} \cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{L'}}{f})}{\sigma_{R'}}{(h'f)} &\text{(by Prop.~\ref{prop:dist-sym-pe})} \cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(h'f)} &\text{(by Def.~\ref{def:group-partialemb})}\cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(gh)} &\text{(since $h'f=fh$)} \cr
= (\actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(\identity{R},g)})(\newh) \hspace*{-3mm}\mbox{}&\text{(by Prop.~\ref{prop:dist-sym-pe})} \cr
= (\newg)(\newh) &\text{(by Prop.~\ref{prop:sym-equ-pe-e})}
\end{array}
\end{equation*}
\end{proof}}}


\subsubsection{Induced group action over rules}



Now we focus of the case when the partial embedding is a rule.  By Def.~\ref{def:permutation:rule}, the image of a rule by a pair of transformations in a valid set of transformations over site graphs, is a rule.  Thus the structure of group action can be lifted to rules, as expressed in the following proposition.
\begin{prop}[action of pair of transformations over rules]
\label{prop:rule:groupaction}Let $\groupset[]$ be a valid set of transformations  over site graphs and $r$ be a rule.

Then, the function which maps any pair $((\sigma_L,\sigma_R),r')$ in the set $\groupset[r]\times\{\actionembemblong{\sigma_r}{r}\;|\;\sigma_r\in\groupset[r]\}$, to the rule $\actionpartialemblong{\sigma_L}{\sigma_R}{r}$, is a group action.
\end{prop}


As it was the case for site graphs,
the number of automorphisms of a rule $r$  and the number of rules in its orbit  that are isomorphic to the rule $r$ are related by the following proposition.
\begin{prop}
\label{countisorule}Let $\group$ be a valid set of transformations over site graphs.
For any rule $r$ and for any pair of permutations $\sigma\in\groupset[r]$,
\begin{equation*}
\myfrac{\symrules{r}}{\symrules{\actionembemblong{\sigma}{r}}} =
\myfrac{\card([\actionembemblong{\sigma}{r}]_\iso \cap [\actionembemblong{\sigma}{r}]_{\groupequiv})}{\card( [r]_\iso \cap [r]_{\groupequiv})},
\end{equation*}
for any rule $r'$, the value $\symrules{r'}$ denotes the number of automorphisms of the rule $r'$ (that is say the number of pairs of automorphisms $(h_L,h_R)$ such that the triple $(r',h_L,h_R)$ is a refinement of the rule $r'$).
\end{prop}

\begin{myproof}
The proof is similar as the proof of Prop.~\ref{countiso}.
\end{myproof}


We notice that some constraints in Def.~\ref{def:permutation:rule} are redundant.
Indeed, it would have been enough to assume that the image of a rule by a pair of transformations in a valid set of transformations satisfies the constraints $2$, $3$ and $4$ of Def.~\ref{def:rule}. For any set of transformations $\groupset[]$ such that the restriction of the transformations in $\groupset[]$ to the domain of weak embeddings distributes both over the composition of transformations ({\eg}see def.~\ref{defn:compositiondistributeoversymetries}) and
over the composition of weak embeddings ({\eg}see def.~\ref{defn:symetriesdistributeovercomposition}), and such that  the image of an embedding by a transformation in $\groupset[]$ is an embedding ({\eg}see def.~\ref{def:permutation:embeddings}),  the image of a partial embedding $h$ the domain of which is maximal, by a pair of transformations in $\groupset[h]$, is also
a partial embedding the domain of which is maximal.
This is formalised in the following proposition.
{\newcommand{\sigmaD}{\actionembactionlong{\sigma_L}{f}}
\begin{prop}
\label{maxdomain}
Let $\groupset[]$ be a set of transformations over site graphs such that the restriction of the transformations in $\groupset[]$ to the domain of weak embeddings distributes both over the composition of transformations ({\eg}see def.~\ref{defn:compositiondistributeoversymetries}) and
over the composition of weak embeddings ({\eg}see def.~\ref{defn:symetriesdistributeovercomposition}), and such that  the image of an embedding by a transformation in $\groupset[]$ is an embedding ({\eg}see def.~\ref{def:permutation:embeddings}).
Let $L$, $R$, and $D$ be three site graphs. Let $f$ be an embedding between the site graphs $D$ and $L$, and $g$ be an embedding between the site graphs $D$ and $R$. We denote by $h$ the following partial embedding:
\begin{equation*}
h\;:\;L\llongembedding[f]D\rlongembedding[g]\!R.
\end{equation*}


We assume that the site graph $D$ is a maximal common site graph between the site graph $L$ and the site graph $R$, that is to say that we assume that for any site graph $D'$, any embedding $\phi$ between $D$ and $D'$,  any embedding $f'$ between the site graphs $D'$ and $L$, and any embedding $g'$ between the site graphs $D'$ and $R$, such that $f=f'\phi$ and $g=g'\phi$,  the embedding $\phi$ is necessarily an isomorphism.
{
\newcommand{\newr}{}
\newcommand{\newL}{L}
\newcommand{\newR}{R}
\newcommand{\newD}{D}
\newcommand{\newf}{f}
\newcommand{\newg}{g}
\newcommand{\newpsi}{\psi}
\newcommand{\newDprim}{D'}
\newcommand{\newfprim}{f\psi}
\newcommand{\newgprim}{g\psi}
\begin{equation*}
\xymatrix@C=25mm@R=3mm{%
{L} &                                 & {R} \\
                          & {}^{\;}D'^{\;\mbox{}}\ar@{_{(}->}_{f'}[ul]\ar@{^{(}->}^{g'}[ur] & \\\\
                          & {D}\ar@{->}|{\iso}^{\phi}[uu]\ar@{^{(}->}^{{f}}[uuul]\ar@{_{(}->}_{{g}}[uuur]   & \\}
\end{equation*}}


We consider $(\sigma_L,\sigma_R)\in\groupset[h]$ a pair of transformations in $\groupset[h]$ that can be applied to the partial embedding $h$.

Then, for any site graph $D''$, any embedding $f''$ between the site graph $D''$ and the site graph $\actiongraphlong{\sigma_L}{L}$, and any embedding $g''$ between the
site graph $D''$ and the site graph $\actiongraphlong{\sigma_R}{R}$, and any embedding $\phi''$ between the site graph  $\actiongraphlong{(\sigmaD)}{D}$ and the site graph $D''$, such that
$\actionembemblong{\sigma_L}{f}=f''\phi''$ and $\actionembemblong{\sigma_R}{g}=g''\phi''$, the embedding $\phi''$ is necessarily an isomorphism.
{\begin{equation*}
\xymatrix@C=15mm@R=4mm{%
\actiongraphlong{\sigma_L}{L} & & \actiongraphlong{\sigma_R}{R} \\
  & D''\ar@{_{(}->}_{f''}[ul]\ar@{^{(}->}^{g''}[ur] &  \\\\
  & \actiongraphlong{(\sigmaD)}{D}
\ar@{->}|{\iso}^(0.6){\phi''}[uu]
\ar@{^{(}->}^{\actionembemblong{\sigma_L}{f}}[uuul]\ar@{_{(}->}_{\actionembemblong{\sigma_R}{g}}[uuur]  &  \\}
\end{equation*}}
\end{prop}
\begin{proof}
We sketch the proof of Prop.~\ref{maxdomain}.
We take the same notations as in Prop.~\ref{maxdomain}.

By assumption, the following diagram:
\begin{equation*}
\xymatrix@C=15mm@R=4mm{%
\actiongraphlong{\sigma_L}{L} &                                 & \actiongraphlong{\sigma_R}{R} \\
                          & D''\ar@{_{(}->}_{f''}[ul]\ar@{^{(}->}^{g''}[ur] & \\\\
                          & \actiongraphlong{(\sigmaD)}{D}\ar@{^{(}->}^{\phi''}[uu]\ar@{^{(}->}^{\actionembemblong{\sigma_L}{f}}[uuul]\ar@{_{(}->}_{\actionembemblong{\sigma_R}{g}}[uuur]   & \\}
\end{equation*}
commutes.

Then, we apply the pair of transformations $(\sigma_L^{-1},\sigma_R^{-1})$ to the diagram above, and propagate both transformations $\sigma_L^{-1}$ and $\sigma_R^{-1}$ downwards by applying Def.~\ref{defn:symetriesdistributeovercomposition}.(\ref{compositiond}) (twice), and Def.~\ref{def:permutation:embeddings} (five times). Since the five following equalities:
{\newcommand{\equshort}[4]{\begin{equation*}
\begin{array}{ll}
{#1{\sigma^{-1}_{#4}}{({#1{\sigma_{#4}}{#2}})}}={#1{(\sigma^{-1}_{#4} \circ_{#4} \sigma_{#4})}{#2}} & \text{(by Def.~#3)}\cr
{#1{\sigma^{-1}_{#4}}{({#1{\sigma_{#4}}{#2}})}}={#1{\varepsilon_{#4}}{#2}} &\text{(by Def.~\ref{def:group})}\cr
{#1{\sigma^{-1}_{#4}}{({#1{\sigma_{#4}}{#2}})}}=#2 & \text{(by Def.~#3)}
\end{array}
\end{equation*}}
\newcommand{\equbisshort}[6]{\begin{equation*}
\hspace*{-5mm}\begin{array}{ll}
\hspace*{3.5mm}{#1{(\actionembactionlong{\sigma^{-1}_{#6}}{(\actionembemblong{\sigma_{#6}}{#3})})}{({#1{(\actionembactionlong{\sigma_{#6}}{#3})}{#2}})}} & \cr
=#1{((\actionembactionlong{\sigma^{-1}_{#6}}{(\actionembemblong{\sigma_{#6}}{#3})})\circ_{#5}(\actionembactionlong{\sigma_{#6}}{#3}))}{#2}  & \text{(by Def.~#4)}\cr
=#1{(\actionembactionlong{(\sigma_{#6}^{-1}\circ_{#6}\sigma_{#6})}{#3})}{#2} & \text{(by Def.~\ref{defn:compositiondistributeoversymetries}.(\ref{defn:permutationcarryproduct})}\cr
=#1{(\actionembactionlong{\varepsilon_{#6}}{#3})}{#2} & \text{(by Def.~\ref{def:group})}\cr
=#1{\varepsilon_{#5}}{#2} & (\text{by Def.~\ref{defn:compositiondistributeoversymetries}.(\ref{defn:permutationcarryidentity})})\cr
=#2   & \text{(by Def.~#4)}
\end{array}
\end{equation*}}
\begin{enumerate}
\item \equshort{\actiongraphlong}{L}{\ref{defn:permutation}.(2)}{L}
\item \equshort{\actiongraphlong}{R}{\ref{defn:permutation}.(2)}{R}
\item \equbisshort{\actiongraphlong}{D}{f}{\ref{defn:permutation}.(2)}{D}{L}
\item \equshort{\actionembemblong}{f}{\ref{defn:compositiondistributeoversymetries}.(1)}{L}
\item \equshort{\actionembemblong}{g}{\ref{defn:compositiondistributeoversymetries}.(1)}{R}
\end{enumerate}
the following diagram:
{\begin{equation*}
\xymatrix@C=35mm@R=4mm{%
L & & R \\
  & \actiongraphlong{\sigma_{D''}}{D''}\ar@{_{(}->}_{\actionembemblong{(\sigma^{-1}_L)}{f''}}[ul]\ar@{^{(}->}^{\actionembemblong{(\sigma^{-1}_R)}{g''}}[ur] &  \\\\
  & D
\ar@{^{(}->}^(0.6){\actionembemblong{\sigma_{D''}}{\phi''}}[uu]
\ar@{^{(}->}^{f}[uuul]\ar@{_{(}->}_{g}[uuur]  &  \\}
\end{equation*}}
where the transformation $\sigma_{D''}\in\groupset[D'']$ is defined as $\actionembactionlong{(\sigma^{-1}_L)}{f''}$, commutes.

Since $D$ is maximal, it follows that $\actionembemblong{\sigma_{D''}}{\phi''}$ is an isomorphism. So, by Prop.~\ref{propagation:iso}, $\phi''$ is an isomorphism (and thus the domain $\actiongraphlong{(\actionembactionlong{\sigma_L}{f})}{D}$ of the partial embedding $\actionpartialemblong{\sigma_L}{\sigma_R}{h}$ is maximal as well).
}\end{proof}}


\subsubsection{Induced group action over refinements}

We are now almost ready to apply pairs of transformations over refinements.
Before proving that the image of refinements by a pair of transformations is indeed a refinement, we prove two intermediary lemmas.


\begin{lemma}\label{lem:twope}
Let $L$, $R$, and $R'$ be three site graphs.
Let $r$ be a rule between the site graphs $L$ and $R$ and $r'$ be a rule between the site graphs $L$ and $R'$.
We assume that there exists a weak embedding $\phi$ between the site graph $R$ and $R'$ and $\phi'$ be a weak a weak embedding $\phi'$ between the site graph $R'$ and $R$ such that we have $r'={\phi}r$ and $r=\phi'r'$.
%\begin{equation*}
%\xymatrix@C=8mm@R=7mm{%
%&&&R'&&&&R&&	&&\\
%L\ar@{-|>}_{r}[rr] \ar@{-|>}^{r'}[rrru]&&
%R\ar@{^{(}->}|w_{\phi}[ru] &&
%L\ar@{-|>}_{r'}[rr] \ar@{-|>}^{r}[rrru]&&
%R'\ar@{^{(}->}|w_{\phi'}[ru]}
%\end{equation*}
Under these assumptions, the weak embeddings $\phi$ and $\phi'$ are two isomorphisms.
\end{lemma}
\begin{proof}
Let $L$, $R$, and $R'$ be three site graphs.
Let $r$ and $r'$ be two rules between the site graphs $L$ and $R$, and $L$ and $R'$.  Let $\phi$ and $\phi'$ be two weak embeddings between the site graphs $R$ and $R'$, and $R'$ and $R$ such that both $r'={\phi}r$ and $r=\phi'r'$.

Now we consider the set:
\begin{equation*}
\mathcal{B}\bydef\{s\in\sites[R]\;|\;\exists x\in\sites[R]\cup\ext\setminus\{\free\} \st (s,x)\in\links[R]\}
\end{equation*}
and the set:
\begin{equation*}
\mathcal{B}'\bydef\{s\in\sites[R']\;|\;\exists x\in\sites[R']\cup\ext\setminus\{\free\} \st (s,x)\in\links[R']\}.
\end{equation*}
Intuitively, $\mathcal{B}$ (resp.~$\mathcal{B}'$) denotes the set of the sites of the site graph $R$ (resp.~$R'$) that are necessarily bound. Since site graphs are finite. Both sets $\mathcal{B}$ and $\mathcal{B}'$ are finite. Since $\phi$ is a weak embedding between the site graphs $R$ and $R'$, it follows that:
\begin{equation*}
\card[\mathcal{B}] \leq \card[\mathcal{B}'].
\end{equation*}
Then, since $\phi'$ is a weak embedding between the site graphs $R'$ and $R$, it follows that:
\begin{equation*}
\card[\mathcal{B}'] \leq \card[\mathcal{B}].
\end{equation*}
Thus, \begin{equation*}\card[\mathcal{B}] = \card[\mathcal{B}'],\end{equation*}
and for any site $(n,i)\in\sites[R]$, we have $(n,i)\in\mathcal{B}$ is and only if $(\phi(n),i)\in\mathcal{B}'$.

Now we can prove that the weak embedding $\phi$ is an embedding.
It is indeed sufficient to prove that for any site $(n,i)\in\sites[R]$ such that $((n,i),\free)\in\links[R]$ , we have $((\phi(n),i),\free)\in\links[R']$ (that is to say that the image, by $\phi$ of any site that is in free in the site graph $R$, is free as well in the site graph $R'$).

Let $(n,i)\in\sites[R]$ be a site in the site graph $R$, such that $((n,i),\free)\in\links[R]$.

Let us write the rule $r$ as a partial embedding:
\begin{equation*}
r\;:\;L\llongembedding[f]D\rlongembedding[g]R.\end{equation*}

By Sect.~\ref{sec:pe}, since $r'={\phi}r$, the following partial embedding:
\begin{equation*}
L\llongembedding[f]D\rlongembedding[{\phi}g] R'
\end{equation*}
is a valid representation of the rule $r'$.

Thus, there exists an isomorphism $\psi$ between the site graphs $D$ and $D'$ such that $f=f'\psi $ and ${\phi}g=g'\psi$.

It follows that the following diagram
\begin{equation*}
\xymatrix@C=8mm@R=7mm{%
 L  &&    &  & && R' \\
   & && D'
    \ar@{^{(}->}_{f'}[lllu]\ar@{^{(}->}^{g'}[rrru]  & & R \ar@{^{(}->}|w_{\phi}[ru] & &\\
   & &&    & \\
    &   && D\ar@{->}|{\iso}_{\psi}[uu]\ar@{^{(}->}^{f}[llluuu]\ar@{^{(}->}_{g}[rruu] & & \\
}%
\end{equation*}
commutes.

Let us consider two cases, according to whether or not, the agent $n$ has been created by the rule $r$, or not.
\begin{enumerate}
\item If $n\not\in \im(g)$. ({\ie}if the agent $n$ has been created by the rule $r$)

Then $\phi(n)\not\in\im(g')$.

Otherwise, \\
\hspace*{3mm}
\begin{minipage}{0.95\linewidth}
there would exists an agent $m\in\agents[D']$ such that: \begin{equation*}g'(m)=\phi(n);\end{equation*}

then, we would have:
\begin{equation*}
\phi(g(\psi^{-1}(m)))=\phi(n);
\end{equation*}
and, since the function $\phi$ is into, it would follow that:
\begin{equation*}g(\psi^{-1}(m))=n,\end{equation*}
which would be absurd. \smallskip\\
\end{minipage}

By Def.~\ref{def:rule}.(4), it follows that there exists a binding state $x\in \sites[R']\cup\{\free\}$ such that $((\phi(n),i),x)\in\links[R']$.
\item If $n\in\im(g)$.

Let $m\in\agents[D]$ such that $g(m)=n$.

We have, $((g(m),i),\free)\in\links[R]$.

Thus, by Def.~\ref{def:rule}.(3a), there exists a binding state $x\in \sites[L]\cup\ext$ such that $((f(m),i),x)\in\links[L]$.

Since $f=f'\psi$, it follows that  $((f'(\psi(m)),i),x)\in\links[L]$.

So, by Def.~\ref{def:rule}.(3a), there exists a binding state $x'\in \sites[R']\cup\ext$ such that $((g'(\psi(m)),i),x')\in\links[R']$.

Since $g'\psi={\phi}g $, it follows that $((\phi(g(m)),i),x')\in\links[R']$.

That is to say that $((\phi(n),i),x')\in\links[R']$.
\end{enumerate}

Thus, in both cases, there exists a binding state $x'\in \sites[R']\cup\ext$ such that $((\phi(n),i),x')\in\links[R']$.

Then, since $((n,i),\free)\in\links[R]$, we have $(n,i)\not\in\mathcal{B}$.

It follows that $(\phi(n),i)\not\in\mathcal{B}'$.

So $((\phi(n),i),\free)\in\mathcal{B}'$.

This way, the partial embedding $\phi$ is an embedding.

With the same reasoning, up to replacing
the site graph $R$ by the site graph $R'$ and \emph{vice versa},
the rule $r$ by the rule $r'$ and \emph{vice versa},
and the partial embedding $\phi$ by the partial embedding $\phi'$ and \emph{vice versa},
we can conclude that the partial embedding $\phi'$ is an embedding as well.

Thus, $\phi$ is an embedding between the site graph $R$ and $R'$ and $\phi'$ is an embedding between the site graph $R'$ and the site graph $R$, so $R$ and $R'$ are two isomorphic site graphs, and the embeddings $\phi$ and $\phi'$ are both isomorphisms.
\end{proof}

{\newcommand{\newhprim}{\actionpartialemblong{\sigma_{L'}}{\sigma_{R'}}{r'}}%
\newcommand{\newf}{\actionembemblong{\sigma_{L'}}{h_L}}%
\newcommand{\newg}{\actionembemblong{\sigma_{R'}}{h_R}}%
\newcommand{\newsigmal}{\actionembactionlong{\sigma_{L'}}{h_L}}%
\newcommand{\newsigmar}{\actionembactionlong{\sigma_{R'}}{h_R}}%
\newcommand{\newh}{\actionpartialemblong{\newsigmal}{\newsigmar}{r}}



\begin{lemma}\label{lem:image_square}
Let $\groupset[]$ be a set of valid set of transformations over site graphs. Let $r$ be a rule and $(r',h_L,h_R)$ be a refinement of $r$.
%\begin{equation*}
%\xymatrix@C=16mm@R=7mm{%
%\ar@{-|>}^{r'}[rr]&&\pushoutcorner[ld]\\
%&&\\
%\ar@{-|>}^{r}[rr]
%\dummy\ar@{^{(}->}^{h_L}[uu]&&
%\dummy\ar@{^{(}->}_{h_R}[uu]}
%\end{equation*}
Under these assumptions, for any pair $(\sigma_{L'},\sigma_{R'})\in\groupset[r]$ of transformations that  can be applied to the rule $r'$, both following assertions hold:
\begin{enumerate}
\item $(\actionembactionlong{\sigma_{L'}}{h_L},\actionembactionlong{\sigma_{R'}}{h_R})\in\groupset[h]$;
\item $(\newhprim)(\newf)$

$=(\newg)(\newh)$.
\end{enumerate}
%\begin{equation*}
%\xymatrix@C=16mm@R=5mm{%
%\ar@{-|>}^{\newhprim}[rr]&&\\%\pushoutcorner[ld]\\
%&&\\
%\ar@{-|>}^{\newh}[rr]
%\dummy\ar@{^{(}->}^{\newf}[uu]&&
%\dummy\ar@{^{(}->}_{\newg}[uu]}
%\end{equation*}
\end{lemma}

\begin{proof}
Let $\groupset[]$ be a set of valid set of transformations over site graphs. Let $r$ be a rule and $(r',h_L,h_R)$ be a refinement of $r$. Let $(\sigma_{L'},\sigma_{R'})\in\groupset[r]$ be a pair of transformations  which can be applied to the rule $r'$.

\begin{enumerate}
\item We write the rule $r$ as a pair of two embedding $f$ and $g$, and the rule $r'$ as a pair of two embedding $f'$ and $g'$. We denote  by $h_D$ the embedding between the domain of the rule $r$ and the domain of the rule $r'$ which makes the following diagram commutes:
%\begin{equation*}
%\xymatrix@C=10mm@R=4mm{%
%\dummy\ar@{-|>}^{r'}[rrrrr] & & &  & & \dummy %\pushoutcorner[dl]\\
%   & & \dummy\ar@{_{(}->}^{f'}[ull]
%         \ar@{_{(}->}_{g'}[urrr]
%&&&\\
%   & &    & & & \\
%\dummy
%\ar@{-|>}^(0.65){r}[rrrrr]
%\ar@{^{(}->}_{h_L}[uuu]
%& & & &  & \dummy
%\ar@{^{(}->}_{h_R}[uuu]
%\\
%  & & \dummy
%\ar@{^{(}->}_(0.7){h_D}[uuu]
%\ar@{^{(}->}^{f}[ull]
%\ar@{_{(}->}_{g}[urrr]
%& &&  \\}
%\end{equation*}




We have:
{\renewcommand{\lhs}{\actionembactionlong{(\actionembactionlong{\sigma_{L'}}{h_L})}{f}}
\begin{equation*}
\begin{array}{ll}
\lhs=\actionembactionlong{\sigma_{L'}}{(h_Lf)} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))}
\cr
\lhs=\actionembactionlong{\sigma_{L'}}{(f'h_D)} & \text{(since $h_Lf=f'h_D$)}\cr
\lhs=\actionembactionlong{(\actionembactionlong{\sigma_{L'}}{f'})}{h_D} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))} \cr
\lhs=\actionembactionlong{(\actionembactionlong{\sigma_{R'}}{g'})}{h_D} & \text{(since $(\sigma_{L'},\sigma_{R'})\in\groupset[r'])$}\cr
\lhs=\actionembactionlong{\sigma_{R'}}{(g'h_D)} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))} \cr
\lhs=\actionembactionlong{\sigma_{R'}}{(h_Rg)} & \text{(since $g'h_D=h_Rg$)}\cr
\lhs=\actionembactionlong{(\actionembactionlong{\sigma_{R'}}{h_R})}{g} & \text{(by Def.~\ref{defn:symetriesdistributeovercomposition}.(3))}
\end{array}
\end{equation*}}

By Def.~\ref{def:image-pe}, it follows that:
$(\actionembactionlong{\sigma_{L'}}{h_L},\actionembactionlong{\sigma_{R'}}{h_R})\in\groupset[r]$.
\item By Prop.~\ref{prop-sym-square},
\begin{equation*}
\hspace*{-1cm}(\newhprim)(\newf)=(\newg)(\newh).
\end{equation*}
\end{enumerate}


\ignore{We have:
\begin{equation*}
\hspace*{-1cm}\begin{array}{ll}
\hspace*{3.5mm}(\newhprim)(\newf) \cr
= (\newhprim)(\actionpartialemblong{(\actionembactionlong{\sigma_{L'}}{f})}{\sigma_{L'}}{(\identity{L},f)}) &\text{(by Prop.~\ref{prop:sym-equ-pe-e})} \cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{L'}}{f})}{\sigma_{R'}}{(h'f)} &\text{(by Prop.~\ref{prop:dist-sym-pe})} \cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(h'f)} &\text{(by Def.~\ref{def:group-partialemb})}\cr
= \actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(gh)} &\text{(since $h'f=fh$)} \cr
= (\actionpartialemblong{(\actionembactionlong{\sigma_{R'}}{g})}{\sigma_{R'}}{(\identity{R},g)})(\newh) \hspace*{-3mm}\mbox{}&\text{(by Prop.~\ref{prop:dist-sym-pe})} \cr
= (\newg)(\newh) &\text{(by Prop.~\ref{prop:sym-equ-pe-e})}
\end{array}
\end{equation*}}
\end{proof}

\begin{prop}
\label{prop:carry:refinements}
\newcommand{\newdagshort}{%\begin{equation*}
%\xymatrix@C=30mm@R=10mm{%
%\ar@{-|>}^{\newrbis}[r] &  \pushoutcorner[dl] \\
%\ar@{^{(}->}^{\newhL}[u]\ar@{-|>}^{\newr}[r] & %{}^{}\ar@{^{(}->}_{\newhR}[u] \\
%}
%\end{equation*}
}
\newcommand{\newrbis}{r'}
\newcommand{\newr}{r}
\newcommand{\newhL}{h_L}
\newcommand{\newhR}{h_R}
\newcommand{\sigmaL}{\sigma_{L'}}
\newcommand{\sigmaR}{\sigma_{R'}}
Let $\groupset[]$ be a set of valid set of transformations over site graphs.
Let $r$ and $r'$ be two rules, $h_L$ an embedding between the left hand side of the rule $r$ and the left hand side of the rule $r'$, and $h_R$ an embedding between the right hand side of the rule $r$ and the right hand side of the rule $r'$.
Let $(\sigmaL,\sigmaR)\in\groupset[r']$ be a pair of transformations that can be applied to the tule $r'$.

Then,  the following two assertions are equivalent:
\begin{enumerate}
\item the triple $(r',h_L,h_R)$ is a refinement of the rule $r$;
{\newcommand{\sigmaLinv}{\sigma^{-1}_{L'}}
\newcommand{\sigmaRinv}{\sigma^{-1}_{R'}}
\newdagshort}%
{\renewcommand{\newr}{\actionpartialemblong{\actionembactionlong{\sigmaL}{h_L}}{\actionembactionlong{\sigmaR}{h_R}}{r}}%
\renewcommand{\newrbis}{\actionpartialemblong{\sigmaL}{\sigmaR}{r'}}%
\renewcommand{\newhL}{\actionembemblong{\sigmaL}{h_L}}%
\renewcommand{\newhR}{\actionembemblong{\sigmaR}{h_R}}%
\item
the triple $(\actionpartialemblong{\sigmaL}{\sigmaR}{r'},\actionembemblong{\sigmaL}{h_L},\actionembemblong{\sigmaR}{h_R})$ is a refinement of the rule $\newr$.
\newdagshort}
\end{enumerate}
\end{prop}

We can use Prop.~{prop:carry:refinements} to define a group action between any  valid set of transformations and refinements.

\begin{definition}[image of a refinement by a pair of transformations]
Let $\groupset[]$ be a set of transformations over site graphs.
We say that the refinement $(s,h_L,h_R)$ of a rule $r$ and the refinement
$(s',h'_L,h'_R)$ of the rule $r'$ are symetric to one another with respect to the set of transformations $\groupset[]$ if and only if there exists
a pair of transformations $(\sigma_L,\sigma_R)\in\groupset[r]$ such that:
\begin{itemize}
\item $s' = \actionpartialemblong{\sigma_L}{\sigma_R}{s}$;
\item $h'_L = \actionembemblong{\sigma_L}{h_L}$;
\item $h'_R = \actionembemblong{\sigma_R}{h_R}$;
\item $r' = \actionpartialemblong{(\actionembactionlong{\sigma_L}{h_L})}{(\actionembactionlong{\sigma_R}{h_R})}{r}$.
\end{itemize}
In such a case, we write $((s,h_L,h_R),r) \groupequiv ((s',h'_L,h'_R),r')$.
\end{definition}

\begin{prop}
Let $\groupset[]$ be a set of transformations over site graphs, then the relation $\groupequiv[]$ is an equivalence relation over the pairs $((r',h_L,h_R),r)$ such that $r$ is a rule and $(r',h_L,h_R)$ is a refinement of the rule $r$.
\end{prop}

\begin{prop}[action of pairs of transformations over refinements]
let $\groupset[]$ be a set of permutations over site graphs and $(s,h_L,h_R)$ be a refinement of a rule $r$.

The function mapping  any pair $((\sigma_L,\sigma_R),((s',h'_L,h'_R),r'))$ such that $(\sigma_L,\sigma_R)\in\groupset[s]$, $r'$ is a rule, $(s',h'_L,h'_R)$ is a refinement of the rule $r'$, and
$((s,h_l,h_R),r)\groupequiv ((s',h'_L,h'_R),r')$,

is a group action.
\end{prop}
\begin{todoproof}
\end{todoproof}}



\newcommand{\sigmaLbis}{\sigma_{L'}}
\newcommand{\sigmaRbis}{\sigma_{R'}}
\newcommand{\sigmaDbis}{\actionembactionlong{f'}{\sigmaLbis}}
\newcommand{\newDbis}{\actiongraphlong{(\sigmaDbis)}{{h_D}}}
\newcommand{\newfbis}{\actionembemblong{\sigmaLbis}{f'}}
\newcommand{\newLbis}{\actiongraphlong{\sigmaLbis}{L'}}
\newcommand{\newRbis}{\actiongraphlong{\sigmaRbis}{R'}}
\newcommand{\newhL}{\actionembemblong{\sigmaLbis}{h_L}}
\newcommand{\newhD}{\actionembemblong{(\sigmaDbis)}{h_D}}
\newcommand{\newhR}{\actionembemblong{\sigmaRbis}{h_R}}
\newcommand{\sigmaL}{\actionembactionlong{\sigmaLbis}{h_L}}
\newcommand{\sigmaR}{\actionembactionlong{\sigmaRbis}{h_R}}
\newcommand{\sigmaD}{\actionembactionlong{(\sigmaDbis)}{h_D}}
\newcommand{\newL}{\actiongraphlong{(\sigmaL)}{L}}
\newcommand{\newR}{\actiongraphlong{(\sigmaR)}{R}}
\newcommand{\newr}{\actiongraphlong{(\sigmaL,\sigmaR)}{r}}
\newcommand{\newrbis}{\actiongraphlong{(\sigmaLbis,\sigmaRbis)}{r'}}

\section{symetries in rule-based models}

So far, we have defined the notion of transformations over site graphs and we have shown how to apply these transformations over site graphs, embeddings, rules, and refinements of rules.

Now we will introduce the notion of symetries which are, intuitively,
transformations which leave a set of rules unchanged and investigate under which conditions it is possible to use these symetries so as to simplify the individual or the population semantics by considering states modulo symetries.

\subsection{symetries among a site graph}

First we introduce the notion of symetries among a site graph.
The notion of symetries depends on the level of observation.
In the individual semantics, we make the distinction between isomorphic site graphs. Thus, we say that a site graph is symetric with respect to a set of transformations over site graphs if, and only if,  it is equal to the image of itself by any transformation (which can be applied with it) in this set of transformations.
\begin{definition}
Let $\groupset[]$ be a set of transformations over site graphs.
A site graph $E$ is said to be symetric with respect to $\groupset[]$ if and only if for any transformation $\sigma_E\in\groupset[E]$ that can be applied to the site graph $E$, the site graphs $\actiongraphlong{\sigma_E}{E}$ and $E$ are the same.

In such a case, we write that the site graph $E$ is $\groupset$-symetric.
\end{definition}

Obviously, since a subset of transformations contains less transformations than the overlying set of transformations. Whenever a site graph is symetric with respect to a given set of transformations over site graphs, it is necessarily symetric with respect to any subset of this set of transformations, as stated in the following proposition.
\begin{prop}\label{prop:sub:sym}
Let $\groupset$ and $\groupsetprim$ be two sets of transformations over site graphs, such that the set $\groupsetprim$ is a subset of transformations of the set of transformations $\groupset$. Let $E$ be a site graph.

Under these assumtions, if the site graph $E$ is $\groupset$-symetric, then the site graph $E$ is $\groupsetprim$-symetric as well.
\end{prop}

\begin{figure*}
\subfigure[${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$]{\label{fig:sym:a}%
\incgraphics[0.3\linewidth]{generated_pictures/sym_dimer1_uu_pp.pdf}}
\hfill\subfigure[${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$]{\label{fig:sym:b}%
\incgraphics[0.3\linewidth]{generated_pictures/sym_dimer1_up.pdf}}
\hfill\subfigure[${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$]{\label{fig:sym:c}%
\incgraphics[0.3\linewidth]{generated_pictures/sym_dimer1_uu.pdf}}
\caption{Three sites graphs. The first one ${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$ is both $\groupsetone$-symetric and $\groupsettwo$- symetric; its $\iso$-equivalence class is both $\groupsetone$-symetric and $\groupsettwo$-symetric as well. The seconc one ${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$ is neither $\groupsetone$-symetric, nor $\groupsettwo$-symetric; but its $\iso$-equivalence class is $\groupsettwo$-symetric (but not $\groupsetone$-symetric). The third one ${\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}$  is neither $\groupsetone$-symetric, nor $\groupsettwo$-symetric; its $\iso$-equivalence class is neither $\groupsetone$-symetric, nor $\groupsettwo$-symetric too.}
\label{fig:sym}
\end{figure*}

\begin{example}\label{exmp:sym-sitegraph-one}
We take the same signature as in Exa.~\ref{exmp:siteswap}.
We consider both the set $\groupsetone$ of heterogeneous permutations of sites  (as defined in Exa.~\ref{exmp:siteswap}) and the set $\groupsettwo$ of the homogeneous permutations of sites (as defined in Exa.~\ref{exmp:siteswapbis}).

We consider the three site graphs that are drawn in Fig.~\ref{fig:sym}.
\begin{enumerate}
\item The following site graph: \begin{equation*}{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}\end{equation*} ({\eg}see Fig.~\ref{fig:sym:a}) is $\groupsetone$-symetric (thus, by Prop.~\ref{prop:sub:sym}, it is $\groupsettwo$-symetric as well). Indeed, in both of its agents, the site \sitefont{x} and the site \sitefont{y} have the same internal state, thus it does not change anything to swap the state of these two sites in a given agent.

\item The following site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
({\eg}see Fig.~\ref{fig:sym:b}) is not  $\groupsettwo$-symetric (and thus, by Prop.~\ref{prop:sub:sym}, it is not $\groupsetone$-symetric as well). In particular, if we apply the homogeneous permutation of sites $\{1,2\}$ which consists in swapping the state of the sites \sitefont{x} and \sitefont{y} both in the agent with the label $1$, and in the agent with label $2$, we get the following site graph:
 \begin{equation*}
 {\agent{A$_1$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
 \end{equation*}
 which is isomorphic to the initial one, but not equal.

\item The following site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
({\eg}see Fig.~\ref{fig:sym:c}) is not  $\groupsettwo$-symetric (and thus, by Prop.~\ref{prop:sub:sym}, it is not $\groupsetone$-symetric as well). In particular, if we apply the homogeneous permutation of sites $\{1,2\}$ which consists in swapping the state of the sites \sitefont{x} and \sitefont{y} both in the agent with the label $1$, and in the agent with label $2$, we get the following site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
which is not even isomorphic to the initial one.
\end{enumerate}
\end{example}


In the population semantics, site graphs are seen modulo isomorphisms.
As a consequence, we would like to relax the notion of symetry and say that a site graph is symetric with respect to a set of transformations over site graphs, whenever this site graph is isomorphic to the image of itself by each transformation  (which can be applied to it) in this set of transformations. So as to make sure that this definition makes sense, we have to check that whenever a site graph $E$ is such that the image of this site graph $E$ by each transformation that can be applied to it, is symetric to the site graph $E$ itself, then, any site graph that is isomorphic to the site graph $E$ also satifies this property. This is the purpose of the following proposition, which holds only for valid sets of transformations.

\begin{prop}
Let $\groupset$ be a valid set of transformations over site graphs and  $E$ and $F$ be two isomorphic site graphs.

If $[E]_{\groupequiv} \subseteq [E]_\iso$, then  $[F]_{\groupequiv} \subseteq [F]_\iso$.
\end{prop}

Now we can safely introduce the notion of symetric $\iso$-equivalence class of site graphs, as follows:
\begin{definition}\label{def:sym_iso}
Let $\groupset[]$ be a valid set of transformations over site graphs.
A class $[E]_{\iso}$ of $\iso$-equivalence of site graphs is said to be symetric if and only if for any transformation $\sigma_E\in\groupset[E]$ that  can be applied to the site graph  $E$, the site graphs $\actiongraphlong{\sigma_E}{E}$ and $E$ are isomorphic (\ie $[E]_{\groupequiv} \in [E]_{\iso}$).
\end{definition}

In the next propositions, we state that whenever a site graph is symetric with respect to a set of valid transformations, then its $\iso$-equivalence class is also symetric with respect to the same set of valid transformations, and that whenever the $\iso$-equivalence class of a site graph is symetric with respect to a set of valid transformations over site graphs, then it is also symetric with respect to any subset of this set of valid transformations.

\begin{prop}Let $\groupset$ be a valid set of transformations over site graphs, and $E$ be a site graph.

If the site graph $E$ is $\groupset[]$-symetric, then the $\iso$-equivalence class $[E]_{\iso}$ of the site graph $E$ is $\groupset[]$-symetric as well.
\end{prop}

\begin{prop}\label{prop:sub:sym:two}
Let $\groupset$ and $\groupsetprim$ be two valid sets of transformations over site graphs, such that the set $\groupsetprim$ is a subset of transformations of the set of transformations $\groupset$.

Let $E$ be a site graph. Under these assumptions, if the $\iso$-equivalence class $[E]_\iso$ of the site graph $E$ is $\groupset$-symetric, then the $\iso$-equivalence class $[E]_\iso$ of the site graph $E$ is $\groupsetprim$-symetric as well.
\end{prop}

\begin{example}\label{exmp:sym-sitegraph-two}
We take the same signature as in Exa.~\ref{exmp:siteswap}.
We consider both the set $\groupsetone$ of heterogeneous permutations of sites  (as defined in Exa.~\ref{exmp:siteswap}) and the set $\groupsettwo$ of the homogeneous permutations of sites (as defined in Exa.~\ref{exmp:siteswapbis}).

We consider the $\iso$-equivalence class of the three site graphs that are drawn in Fig.~\ref{fig:sym}.
\begin{enumerate}
\item The $\iso$-equivalence class of the site graph: \begin{equation*}{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}\end{equation*} ({\eg}see Fig.~\ref{fig:sym:a}) is both $\groupsetone$-symetric  and $\groupsettwo$-symetric,
 since this site graph is both $\groupsetone$-symetric and $\groupsettwo$-symetric ({\eg}see Exa.~\ref{exmp:sym-sitegraph-one}).

\item The $\iso$-equivalence class of the site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
({\eg}see Fig.~\ref{fig:sym:b}) is $\groupsettwo$-symetric, but  not  $\groupsetone$-symetric.
There are only two homogeneous permutations of sites that can be applied to this site graph, the identity permutation $\emptyset$ and the permutation $\{1,2\}$. The former one does not change the site graph (by definition), whereas the second one  consists in swapping the state of the sites \sitefont{x} and \sitefont{y} in both agents of the site graph, which transforms it into the following site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}.
\end{equation*}
We notice that the so-obtained site graph is isomorphic to the initial one. Now if we consider the set of heterogeneous permutations of sites, we can apply the permutation $\{1\}$,
which consists in swapping the state of the sites \sitefont{x} and \sitefont{y} in the agent with the label $1$,. As a result, we get the following site graph:
 \begin{equation*}
 {\agent{A$_1$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
 \end{equation*}
 which is not isomorphic to the initial one.

\item The $\iso$-equivalence class of the site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_u$\sitesep$\sitefont{y}_p$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
({\eg}see Fig.~\ref{fig:sym:c}) is not  $\groupsettwo$-symetric (and thus, by Prop.~\ref{prop:sub:sym:two}, it is not $\groupsetone$-symetric as well). In particular, if we apply the homogeneous permutation of sites $\{1,2\}$ which consists in swapping the state of the sites \sitefont{x} and \sitefont{y} both in the agent with the label $1$, and in the agent with label $2$, we get the following site graph:
\begin{equation*}
{\agent{A$_1$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_2$}{}@z}$}\agentsep\agent{A$_2$}{$\sitefont{x}_p$\sitesep$\sitefont{y}_u$\sitesep$\sitefont{z}^{\agent{A$_1$}{}@z}$}}
\end{equation*}
which is not isomorphic to the initial one.
\end{enumerate}
\end{example}


\subsection{symetries among a set of rules}

Defining the notion of symetries among a set of rules is more difficult.
One expect ta set of rules $X$ to be symetric with respect to a set of transformations over site graphs, if and only if, the image of a rule by a pair of transformations which can be applied with it, is also a rule in the set $X$ with the same corrected rate.  Yet, this definition is too restrictive, because rules can be defined modulo isomorphisms. As a consequence, in a symetric set of rules should remain symetric whenever we gather two isomorphic rules into a single one (while summing their rates) or whenever we split a rule into two (while preserving the overall rate).  We notice that it is easier to use families of rules instead of set of rules, since a given rule can occur twice in a family, unlike in a set.

We are going to proceed as follows. Firstly we will define a strong notion of symetry for family of rules, in which we do not see rules up to isomorphisms. Then, we will define a notion of equivalence among rule families, and we will define symetric families of rules are the ones which are equivalent to strongly symetric ones. Lastly we will provide a more convenient characterisation of symetric families of rules.


Firstly, we define a model as a family of rules.
\begin{definition}
A model is a family of pairs $(r_i,k_i)_{i\in I}$ indexed over a finite set $I$, where for each element $i\in I$, $r_i$ is a rule and $k_i$ is a rate constant in $\mathbb{R}_{\geq 0}$.
\end{definition}

We define, as follows,  strongly symetric models as the ones in which the image of each rule by each pair of transformations which can be applied to it, is another rule with the same corrected rate:
\begin{definition}[strongly symetric model]
\label{strongdef}
Let $M\bydef(r_i,k_i)_{i\in I}$ be a model and $\groupset$ be a valid set of transformations  over site graphs.

We say that the model $M$ is strongly symetric with respect to the set of transformations $\groupset$ if and only if:
\begin{enumerate}
\item \label{strongdeffirst} for any element $i,j\in I$ such that $i\neq j$, we have $r_i\neq r_j$;
\item  for any element $i\in I$ and any pair of permutation $\sigma \in\groupset[r_i]$, there exists an element $j\in I$, such that:
\begin{enumerate}
\item \label{strongdefsecond} $\actiongraphlong{\sigma}{r_i}=r_j$.
\item \label{strongdefthird}$\myfrac{k_i}{\aut{L_i}} = \myfrac{k_j}{\aut{L_j}}$,

where:
\begin{enumerate}
\item $L_i$ is the left hand side of the rule $r_i$,
\item $L_j$ is the left hand side of the rule $r_j$,
\item and for any site graph $\aut{E}$ denotes the number of automorphisms in the site graph $E$.
\end{enumerate}
\end{enumerate}
\end{enumerate}
\end{definition}
According to Def.~\ref{strongdef}, strongly symetric models are those in which
(constraint \ref{strongdeffirst}) no rule can occur twice (which does not prevent from having several distinct isomorphic rules), (constraint \ref{strongdefsecond}) the image of a rule by a pair of transformations  is always a rule and (constraint \ref{strongdefthird}) the corrected rates of a rule and its image is the same.


Now we define the equivalence relations between models, we allow the replacement of a rule by an isomorphic one, the merging of two isomorphic rules, or the splitting of a rule into two ones.
\begin{definition}[model equivalence]
\label{defn:modelequivalence}
We define the equivalence relation $\equivmodel$ over models as the least equivalence relation such that:
\begin{enumerate}
\item \label{defn:modelequivalence:reindex}$(r_i,k_i)_{i\in I} \equivmodel (r_{\sigma(j)},k_{\sigma(j)})_{j\in J}$
for any one to one function  $\sigma$ between $J$ and $I$;
\item \label{defn:modelequivalence:iso}$(r_i,k_i)_{i\in I} \equivmodel (s_i,k_i)_{i\in I}$ whenever $r_i\iso s_i$ for any element $i$ in the set $I$;
\item \label{defn:modelequivalence:merge}$(r_i,k_i)_{i\in I} \equivmodel (r_i,k'_i)_{i\in I\setminus\{i_1\}}$ with
\begin{equation*}
k'_{i} = \begin{cases}
k_{i_0}+k_{i_1} & \text{whenever } i=i_0 \cr
k_{i} & \text{otherwise};
\end{cases}
\end{equation*}
for any distinct elements $i_0,i_1$ in the set $I$, such that $r_{i_0} = r_{i_1}$.
\end{enumerate}
\end{definition}
Intuitively, in Def.~\ref{defn:modelequivalence}, the constraint \ref{defn:modelequivalence:reindex} allows the re-indexing of rules; the constraint \ref{defn:modelequivalence:iso} allows the replacement of a rule by an isomorphic one; the constraint \ref{defn:modelequivalence:merge} allows, in the direct way,  the merging of identical (or isomorphic) rules into a single one while summing their rates;
the constraint \ref{defn:modelequivalence:merge} allows, in the other way,
the splitting of a rule into several (isomorphic) ones while distributing its rate among the new ones.


Now we can define a more general notion of symetric models.
\begin{definition}[symetric model]
\label{symetricmodels}
A model is said to be symetric with respect to a valid set of transformations $\groupset[]$ over site graphs if and only if  it is $\equivmodel$-equivalent to a model that is strongly symetric with respect to the set of transformations  $\groupset[]$.
\end{definition}

Def.~\ref{symetricmodels} does not provide an effective decision procedure to decide wether or not a model is symetric with respect to a set of transformations.

Now, we give a direct characterisation  of symetric models.
\begin{prop}\label{prop:sym:model:efficient}
Let $M\bydef(r_i,k_i)_{i\in I}$ be a model and $\groupset$ be a valid set of transformations over site graphs.


Then, the following assertions are equivalent:
\begin{enumerate}
\item the model $M$ is symetric with respect to the set of transformations $\groupset$;
\item for two rules $r'\;:\;L'  \actionmap R'$ and $r''\;:\;L'' \actionmap R''$ such that
$r' \groupequiv r''$, the following equation is satisfied:
\begin{equation*}
\sum_{\substack{i\in I\suchthat\\ r_i \iso r' }} \myfrac{\symrules{r'}{\cdot}k_i}{\aut{L'}}
=
\sum_{\substack{j\in I\suchthat\\ r_{j}\iso r''}}
\myfrac{\symrules{r''}{\cdot}k_j}{\aut{L''}},\end{equation*}

where:
\begin{enumerate}
\item  for any rule $r$, the value $\symrules{r}$ denotes the number of automorphisms of the rule $r$ (that is say the number of pairs of automorphisms $(h_L,h_R)$ such that the triple $(r,h_L,h_R)$ is a refinement of the rule $r$);
\item  and, for any site graph $E$, the value $\aut{E}$ denotes the number of automorphisms of the site graph $E$,
\end{enumerate}
\end{enumerate}
\end{prop}



The checking whether, or not, a model is symetric with respect to a given (valid) set of transformations between site graph can be done in two steps. Firstly,
we gather rules  into $\iso$-equivalence classes.
Then, we scan over the $\iso$-equivalence classes of rules of the model in the following way.
We pick an $\iso$-equivalence class of rules in the model among the ones that we have not already dealt with. We pick an arbitrary  rule in that $\iso$-equivalence class and we compute the image of this rule by each pair of transformations that can be applied to this rule. For each so-obtained image, we check whether the condition about the rates of the $\iso$-equivalence classes of the initial rules and its image is satisfied. If it is satisfied for each image,  we mark the isomorphic class of each image as dealt with, and we keep on iterating, otherwise we have proved that the model is not symetric. If we can deal with each rule without failing a condition over the rates of $\iso$-equivalence classes of rules, then we have proved that the model is symetric.


Notice, that in Prop.~\ref{prop:sym:model:efficient}, thanks to Prop.~\ref{countisorule}, we could have multiply the rate of each rule $r$ by the number $\card([r]_\iso\cap [r]_{\groupequiv})$ of the rules which are both symetric and isomorphic to this rule, instead of multiplying by the number of automorphisms of this rule.


\section{Permutations of sites in site graphs}

Before giving the main properties about the semantic of symetric models, we formalise further the notion of permutions of sites that we have used in our running example.
 In particular, in our running examples, we have only swapped pairs of property sites, and we have wisely avoided permuting  pairs of binding sites.
In this section, we propose to instantiate the algebraic framework that we have introduced  so as to model permutations of sites in general.

In this section, we disallow the use of  binding types in site graphs.
We make this assumption because whenever an embedding maps a site with a binding type to a site that is bound to another site,
it is quite tricky to restrict a permutation of sites that can be applied to the image of this embedding, into a permutation of sites that can be applied to the domain of this embedding, while ensuring the group structure of the sets of permutations and the distributivity of the restriction of the permutations of sites over the product between these permutations ({\eg}see Def.~\ref{defn:symetriesdistributeovercomposition}).



\subsection{Formalisation}


We start with some examples of permutations of the sites of a site graph.

\begin{figure}[t]
\begin{center}
\begin{minipage}{0.6\linewidth}
\xymatrix@C=8mm@R=4mm{%
& \incgraphics[0.4\linewidth]{generated_pictures/sym_4_18bis_top.pdf}\ar@2@/_/@{~>}_{\sigma_1}[dl]\ar@2@/_/@{~>}_{\sigma_2\circ \sigma_1}[dr] & \\
\incgraphics[0.4\linewidth]{generated_pictures/sym_4_18bis_left.pdf}\ar@2@/_/@{~>}_{\sigma^{-1}_1}[ur]\ar@2@/^/@{~>}^{\sigma_2}[rr] & & \incgraphics[0.4\linewidth]{generated_pictures/sym_4_18bis_right.pdf}\ar@2@/^/@{~>}^{\sigma^{-1}_2}[ll]
               \ar@2@/_/@{~>}_{\sigma^{-1}_1\circ\sigma^{-1}_2}[ul]\\}
\end{minipage}
\end{center}
\caption{Examples of permutations of the sites of an agent.
The permutation $\sigma_1$ swaps the states of the site $x$ and the site $z$ in the agent $1$. The permutation $\sigma_2$ swaps the states of the site $x$ and the site $y$ in the agent $1$. }
\label{fig:exampleofpermutations}
\end{figure}

\begin{example}
\label{exampleofpermutations}
In Fig.~\ref{fig:exampleofpermutations}, we consider an agent and some permutations of the state of its sites. More precisely, We consider two kinds of agents $A$ and $B$, and six site identifiers $u$, $v$, $w$, $x$, $y$, and $z$. We assume that agents of type $A$ have the three following binding sites: $x$, $y$ and $z$, and that agents of type $B$ have the three following binding sites $u$, $v$, and $w$. We assume that agents have no property site. The agent type $B$ will be used later in Exa.~\ref{example:permutations:embedding}.

More formally, the signature of our model is defined  by:
\begin{itemize}
\item $\agentname=\{A,B\}$;
\item $\sitename=\{u,v,w,x,y,z\}$;
\item $\statename=\emptyset$;
\item $\linksite(A)=\{x,y,z\}$;
\item $\linksite(B)=\{u,v,w\}$;
\item $\statesite(A)=\emptyset$;
\item and $\statesite(B)=\emptyset$.
\end{itemize}

We consider an agent of type $A$ with the site $x$ bound (without any further information about to which site this site is bound to), the site $y$ free, and with no information about the binding state of the site $z$.   This agent is denoted by the following expression:
\begin{equation*}
\text{\agent{A$_1$}{\site{x}{}{\bound{}}\sitesep\site{y}{}{}\sitesep\site{z}{}{\boundornot{}}}}.
\end{equation*}

We apply a first permutation, $\sigma_1$, which consists in swapping the binding state of the sites $x$ and $z$. Thus, we get the following agent:
\begin{equation*}
\text{\agent{A$_1$}{\site{x}{}{\boundornot{}}\sitesep\site{y}{}{}\sitesep\site{z}{}{\bound{}}}},
\end{equation*}
where the binding state of the site $x$ is unknown, the site $y$ is free, and the site $z$ is bound (without any information about the about to which site this site is bound to).

Then we apply another permutation, $\sigma_2$, which consists in by swapping the binding state of the sites $x$ and $y$. Thus, we get the following agent
\begin{equation*}
\text{\agent{A$_1$}{\site{x}{}{}\sitesep\site{y}{}{\boundornot{}}\sitesep\site{z}{}{\bound{}}}},
\end{equation*}
 where the site $x$ is free, the binding state of the site $y$ is unknown, and the site $z$ is bound (without any information about to which site this site is bound to).
\end{example}




\begin{definition}[permutations among the sites of a site graph]
Let $G$ be a site graph.
We call a permutation of the sites of the site graph $G$, any family $(f_n)_{n\in\agents[G]}$  of one to one functions, indexed over the agents of the site graph $G$,   such that, for any agent $n\in\agents[G]$ of the site graph $G$, $f_n$ is a one to one function over the set $\bothsite(\type[G](n))$ that preserves the set $\linksite(\type[G](n))$  of the binding sites\footnote{Since, $\{\linksite(\type[G](n)),\statesite(\type[G](n))\}$ forms a partition of the set $\bothsite(\type[G](n))$ and $f_n$ is one to one, this is equivalent to say that $f_n$ preserves the set $\statesite(\type[G](n))$ of the property sites of the agents of type $\type[G](n)$.}Â  of the agents of type $\type[G](n)$ (that is to say that for any site identified $i\in\sites$, if $i\in\linksite(\type[G](n))$, then $f_n(i)\in\linksite(\type[G](n))$).

The set of all the permutations of the sites of the site graph $G$ is denoted by $\symsymbol[G]$.
\end{definition}

In a permutation $(f_n)_{n\in\agents[G]}\in\symsymbol[G]$ of the sites of a given graph $G$, the one to one function  $f_n$ denotes the permutation to be applied to the sites of the agent $n$ in the site graph $G$. Such a permutation is applied  by replacing each site $i$ by the site $f_n(i)$,  so that the site $f_n(i)$ of the agent $n$, takes the former state of the site $i$ in the agent $n$. This is formalised in the following definition.



\begin{definition}[action of a permutation of sites on a site graph]
\label{def:action_permutation}
Let $G$ be a site graph.
Let $(f_n)_{n\in\agents[G]}\in\symsymbol[\graphsymb]$ be a permutation of the sites of the site graph $G$.

Then, the image  $(f_n)_{n\in\agents[G]}\cdot \graphsymb$ of the site graph $\graphsymb$ by the  permutation $(f_n)_{n\in\agents[G]}$ of the sites of the site graph $\graphsymb$, is given by the site graph $H$ that is defined as follows:
\begin{enumerate}
\item $\agents[H]=\agents[G]$;
\item $\type[H]=\type[G]$;
\item $\sites[H]=\{(n,f_n(i))\;|\;(n,i)\in\sites[G]\}$;
\item $\links[H]=\{(p(s),p(s'))\;|\;(s,s')\in\links[G]\}$

where, for any $s\in\sites[G]\cup\{\free,\bound{}\}$,
\begin{equation*}
p(s) \bydef \begin{cases}\begin{array}{cl}
(n,f_n(i)) & \text{if } s\in\sites[G] \text{ and } s=(n,i);\cr
s  & \text{if }s=\free \text{ or } s=\bound{};\end{array}
\end{cases}
\end{equation*}
\item $\props[H](n,i) = \props[G](n,f_n^{-1}(i))$.
\end{enumerate}
\end{definition}
In Def.~\ref{def:action_permutation}, we notice that each site $(n,i)$ that occurs in $\sites[\graphsymb]$ and in $\links[\graphsymb]$ is replaced by the site $(n,f_n(i))$. We deal with the internal states in another way: instead of replacing each site $(n,i)$ by the site $(n,f_n(i))$, we associate each site $(n,i)$ with the previous internal state of the site $(n,f^{-1}(i))$, so that, after the permutation, the site $(n,f_n(i))$ is associated with previous the internal state of the site $(n,i)$.

\begin{example}
We consider the same signature, the same site graphs, and the same permutations of sites as Exa.~\ref{exampleofpermutations} ({\eg}see Fig.~\ref{fig:exampleofpermutations}).

The agent that is denoted by the following expression:
\begin{equation*}
\text{\agent{A$_1$}{\site{x}{}{\bound{}}\sitesep\site{y}{}{}\sitesep\site{z}{}{\boundornot{}}}},
\end{equation*}
is described by the site graph $\graphsymb$ that is defined by:
\begin{itemize}
\item $\agents[G]=\{1\}$;
\item $\type[G]=[1 \mapsto \agent{A}{}]$;
\item $\sites[G]=\{(1,\text{\site{x}{}{}}),(1,\text{\site{y}{}{}}),(1,\text{\site{z}{}{}})\}$;
\item $\links[G]=\Delta(\{((1,\text{\site{x}{}{}}),\bound{}),((1,\text{\site{y}{}{}}),\free)\})$;
\item $\props[G]=[(1,\text{\site{x}{}{}})\mapsto \emptyset, (1,\text{\site{y}{}{}}) \mapsto \emptyset, (1,\text{\site{z}{}{}}) \mapsto \emptyset]$.
\end{itemize}

Now we give the encoding of the permutations of sites $\sigma_1$.
We denote by $(f_n)_{n\in\{1\}}$ the permutation of sites $\sigma_1$.
This permutation swaps the sites $x$ and $z$. Thus, we have:
\begin{equation*}
f_1 = [x \mapsto z,y\mapsto y,z\mapsto x].
\end{equation*}

Let us apply the permutation of sites $\sigma_1$ to the site graph $G$.
%Let us denote by $H$ the image of $G$ by the permutation of sites $\sigma_1$.
By Def.~\ref{def:action_permutation}, we have:
\begin{itemize}
\item $\agents[\actiongraphlong{\sigma_1}{G}]=\agents[G]$;
\item $\type[\actiongraphlong{\sigma_1}{G}]=\type[G]$;
\item $\sites[\actiongraphlong{\sigma_1}{G}]=\{(n,f_n(i))\;|\;(n,i)\in\sites[G]\}$;
\item $\links[\actiongraphlong{\sigma_1}{G}]=\{(p(s),(s'))\;|\;(s,s')\in\links[G]\}$

where, for any $s\in\sites[G]\cup\{\free,\bound{}\}$,
\begin{equation*}
p(s) \bydef \begin{cases}\begin{array}{cl}
(n,f_n(i)) & \text{if } s\in\sites[G] \text{ and } s=(n,i);\cr
 s & \text{if }s\in\{\free;\bound{}\}.
 \end{array}\end{cases}
\end{equation*}
\item $\props[\actiongraphlong{\sigma_1}{G}] = [(n,i) \mapsto \props[G](n,f_n^{-1}(i))]$.
\end{itemize}
Thus, we have:
\begin{itemize}
\item $\agents[\actiongraphlong{\sigma_1}{G}]=\{1\}$;
\item $\type[\actiongraphlong{\sigma_1}{G}]=[1 \mapsto \agent{A}{}]$;
\item $\sites[\actiongraphlong{\sigma_1}{G}]=\{(1,f_1(\text{\site{x}{}{}})),(1,f_1(\text{\site{y}{}{}})),(1,f_1(\text{\site{z}{}{}}))\}$;
\item $\links[\actiongraphlong{\sigma_1}{G}]=\Delta(\{((1,f_1(\text{\site{x}{}{}})),\bound{}),((1,f_1(\text{\site{y}{}{}})),\free)\})$;
\item $\props[\actiongraphlong{\sigma_1}{G}]=\left[\begin{array}{l}(1,\text{\site{x}{}{}})\mapsto \props[G]((1,f_1^{-1}(\text{\site{x}{}{}})),\cr
                                                     (1,\text{\site{y}{}{}})\mapsto \props[G]((1,f_1^{-1}(\text{\site{y}{}{}})),\cr
                                                     (1,\text{\site{z}{}{}})\mapsto \props[G]((1,f_1^{-1}(\text{\site{z}{}{}}))\end{array}\right]$.
\end{itemize}
And:
\begin{itemize}
\item $\agents[\actiongraphlong{\sigma_1}{G}]=\{1\}$;
\item $\type[\actiongraphlong{\sigma_1}{G}]=[1 \mapsto \agent{A}{}]$;
\item $\sites[\actiongraphlong{\sigma_1}{G}]=\{(1,\text{\site{z}{}{}}),(1,\text{\site{y}{}{}}),(1,\text{\site{x}{}{}})\}$;
\item $\links[\actiongraphlong{\sigma_1}{G}]=\Delta(\{((1,\text{\site{z}{}{}}),\bound{}),((1,\text{\site{y}{}{}}),\free)\})$;
\item $\props[\actiongraphlong{\sigma_1}{G}]=[(1,\text{\site{x}{}{}})\mapsto \emptyset,
                                                     (1,\text{\site{y}{}{}})\mapsto \emptyset,
                                                     (1,\text{\site{z}{}{}})\mapsto \emptyset]$.
\end{itemize}

We can check that the site graph $\actiongraphlong{\sigma_1}{G}$ denotes the following agent:
\begin{equation*}
\text{\agent{A$_1$}{\site{x}{}{\boundornot{}}\sitesep\site{y}{}{}\sitesep\site{z}{}{\bound{}}}},
\end{equation*}

The permutation $\sigma_2$ of sites swaps the sites $x$ and $y$. We denote by $(f'_n)_{n\in\{1\}}$ the permutation of sites $\sigma_2$.

We have:
\begin{equation*}
f'_1 = [x \mapsto y,y\mapsto x,z\mapsto z].
\end{equation*}
\end{example}


Permutations of sites can be composed,  as formalised in the following definition:
\begin{definition}[composition]
\label{def:product}
Let $\graphsymb$ be a site graph.
Let $(f_n)_{n\in\agents[G]}$ and $(f'_n)_{n\in\agents[G]}$ be two permutations of sites in $\symsymbol[\graphsymb]$.  We define the product of the permutation of sites $(f_n)_{n\in\agents[G]}$ and the permutation of sites $(f'_n)_{n\in\agents[G]}$ as the family $(f_nf'_n)_{n\in\agents[G]}$ of one to one functions.

The product between $(f_n)_{n\in\agents[G]}$  and $(f'_n)_{n\in\agents[G]}$ belongs to the set $\symsymbol[\graphsymb]$, we denote it by
 $(f_n)_{n\in\agents[G]}\circ_{\graphsymb}(f'_n)_{n\in\agents[G]}$.
\end{definition}

This way, the composition of permutations of sites is obtained by composing the one to one functions component-wise.

\begin{example}
We consider the same signature, the same site graphs, and the same permutations of sites  as Exa.~\ref{exampleofpermutations} ({\eg}see Fig.~\ref{fig:exampleofpermutations}).

We compute the composition of the permutations  of sites $\sigma_2$ and $\sigma_1$, and we check that we get the expected result.

We denote by $(f_n)_{n\in\{1\}}$ the permutation $\sigma_1$, by $(f'_n)_{n\in\{1\}}$ the permutation $\sigma_2$, and by $(f''_n)_{n\in\{1\}}$ the product $\sigma_2\circ_G \sigma_1$.

By Def.~\ref{def:product}, the one to one function  $f''_1$ is defined by $f'_1\circ f_1$. Thus,
\begin{equation*}
f''_1 = [x\mapsto y,y\mapsto x,z\mapsto z][x\mapsto z,y\mapsto y,z\mapsto x].
\end{equation*}
It follows that:
\begin{equation*}
f''_1 = [x\mapsto z,y\mapsto x,z\mapsto y].
\end{equation*}

Thus the permutation of sites $\sigma_2\circ\sigma_1$  substitutes the site identifier $x$ with the site identifier $z$, the site identifier $y$ with the site identifier $x$, and the site identifier $z$ with the site identifier $y$ (so that the new state of the site $z$ is the former state of the site $x$, the new state of the site $x$ is the former state of the site $y$, and the new state of the site $y$ is the former state of the site $z$).
\end{example}




For any site graph $G$,  the permutations of sites that can be applied to the site graph $G$ form a group for composition, as established in the following proposition.
\begin{prop}
\label{prop:group:permutation:sites}
Let $G$ be a site graph. The set $\symsymbol[G]$ forms a group for the composition  $\circ_{\graphsymb}$.
More precisely,
\begin{enumerate}
\item the identity element is the family $(\textit{Id}_{\bothsite(\type[\graphsymb](n))})_{n\in\agents[G]}$ made, for each agent $n$ of the site graph $G$,  of the identity function over the set
$\bothsite(\type[\graphsymb](n))$;
\item \label{prop:group:permutation:sites:inverse}
the inverse of an element $(f_n)_{n\in\agents[G]}$ is the family $(f^{-1}_n)_{n\in\agents[G]}$ made, for each agent $n$ of the site graph $G$, of the inverse of the function $f_n$.
\end{enumerate}
\end{prop}

\begin{example}
We consider the same signature, the same site graphs, and the same permutations of sites  as Exa.~\ref{exampleofpermutations} ({\eg}see Fig.~\ref{fig:exampleofpermutations}).



Now we compute the inverse of $\sigma_1$.
We denote by $(f_n)_{n\in\{1\}}$ the permutation $\sigma_1$ and by $(f'''_n)_{n\in\{1\}}$ the permutation $\sigma_1^{-1}$.

By applying Prop.~\ref{prop:group:permutation:sites}.(\ref{prop:group:permutation:sites:inverse}), we get that:
\begin{equation*}
f'''_1 = (f_1{})^{-1}.
\end{equation*}
It follows that:
\begin{equation*}
f'''_1= [x \mapsto z, y\mapsto y, z\mapsto x].
\end{equation*}
That is to say that the permutation of sites $\sigma_1$ is its own inverse.  The same way, the permutation of sites  $\sigma_2$ is in own inverse.


Now we compute the permutation of sites $(\sigma_2 \circ \sigma_1)^{-1}$ in two different ways (as the inverse of the permutation of sites $\sigma_2 \circ_{\graphsymb} \sigma_1$, and as the combination of the permutations of sites $\sigma_1^{-1}$ and $\sigma_2^{-1}$ , and check that we get the same result.

Let us denote by $(f'_n)_{n\in\{1\}}$ the permutation of sites $\sigma_2$ and
by $(f''''_n)_{n\in\{1\}}$ the permutation of sites $(\sigma_2 \circ_{\graphsymb} \sigma_1)^{-1}$.

As the inverse of the permutation of sites $(\sigma_2 \circ_{\graphsymb} \sigma_1)$, we get, by applying Prop.~\ref{prop:group:permutation:sites}.(\ref{prop:group:permutation:sites:inverse}), that:
\begin{equation*}
f_1'''' = (f''_1)^{-1}.
\end{equation*}
It follows that:
\begin{equation*}
f_1'''' = [x\mapsto z, y\mapsto x, z\mapsto y]^{-1}.
\end{equation*}
Thus,
\begin{equation*}
f_1'''' = [x\mapsto y, y\mapsto z, z\mapsto x].
\end{equation*}
That is to say that the permutation of sites $(\sigma_2\circ_{\graphsymb}\sigma_1)^{-1}$ consists in substituting the site identifier $x$ with the site identifier $y$, the site identifier $y$ with the site identifier $z$, and the site identifier $z$ with the site identifier $x$.

As the composition of the permutation of sites $\sigma^{-1}_1$ and the permutation of sites $\sigma^{-1}_2$, we get by Def.~\ref{def:product} that:
\begin{equation*}
f_1''''= (f_1)(f'_1).
\end{equation*}
It follows that:
\begin{equation*}
f_1''''= [x\mapsto z,y\mapsto y,z\mapsto x][x\mapsto y,y\mapsto x,z\mapsto z].
\end{equation*}
Thus:
\begin{equation*}
f_1'''' = [x\mapsto y,y\mapsto z,z\mapsto x].
\end{equation*}

Thus, the two computations are consistent with each other.
\end{example}

\begin{figure*}[t]
\hfill
\incgraphics[0.28\linewidth]{generated_pictures/sym_4_19bis_left.pdf}
\begin{minipage}{0.20\linewidth}
\xymatrix@C=2cm@R=2mm{%
\\\\\\%\\%\\
\ar@2@{~>}^{\sigma_3}[r] & \\\\\\\\
\ar@2@{~>}^{\sigma_3}[r] &  \\\\\\\\\\
\ar@2@{~>}^{\actionembactionlong{\sigma_3}{h}}[r] & \\\\\\\\%\\%\\
}
\end{minipage}
\incgraphics[0.28\linewidth]{generated_pictures/sym_4_19bis_right.pdf}
\hfill\mbox{}
\caption{Restriction of a permutation of sites to the domain of an embedding.}
\label{fig:propperm}
\end{figure*}

Now we define the restriction of a permutation of sites that can be applied to the image of an embedding, into a permutation of sites that can be applied to the domain of this embedding.
\begin{definition}[permutation propagation]
\label{permutation propagation}
Let $h$ be an embedding between two site graphs $G$ and $H$.
Let $\sigma_H\in\symsymbol[H]$ be a permutation of sites that can be applied to the site graph $H$.

We define $\actionembactionlong{\sigma_H}{h}$ as the permutation of sites $(f_{h_n})_{n\in\agents[G]}$, which can be applied to the site graph $G$.
\end{definition}

We are left to define the action of a permutation of sites over an embedding.
Since permutations of sites preserve the set of agents of the site graphs to which they are applied (only the set of sites and the states of these sites may change),
we can define the image of an embedding between two site graphs, as the embedding between the image of these two site graphs, that is induced by the same function over agents.


\begin{prop}
Let $h$ be an embedding between two site graphs $G$ and $H$.
Let $\sigma_H\in\symsymbol[H]$ be a permutation of the sites
of the site graph $H$.

The function between $\agents[G]$ and $\agents[H]$ that induces the embedding $h$, also induces an embedding between the site graph $\actiongraphlong{(\actionembactionlong{\sigma_H}{h})}{G}$ and the site graph $\actiongraphlong{\sigma_H}{H}$.
\end{prop}


\begin{definition}[action of a permutation over an embedding]
\label{actionemb}
Let $h$ be an embedding between two site graphs $G$ and $H$.
Let $\sigma_H\in\symsymbol[{\type[H]}]$ be a permutation of the sites
of the graph $H$.

We define $\actionembemblong{\sigma_H}{h}$ as the embedding between the site graph $\actiongraphlong{(\actionembactionlong{\sigma_H}{h})}{G}$ and $\actiongraphlong{\sigma_H}{H}$ that is induced by the same function between $\agents[G]$ and the site graph $\agents[H]$ as $h$.
\end{definition}


Now we give more details about the example in Fig.~\ref{fig:propperm}.

\begin{example}
\label{example:permutations:embedding}We illustrate Defs.~\ref{permutation propagation} and \ref{actionemb} in Fig.~\ref{fig:propperm}. The signature is the same as in Ex.~\ref{exampleofpermutations}: there are two kinds of agents $A$ and $B$. The agents of type $A$ have three binding sites $x$, $y$ and $z$, while the agents of type $B$ have three binding sites $u$, $v$, $w$.

We consider an embedding $h$ between two site graphs $G$ and $H$, where:
\begin{enumerate}
\item the site graph $G$ is made of an agent $1$ of type $A$ in which the site $x$ is bound (with no further information), the site $y$ is free, and we have no information about the binding state of the site $z$.
\item the site graph $H$ is made of two agents: the agent $2$ of type $A$ and the agent $3$ of type $B$. The site $y$ of the agent $2$ and the site $v$ of the agent $3$ are free. There is a link between the site $x$ of the agent $2$ and the site $w$ of the agent $1$ and another link between the site $z$ of the agent $2$ and the site $u$ of the agent $3$.
\item the embedding $h$ maps the agent of the site graph $G$ to the agent $2$ of the site graph $H$.
\end{enumerate}
We consider the permutation of sites $\sigma_3\in\symsymbol[H]$ that is defined as $\sigma_3\bydef (f_n)_{n\in\{2,3\}}$ where:
\begin{itemize}
\item $f_2 = [x\mapsto z, y\mapsto y, z\mapsto x]$;
\item $f_3 = [u\mapsto v, v\mapsto u, w\mapsto w]$.
\end{itemize}
Thus the action of the permutation of sites  $\sigma_3$ on the site graph $G$ swaps the states of the sites $x$ and $z$ in agent $2$ and the states of the sites $u$ and $v$ in agent $3$. As a result the site $y$ of the agent $2$ and the site $u$ of the agent $3$ become free. The site $x$ of agent $2$ and the site $v$ of the agent $3$ are now bound together, as well as  the site $z$ of the agent $2$ and the site $w$ of the agent $3$.

The permutation of sites $\sigma_3$ can be restricted to the domain of the embedding $h$.
By Def.~\ref{actionemb}, the resulting permutation of sites $\actionembactionlong{\sigma_3}{h}$ is the permutation in $\symsymbol[G]$ that is defined by $\actionembactionlong{\sigma_3}{h}=(f'_1)$ where:
\begin{equation*}
f'_1 = f_{h{(1)}}.
\end{equation*}
It follows that:
\begin{equation*}
f'_1 = [x\mapsto z, y\mapsto y,z\mapsto x].
\end{equation*}
Thus, the permutation of sites $\actionembactionlong{\sigma_3}{h}$ swaps the states of the site $x$ and $z$ in the unique agent of the site graph $G$.
It follows that in the unique agent of the site graph $\actiongraphlong{(\actionembactionlong{\sigma_3}{h})}{G}$, the binding state of the site $x$ is not specified, the site $y$ is free, and the site $z$ is bound (with no further information). We can check that the embedding $\actionembemblong{\sigma_3}{h}$ embeds the site graph
$\actiongraphlong{(\actionembactionlong{\sigma_3}{h})}{G}$ into the site graph $\actiongraphlong{\sigma_3}{H}$.
\end{example}

\begin{prop}
The tuple $\symsymbol[]=((\symsymbol[G]),\ldot,\ldot',\ldot'')$ is a valid set of transformations  over site graphs (as defined in Defs.~\ref{defn:permutation} and \ref{def:validpermutation}).

Moreover each embedding is $\symsymbol[]$-compatible (as defined in Def.~\ref{def:compatible}).
\end{prop}

\newcommand{\Rxu}{$\agent{A$_1$}{$\sitefont{x}_u$}$}
\newcommand{\Rxp}{$\agent{A$_1$}{$\sitefont{x}_p$}$}
\newcommand{\Ryu}{$\agent{A$_1$}{$\sitefont{y}_u$}$}
\newcommand{\Ryp}{$\agent{A$_1$}{$\sitefont{y}_p$}$}
\newcommand{\Rpp}{$\agent{A$_1$}{$\sitefont{x}_p\sitesep\sitefont{y}_p$}$}

\newcommand{\Ax}[1]{$\agent{A$_{#1}$}{$\sitefont{x}$}$}
\newcommand{\Ay}[1]{$\agent{A$_{#1}$}{$\sitefont{y}$}$}
\newcommand{\AAxx}{$\agent{A$_1$}{$\sitefont{x}^{\agent{A$_2$}{}@x}$}\agentsep\agent{A$_2$}{$\sitefont{x}^{\agent{A$_1$}{}@x}$}$}
\newcommand{\AAyy}{$\agent{A$_1$}{$\sitefont{y}^{\agent{A$_2$}{}@y}$}\agentsep\agent{A$_2$}{$\sitefont{y}^{\agent{A$_1$}{}@y}$}$}
\newcommand{\AAxy}{$\agent{A$_1$}{$\sitefont{x}^{\agent{A$_2$}{}@y}$}\agentsep\agent{A$_2$}{$\sitefont{y}^{\agent{A$_1$}{}@x}$}$}
\newcommand{\AAyx}{$\agent{A$_1$}{$\sitefont{y}^{\agent{A$_2$}{}@x}$}\agentsep\agent{A$_2$}{$\sitefont{x}^{\agent{A$_1$}{}@y}$}$}
\begin{figure}[t]
\subfigure[$r_1$\;:\;\Ax{1}\agentsep\Ax{2}$\;\kapparule{}\;$\AAxx $\;@k_1$]
{\label{rulesym212}\incgraphics[\linewidth]{generated_pictures/sym_4_2_a.pdf}}

\subfigure[$r_2$\;:\;\Ay{1}\agentsep\Ay{2}$\;\kapparule{}\;$\AAyy $\;@k_2$]%
{\label{rulesym222}\incgraphics[\linewidth]{generated_pictures/sym_4_2_b.pdf}}

\subfigure[$r_3$\;:\;\Ax{1}\agentsep\Ay{1}$\;\kapparule{}\;$\AAxy $\;@k_3$]%
{\label{rulesym232}\incgraphics[\linewidth]{generated_pictures/sym_4_2_c.pdf}}

%\subfigure[$r'_3$\;:\;\Ay{1}\agentsep\Ax{1}$\;\kapparule{}\;$\AAyx $\;@k'_3$]%
%{\label{rulesym242}\incgraphics[\linewidth]{generated_pictures/sym_4_2_d.pdf}}
\caption{Under which conditions are the sites $x$ and $y$ equivalent in each occurrence of the protein \agentfont{A}{} ?}
\end{figure}


\subsection{Retour sur le cas d'étude}

Pour conclure ce chapitre, cette approche est appliquée sur le modèle jouet qui avait été introduit Sec.~\ref{sec:modele} page \pageref{sec:modele}.

\newcommand{\orbit}[4]{%
\xymatrix@C=0mm@R=20mm{%
& \begin{minipage}{#1}\incbox{#2}{#3}{generated_pictures/#4_id_id.pdf}\end{minipage}\ar@[green]@2@/_{1.5cm}/@{<~>}[dl]\ar@[red]@2@/^{1.5cm}/@{<~>}[dr]\ar@[brown]@2@/^{0.5cm}/@{<~>}[dd] & \cr
\begin{minipage}[b]{#1}\incbox{#2}{#3}{generated_pictures/#4_inv_id.pdf}\end{minipage}\ar@[red]@2@/_{1.5cm}/@{<~>}[dr]\ar@[brown]@2@/^{0.5cm}/@{<~>}[rr] & &
\begin{minipage}[t]{#1}\incbox{#2}{#3}{generated_pictures/#4_id_inv.pdf}\end{minipage}\ar@[green]@2@/^{1.5cm}/@{<~>}[dl] \cr
&\begin{minipage}{#1}\incbox{#2}{#3}{generated_pictures/#4_inv_inv.pdf}\end{minipage}}}

\newcommand{\orbitrules}[1]{\orbit{5cm}{23.6mm}{165.5mm}{sym_4_2_#1_a}}

\begin{figure*}
\subfigure[Les règles d'association sous forme d'orbite.]%
{\label{fig:orbit:asso}\orbitrules{asso}}


\subfigure[Les règles de dissociation sous forme d'orbite.]%
{\label{fig:orbit:disso}\orbitrules{diss}}

\caption{Quitte à permuter les sites \sitefont{x}{}{} et \sitefont{y}{}{} dans certaines occurrences de la protéine \agent{A}{}, les règles peuvent être regroupées en deux catégories. Les règles d'association sont représentées en Fig.~\ref{fig:orbit:asso}, alors que les règles de dissociation sont représentées en Fig.~\ref{fig:orbit:disso}. L'effet des permutations de sites est représenté par des doubles flèches ondulées. Les permutations triviales, qui consiste à ne rien changer ne sont pas représentées. La permutation des sites \sitefont{x}{}{} et \sitefont{y}{}{} dans l'occurrence gauche de la protéine est représentée en vert~; celle dans l'occurrence de droite est représentée en rouge~; la permutation simultannée des sites \sitefont{x} et \sitefont{y} dans les deux occurrences de la protéine \agentfont{A} est représentée en marron.}
\label{fig:rule:orbits}
\end{figure*}


\begin{figure*}[t]
\hfill\subfigure[Orbite des occurrences de monomère.]%
{\label{fig:orbit:mono}%
\begin{minipage}{0.4\linewidth}%
\hfill\xymatrix@C=20mm@R=20mm{\incbox{1cm}{1cm}{generated_pictures/sym_4_1_a.pdf}\ar@[orange]@2@/_{1.cm}/@{~>}[d]\cr\incbox{1cm}{1cm}{generated_pictures/sym_4_1_a_op.pdf}\ar@[orange]@2@/_{1.cm}/@{~>}[u]}\hfill\mbox{}\end{minipage}}
\hfill\subfigure[Orbite des occurrences de dimère.]%
{\label{fig:orbit:dimer}%
\begin{minipage}{0.59\linewidth}
\orbit{2cm}{23.6mm}{65.6mm}{sym_4_2_dimer_a}\end{minipage}}\hfill\mbox{}
\caption{Quitte à permuter les sites \sitefont{x} et \sitefont{y} dans les occurrences de la protéine \agentfont{A}, les complexes biochimiques se classent en deux catégories, les monomères (voir en Fig.~\ref{fig:orbit:mono}) et les dimères (voir en Fig.~\ref{fig:orbit:dimer}).
Pour les monomères, la seule transformation possible consiste à permuter les sites de l'unique instance de la protéine (ce qui est dessiné avec une double flèche ondulée orange). Ceci ne change par la conformation de la protéine puisque l'ordre des sites n'a pas d'importance dans le langage Kappa. Pour les dimères, le rÃ´le des sites peuvent être échangés dans l'occurrence gauche (ce qui est dessiné avec une double flèche ondulée verte), dans l'occurrence droite (rouge) ou dans les deux simultanément (noire). Quite à changer l'ordre des agents et des sites de liaisons, les deux représentations graphiques des dimères asymétriques sont équivalentes du point de vue de la sémantique du langage Kappa.}
\label{fig:orbit:complex}
\end{figure*}


Dans ce modèle, quite à intervertir les sites \site{x}{}{} et \site{y}{}{} dans une ou plusieurs occurrences de la protéine \agent{A}{}, les règles se répartissent  en deux catégories~:
les règles d'association et les règles de dissociation. Ces deux catégories sont dessinées en Fig.~\ref{fig:rule:orbits}, ainsi que les permutations de sites qui permettent de passer d'une règle à une autre au sein de chaque catégorie.
%Les doubles flèches ondulées vertes représentent la permutation des sites \site{x}{}{} et \site{y}{}{} dans l'occurrence gauche de la protéine \agent{A}{}~; les doubles flèches ondulées rouges représentent la permutation des sites \site{x}{}{} et \site{y}{}{} dans l'occurrence droite de la protéine \agent{A}{} et  les doubles flèches ondulées noires représentent la permutation des sites \site{x}{}{} et \site{y}{}{} dans les deux occurrences de la protéine \agent{A}{} à la fois.
Dans chacune des ces deux catégories, deux règles
correspondent à la même, quite à échanger le rÃ´le des deux occurrences de la protéine \agent{A}{}. Il s'agit des deux règles d'association  asymétrique pour lier le site \site{x}{}{} d'une des occurrences de la protéine \agent{A}{} au site \site{y}{}{} de l'autre occurrence de la protéine \agent{A}{} (les deux règles sur la ligne du milieu en Fig.~\ref{fig:orbit:asso}) et des deux règles de dissociation asymétriques
(les deux règles sur la ligne du milieu en Fig.~\ref{fig:orbit:disso}). Ainsi, pour que les sites \site{x}{}{} et \site{y}{}{} aient un rÃ´le équivalent dans le modèle, il suffit que
les constantes corrigées des quatre règles d'association soient égales et que celles des quatre règles de dissociation le soient également. Ainsi, en tenant compte, du coefficient de correction des constantes de réaction  et des répétitions des règles au sein de chaque catégorie de règles, cela donne les contraintes suivantes~:
\begin{equation*}
\myfrac{\kxx}{2\cdot{1}}=\myfrac{\kyy}{2\cdot{1}}=\myfrac{\kxy}{2\cdot{2}}
\end{equation*}
et
\begin{equation*}
\myfrac{\kxx}{2\cdot{1}}=\myfrac{\kyy}{2\cdot{1}}=\myfrac{\kxy}{1\cdot{2}}.
\end{equation*}
Dans ces fractions, le premier facteur des dénominateurs représente la correction des constantes de réaction  alors que le deuxième facteur correspond au nombre de formes de la règle (modulo permutation des agents) qui apparaissent dans les catégories de règles.

Il s'en suit les contraintes suivantes:
\begin{equation*}
\begin{cases}
\kxx=kyy \cr
\kxy=2\kxx \cr
\kdxx=\kdyy \cr
\kdxx=\kdxy\cr
\end{cases}
\end{equation*}

Sous ces conditions, les sites \site{x}{}{} et \site{y}{}{} sont équivalents, ce qui induit une bisimulation dans les deux sens sur à la fois sur le systèmes stochastique sous-jacent et le système différentiel sous-jacent.

Cette bisimulation permet de réduire ces systèmes en oubliant la différence entre les sites \site{x}{}{} et \site{y}{}{}, et ce quel que soit la distribution initiale des états (dans le cadre stochastique) ou les concentrations initiales (dans le cadre différentiel).

Par ailleurs, cette bisimulation permet de caractériser des sous-espaces de distributions d'états (dans le cadre stochastique) et des sous-espaces de concentrations (dans le cas différentiel) stables.

L'examen des différents complexes et de leur relation vis à vis des permutations de sites équivalent permet de trouver un sous-espace stable de concentrations. Quitte à permuter l'état des sites \site{x}{}{} et \site{y}{}{} dans une ou plusieurs instances de la protéine \agent{A}{}, l'ensemble de tous les complexes biochimiques du modèle jouet se classe en deux catégories~: les monomères et les dimères. Celles-ci sont ressinées  en Fig.~\ref{fig:orbit:complex} sous la forme de deux orbites.
Les permutations qui permettent de passer d'un complexe biochimique à un autre au sein de chaque catégorie sont représentées par des doubles flèches ondulées.
PlutÃ´t que d'intervertir l'état des sites, l'action de ses permutations a été représenté en échangeant, de manière équivalente, les sites.
%Les permutations qui consistent à intervertir les sites \site{x}{}{} et \site{y}{}{} dans l'unique occurrence de la protéine \agent{A}{} d'un monomère sont représentées en orange.
%Les permutations qui consistent à intervertir les sites \site{x}{}{} et \site{y}{}{} dans l'occurrence de gauche de la protéine \agent{A}{} dans un dimère sont représentées en vert, celles pour l'occurrence de gauche en rouge, et enfin les permutations qui intervertissent simultanément les sites \site{x}{}{} et \site{y}{}{} dans les deux occurrences de la protéine \agent{A}{} dans un dimère sont représentées en marron.
Étant donné que l'ordre des sites dans une occurrence de protéine n'a pas de signification particulière en Kappa, il existe une seule forme de monomère. Leur concentration n'est  donc pas contrainte dans le sous-espace stable de concentrations qui découle de l'équivalence entre les sites \site{x}{}{} et \site{y}{}{} dans les occurrences de la protéine \agent{A}{}. Il existe en revanche trois formes de dimères~: les dimères symétriques avec une liaison entre deux sites \site{x}{}{}~; les dimères symétriques avec une liaison entre deux sites \site{y}{}{} et les dimères asymétriques avec une liaison entre un site \site{x}{}{} d'une occurrence de la protéine \agent{A}{} et le site \site{y}{}{} d'une autre occurrence de la protéine \agent{A}{}.
Quitte à échanger le rÃ´le des deux occurrences des protéines \agent{A}{}, cette dernière forme de dimère apparaît deux fois. En conséquence, le sous-espace stable de concentrations qui découle de l'équivalence entre les sites \site{x}{}{} et \site{y}{}{} doit satisfaire les contraintes suivantes~: les dimères asymétriques doivent constituer la moitié de la concentration totale en dimère et chacune des deux formes de dimère symétrique doit constituer un quart de la concentration totale en dimère. Il s'agit des mêmes proportions que pour le jeu de "pile" ou "face".



Dans le cadre stochastique, il faut regarder, pour déduire  un sous-espace de distributions stable, les catégories d'états du système. Quite à permuter l'état des sites \site{x}{}{} et \site{y}{}{}, dans une ou plusieurs occurrences de la protéine \agent{A}{}, deux états sont équivalents s'ils contiennent le même nombre d'occurrence de monomère et le même nombre d'occurrence de dimère.

Reprenant la notation $\state{i,j,k,l}$ pour désigner un état avec $i$ occurrences de monomère, $j$ occurrences du dimère formé d'une liaison entre deux sites \site{x}{}{}, $k$ occurrences du dimère formé d'une liaison entre deux sites \site{y}{}{} et $l$ occurrences du dimère formé d'une liaison entre le site \site{x}{}{} d'une occurrence de la protéine \agent{A}{} et le site \site{y}{}{} d'une autre occurrence de la protéine \agent{A}{}, deux états $\state{i',j',k',l'}$ et
$\state{i'',j'',k'',l''}$ sont donc équivalents losque $i'=i''$ et $j'+k'+l'=j''+k''+l''$. Reste à calculer les rapports de proportions entre les probabilités de deux tels états dans le sous espace de distributions stable défini par l'équivalence entre les sites \site{x}{}{} et \site{y}{}{}.

%\findechapitre
%%% Local Variables:
%%% ispell-local-dictionary: "french"
%%% End:
